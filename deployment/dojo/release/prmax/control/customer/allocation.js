//>>built
define("control/customer/allocation",["dojo/_base/declare","ttl/BaseWidgetAMD","dojo/request","ttl/utilities2","dojo/_base/lang","dojo/topic","dojo/dom-class","dojo/dom-attr","ttl/store/JsonRest","dojo/store/Observable","dijit/Menu","dijit/MenuItem","ttl/grid/Grid","dojo/store/util/SimpleQueryEngine","dojo/store/Memory","control/customer/manual_allocate_amount"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _1("control.customer.allocation",null,{constructor:function(){this._allocation=null;this._load_allocation_call_back=_5.hitch(this,this._load_allocation_call);},_postCreate:function(){var _10=[{label:"Type",className:"dgrid-column-status-small",field:"typedescription"},{label:"Nbr",className:"dgrid-column-nbr-right",field:"invoicenbr"},{label:"Ref",className:"dgrid-column-status-small",field:"invoiceref"},{label:"Date",className:"dgrid-column-date",field:"invoicedate"},{label:"Value",className:"dgrid-column-money",field:"invoiceamount_display",formatter:_4.display_money},{label:"Unpaid",className:"dgrid-column-money",field:"unpaidamount_display",formatter:_4.display_money},{label:"Allocate",className:"dgrid-column-money",field:"allocated",formatter:_4.display_money},{label:" ",className:"dgrid-column-type-boolean",formatter:_4.format_row_ctrl}];this.alloc_grid=new _d({columns:_10,selectionMode:"single",store:this._allocation});this.alloc_grid_view.set("content",this.alloc_grid);this.alloc_grid.on(".dgrid-cell:click",_5.hitch(this,this.onCellClick));},load_allocation:function(_11,_12){this._customerid=_11;this._source=_12;_3.post("/allocation/customer_to_allocate",_4.make_params({data:{icustomerid:_11,source:this._source}})).then(this._load_allocation_call_back);},_load_allocation_call:function(_13){this._allocation=new _a(new _f());if(_13.length>0){for(var i=0;i<_13.length;i++){this._allocation.put(_13[i]);}}this.alloc_grid.set("store",this._allocation);},_AllocateInvoice:function(){this._allocted_row.allocated=this._allocted_row.unallocated/100;this._allocation.put(this._allocted_row);},_AllocateAmount:function(){this.alloc_manual.setValues(this,this._allocted_row.unallocated/100);},onCellClick:function(e){var _14=this.alloc_grid.cell(e);if(_14.column.id==7){this._allocted_row=_14.row.data;if(this.private_menu==null){this.private_menu=new _b();this.private_menu.addChild(new _c({label:"Allocate Invoice",onClick:_5.hitch(this,this._AllocateInvoice)}));this.private_menu.addChild(new _c({label:"Allocate Amount",onClick:_5.hitch(this,this._AllocateAmount)}));}this.private_menu._openMyself(e);}},_doallocation:function(){var _15=Math.abs(this.payment.get("value"));var _16=0;var _17=_e(function(_18){return true;})(this._allocation.data);for(var c=0;c<_17.length;c++){if(_17[c]==null){continue;}_16+=dojo.number.round(parseFloat(_17[c].allocated),2);}this.toallocate.set("value",dojo.number.round(_15-_16,2));},getAllocations:function(){var _19=[];var _1a=0;var _1b=_e(function(_1c){return true;})(this._allocation.data);for(var c=0;c<_1b.length;c++){if(_1b[c]==null){continue;}_19[_1a]={keyid:_1b[c].key,amount:_1b[c].allocated};_1a+=1;}return dojo.toJson(_19);}});});