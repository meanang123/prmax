//>>built
require({cache:{"url:control/customer/templates/financiallog.html":"<div>\r\n    <div  data-dojo-attach-point=\"borderControl\" data-dojo-type=\"dijit/layout/BorderContainer\" data-dojo-props='gutters:false,style:\"width:100%;height:100%;overflow:hidden;border:0;padding:0;margin:0\"' >\r\n        <div data-dojo-type=\"dijit/layout/ContentPane\" data-dojo-props='region:\"top\"' style=\"width:100%;height:45px;\">\r\n            <div style=\"height:44px;width:100%;overflow:hidden;padding:0px;margin:0px\">\r\n                <div style=\"float:left\" >\r\n                <p class=\"prmaxrowdisplaylarge\" >Balance Â£&nbsp;<span data-dojo-attach-point=\"balance_figure\">0.00</span></p>\r\n                </div>\r\n                <div style=\"float:right;padding-top:0px;padding-right:10px;margin:5px\" >\r\n                    <input class=\"prmaxbutton\" data-dojo-props='type:\"text\",name:\"filterdate\"' data-dojo-attach-point=\"filterdate\" data-dojo-type=\"dijit/form/DateTextBox\" >\r\n                    <label class=\"prmaxrowdisplay\">Unallocated</label><input data-dojo-props='\"class\":\"prmaxbutton\",type:\"checkbox\",name:\"unallocated\"' data-dojo-attach-point=\"unallocated\" data-dojo-type=\"dijit/form/CheckBox\" >\r\n                    <label class=\"prmaxrowdisplay\">Money Only</label><input data-dojo-props='\"class\":\"prmaxbutton\",type:\"checkbox\",name:\"moneyonly\",checked:\"true\"' data-dojo-attach-point=\"moneyonly\" data-dojo-type=\"dijit/form/CheckBox\" >\r\n                    <button type=\"button\" data-dojo-attach-event=\"onClick:_FilterBy\" data-dojo-type=\"dijit/form/Button\" label=\"Filter By\" ></button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n            <div data-dojo-attach-point=\"financialgrid\" data-dojo-type=\"dijit/layout/ContentPane\" data-dojo-props='region:\"center\",splitter:true,style:\"width:100%;height:100%\"' ></div>\r\n        <div  data-dojo-type=\"dijit/layout/ContentPane\" data-dojo-props='region:\"bottom\",splitter:true,style:\"width:100%;height:20%\"'>\r\n            <div data-dojo-type=\"dijit/layout/StackContainer\" data-dojo-attach-point=\"zone\" data-dojo-props='region:\"center\",doLayout:true,style:\"border:1px solid black\"'>\r\n                <div data-dojo-type=\"dijit/layout/ContentPane\" title=\"blank\" data-dojo-attach-point=\"blank_view\" selected></div>\r\n                <div data-dojo-type=\"dijit/layout/BorderContainer\" data-dojo-props='style:\"width:100%;height:100%\",title:\"allocations\",gutters:false' data-dojo-attach-point=\"allocations_view\">\r\n                    <div data-dojo-attach-point=\"allocations_grid\" data-dojo-type=\"dijit/layout/ContentPane\" data-dojo-props='region:\"center\"'></div>\r\n                    <div data-dojo-type=\"dijit/layout/ContentPane\" data-dojo-props='region:\"right\",style:\"width:50%;height:100%\"'>\r\n                        <button class=\"prmaxbutton\"  type=\"button\" data-dojo-type=\"dijit/form/Button\" label=\"Re-Allocate\" data-dojo-attach-event=\"onClick:_ReAllocate\" data-dojo-attach-point=\"reallocate\" ></button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <form data-dojo-attach-point=\"documentform\" target=\"_blank\" method=\"post\" action=\"/audit/viewpdf\">\r\n        <input type=\"hidden\" name=\"audittrailid\" data-dojo-attach-point=\"documentform_audittrailid\">\r\n    </form>\r\n    <form data-dojo-attach-point=\"htmlform\" target=\"_blank\" method=\"post\" action=\"/audit/viewhtml\">\r\n        <input type=\"hidden\" name=\"audittrailid\" data-dojo-attach-point=\"htmlform_audittrailid\">\r\n    </form>\r\n    \r\n    \r\n    <div data-dojo-type=\"control/customer/reallocation\" data-dojo-attach-point=\"reallocation\"></div>\r\n\r\n</div>\r\n"}});define("control/customer/financiallog",["dojo/_base/declare","ttl/BaseWidgetAMD","dojo/text!../customer/templates/financiallog.html","dijit/layout/BorderContainer","dojo/request","ttl/utilities2","dojo/_base/lang","dojo/topic","dojo/dom-class","dojo/dom-attr","dojo/data/ItemFileWriteStore","dojo/data/ItemFileReadStore","ttl/grid/Grid","ttl/store/JsonRest","dojo/store/Observable","dijit/layout/ContentPane","dijit/form/DateTextBox","dijit/form/CheckBox","dijit/form/Button","dijit/layout/StackContainer","control/customer/reallocation","dojox/grid/DataGrid"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _1("control.customer.financiallog",[_2],{templateString:_3,gutters:false,constructor:function(){this.financial_data=new _f(new _e({target:"/audit/customer_financial",idProperty:"audittrailid",onError:_6.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true}));this.allocation_data=new _f(new _e({target:"/allocation/allocation_details",idProperty:"customerpaymentallocationid",onError:_6.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true}));this._DeleteAlocationCallBack=_7.hitch(this,this._DeleteAlocationCall);this._LoadBalanceCallBack=_7.hitch(this,this._LoadBalanceCall);_8.subscribe(PRCOMMON.Events.Financial_ReLoad,_7.hitch(this,this._RefreshView));},postCreate:function(){this.inherited(arguments);var _10=[{label:"Logged",className:"dgrid-column-status-small",field:"auditdate"},{label:"Date",className:"dgrid-column-date",field:"invoice_date"},{label:"Text",className:"dgrid-column-status-large",field:"audittext"},{label:"Charge",className:"dgrid-column-money",field:"charge",formatter:_6.display_money},{label:"Paid",className:"dgrid-column-money",field:"paid",formatter:_6.display_money},{label:"Un All.",className:"dgrid-column-money",field:"unallocated",formatter:_6.display_money},{label:"Inv/Cd Nbr",className:"dgrid-column-nbr-right",field:"invoicenbr"},{label:"Month",className:"dgrid-column-status-small",field:"payment_month_display"},{label:" ",className:"dgrid-column-type-boolean",field:"documentpresent",formatter:_6.document_exists},{label:"Reason",className:"dgrid-column-status-large",field:"reason"}];var _11=[{label:"Type",className:"dgrid-column-status",field:"type"},{label:"Allocated",className:"dgrid-column-money",field:"amount",formatter:_6.display_money},{label:"Value",className:"dgrid-column-money",field:"amount",formatter:_6.display_money},{label:"Inv Id",className:"dgrid-column-nbr-right",field:"invoicenbr",},{label:"Date",className:"dgrid-column-date",field:"invoicedate"},{label:" ",className:"dgrid-column-type-boolean",formatter:_6.delete_row_ctrl}];this.view1=new _d({columns:_10,selectionMode:"single",store:this.financial_data,sort:[{attribute:"auditdate",descending:true}],query:{}});this.view2=new _d({columns:_11,selectionMode:"single",store:this.allocation_data,sort:[{attribute:"customerpaymentallocationid",descending:true}],query:{}});var td=new Date();var t=new Date(td.getTime()-370*24*60*60*1000);this.filterdate.set("value",t);this.financialgrid.set("content",this.view1);this.allocations_grid.set("content",this.view2);this.view1.on(".dgrid-cell:click",_7.hitch(this,this._OnSelectFinancial));this.view2.on(".dgrid-cell:click",_7.hitch(this,this._OnSelectAllocation));},load:function(_12){this._customerid=_12;var _13={icustomerid:this._customerid,unallocated:this.unallocated.get("checked"),moneyonly:this.moneyonly.get("checked")};var _14=_7.mixin(_6.get_prevent_cache(),_13);this.view1.set("query",_14);this._GetBalance();},resize:function(){this.inherited(arguments);this.borderControl.resize(arguments[0]);},_OnSelectFinancial:function(e){var _15=this.view1.cell(e);this._row=_15.row.data;if(_15.column.id==8&&this._row.documentpresent==true){if(this._row.audittypeid==17){_a.set(this.htmlform_audittrailid,"value",this._row.audittrailid);_a.set(this.htmlform,"action","/audit/viewhtml/"+this._row.audittrailid);this.htmlform.submit();}else{_a.set(this.documentform_audittrailid,"value",this._row.audittrailid);_a.set(this.documentform,"action","/audit/viewpdf/"+this._row.audittrailid);this.documentform.submit();}}else{var _16=_7.mixin(_6.get_prevent_cache(),{keyid:this._row.keyid});this.view2.set("query",_16);this.zone.selectChild((this._row.keyid==null)?this.blank_view:this.allocations_view);if(this._row.keyid==null){_9.add(this.reallocate,"prmaxhidden");}else{_9.remove(this.reallocate,"prmaxhidden");}}},_DeleteAlocationCall:function(_17){if(_17.success=="OK"){this.allocation_data.remove(this._alloc_row.customerpaymentallocationid);var _18=_7.mixin(_6.get_prevent_cache(),{icustomerid:this._customerid});this.view1.set("query",_18);alert("Allocation Deleted");}else{alert("Problem Deleting Allocation");}},_OnSelectAllocation:function(e){var _19=this.view2.cell(e);this._alloc_row=_19.row.data;if(_19.column.id==5){if(confirm("Delete Allocation")){_5.post("/allocation/allocation_delete",_6.make_params({data:{customerpaymentallocationid:this._alloc_row.customerpaymentallocationid}})).then(this._DeleteAlocationCallBack);}}},_ReAllocate:function(){this.reallocation.Load(this._customerid,this._row.keyid);},_RefreshView:function(){var _1a={icustomerid:this._customerid,filter_date:_6.to_json_date(this.filterdate.get("value")),unallocated:this.unallocated.get("value"),moneyonly:this.moneyonly.get("value")};var _1b=_7.mixin(_6.get_prevent_cache(),_1a);this.view1.set("query",_1b);if(this._row!=null&&this._row.keyid!=null){var _1b=_7.mixin(_6.get_prevent_cache(),{keyid:this._row.keyid});}this.view2.set("query",_1b);this._GetBalance();},_FilterBy:function(){var _1c={icustomerid:this._customerid,filter_date:_6.to_json_date(this.filterdate.get("value")),unallocated:this.unallocated.get("value"),moneyonly:this.moneyonly.get("value")};var _1d=_7.mixin(_6.get_prevent_cache(),_1c);this.view1.set("query",_1d);_9.add(this.reallocate,"prmaxhidden");this._GetBalance();},_GetBalance:function(){_5.post("/customer/customer_balance",_6.make_params({data:{icustomerid:this._customerid}})).then(this._LoadBalanceCallBack);},_LoadBalanceCall:function(_1e){if(_1e.success=="OK"){_a.set(this.balance_figure,"innerHTML",dojo.number.format(_1e.balances.balance/100,{places:2}));}else{_a.set(this.balance_figure,"innerHTML","ERROR");}}});});