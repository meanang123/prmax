/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.sales.view"]){dojo._hasResource["prmax.iadmin.sales.view"]=true;dojo.provide("prmax.iadmin.sales.view");dojo.require("ttl.BaseWidget");dojo.require("prmax.iadmin.sales.SetExpireDate");dojo.declare("prmax.iadmin.sales.view",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div dojoAttachPoint=\"borderControl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" gutters=\"false\">\r\n\t\t<div dojoType=\"dijit.layout.ContentPane\" region=\"top\" style=\"height:42px;width:100%;overflow:hidden;border:1px solid black\">\r\n\t\t\t<div class=\"dijitToolbarTop\" dojoType=\"dijit.Toolbar\" style=\"float:left:height:100%;width:100%\" >\r\n\t\t\t\t<div dojoType=\"dijit.form.DropDownButton\" iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\">\r\n\t\t\t\t\t<span>Filter By</span>\r\n\t\t\t\t\t<div dojoType=\"dijit.TooltipDialog\" title=\"Filter\" dojoAttachEvent=\"execute: _ExecuteFilter\">\r\n\t\t\t\t\t\t<table width=\"500px\">\r\n\t\t\t\t\t\t\t<tr><td><label >Owner</label></td><td><select dojoAttachPoint=\"userfilter\" name=\"iuserid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Task</label></td><td><select dojoAttachPoint=\"tasktypefilter\" name=\"tasktypeid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Status</label></td><td><select name=\"taskstatusid\" autoComplete=\"true\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\" dojoAttachPoint=\"taskstatusfilter\" ></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Over due Only</label></td><td><input class=\"prmaxinput\" dojoAttachPoint=\"overdue\" dojoType=\"dijit.form.CheckBox\" name=\"overdue\" value=\"1\" /></td></tr>\r\n\t\t\t\t\t\t\t<tr><td ><label >Type</label></td><td><select class=\"prmaxinput\" name=\"customertypeid\" dojoAttachPoint=\"customertypeid\" style=\"width:9em\" dojoType=\"dijit.form.FilteringSelect\" autoComplete=\"true\"></select></td></tr>\r\n\r\n\r\n\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t\t<td align=\"left\"><button dojoType=\"dijit.form.Button\" type=\"button\" dojoAttachEvent=\"onClick:_ClearFilter\">Clear Filter</button></td>\r\n\t\t\t\t\t\t\t\t<td align=\"right\"><button dojoType=\"dijit.form.Button\" type=\"submit\" name=\"submit\">Filter</button></td>\r\n\t\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoType=\"dijit.form.Button\" iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\" dojoAttachEvent=\"onClick:_Refresh\">Refresh</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div dojoAttachPoint=\"details_container\" dojoType=\"dijit.layout.StackContainer\" style=\"width:40%;height:100%\" region=\"right\"  splitter=\"true\" doLayout=\"true\" style=\"border:1px solid black\">\r\n\t\t\t<div dojoType=\"dijit.layout.ContentPane\" title=\"blank\" dojoAttachPoint=\"blank_view\" selected ></div>\r\n\t\t\t<div dojoType=\"dijit.layout.ContentPane\" title=\"details_view\" dojoAttachPoint=\"details_view\">\r\n\t\t\t\t<div dojoType=\"dijit.TitlePane\" title=\"Prospect Trial\" style=\"width: 100%\" >\r\n\t\t\t\t\t<form dojoAttachPoint=\"form\" class=\"prmaxdefault\" onsubmit=\"return false\" dojoType=\"dijit.form.Form\">\r\n\t\t\t\t\t\t<input type=\"hidden\" dojoAttachPoint=\"taskid\" name=\"taskid\" dojoType=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t\t<table width=\"99%\" class=\"prmaxtable\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"padding-top:5px;border-style:collapsed\">\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Last Accessed</td><td dojoAttachPoint=\"last_accessed_display\" class=\"prmaxrowdisplay\"></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Status</td><td><select name=\"taskstatusid\" autoComplete=\"true\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\" dojoAttachPoint=\"taskstatusid\" ></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Due Date</td><td><input type=\"text\" required=\"true\" dojoAttachPoint=\"due_date\" name=\"due_date\" dojoType=\"dijit.form.DateTextBox\" style=\"width:8em\" ></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Owner</td><td><select class=\"prmaxrequired\" required=\"true\" dojoAttachPoint=\"assigntoid\" name=\"assigntoid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Follow Up Disabled</td><td><input class=\"prmaxdefault\" dojoAttachPoint=\"emailactionstatus\"  dojoType=\"dijit.form.CheckBox\" type=\"checkbox\" name=\"emailactionstatus\"/></td></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Reason</td><td ><div class=\"stdframe prmaxrequired\" style=\"height:120px;\" ><textarea class=\"prmaxrequired\" dojoAttachPoint=\"reason\" name=\"reason\" trim=\"true\" required=\"true\" dojoType=\"dijit.form.Textarea\" style=\"width:99%;height:80%\" ></textarea></div></td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\" align=\"right\"><button dojoType=\"dojox.form.BusyButton\" dojoAttachPoint=\"updbtn\" busyLabel=\"Updating...\" dojoAttachEvent=\"onClick:_Update\" label=\"Update\"><td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\"><br/></td></tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t<table width=\"99%\" class=\"prmaxtable\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" >\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\">\r\n\t\t\t\t\t\t\t\t<button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_SendConfirmation\" label=\"Send Order Confirmation\"></button>\r\n\t\t\t\t\t\t\t\t<button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_SetExpire\" label=\"Set Expire Date\"></button>\r\n\t\t\t\t\t\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-attach-event=\"onClick:_GoToMainanence\" data-dojo-props='label:\"Go to Customer Details\",style:\"float:right\"'></button>\r\n\t\t\t\t\t\t\t</td></tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div dojoType=\"dijit.TitlePane\" title=\"Notes\" style=\"width: 100%\" class=\"scrollpanel\">\r\n\t\t\t\t\t<div  dojoType=\"prmax.crm.viewer\" dojoAttachPoint=\"crmviewer\" region=\"center\" contacthistorysourceid_default=\"2\" taskview=\"true\" style=\"width:100%;height:300px\" class=\"scrollpanel\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoType=\"dijit.TitlePane\" title=\"Customer Settings\" style=\"width: 100%\" open=\"false\">\r\n\t\t\t\t\t<form dojoAttachPoint=\"formsettingsupdate\"  onsubmit=\"return false\" dojoType=\"dijit.form.Form\">\r\n\t\t\t\t\t\t<input type=\"hidden\" dojoAttachPoint=\"icustomerid\" name=\"icustomerid\" dojoType=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t\t<table width=\"99%\" class=\"prmaxtable\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"padding-top:5px\">\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\" width=\"120px\">Enquiry Source</td><td><select class=\"prmaxinput\" name=\"customersourceid\" dojoAttachPoint=\"customersourceid\" style=\"width:10em\" dojoType=\"dijit.form.FilteringSelect\" autoComplete=\"true\" required=\"true\"></td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\"><br/></td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\" align=\"right\"><button dojoAttachPoint=\"updsettingsbtn\" class=\"prmaxhidden\" dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_UpdateSettings\" label=\"Update Customer\" busylabel=\"Updating ..\"></button>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\" region=\"center\"  splitter=\"true\">\r\n\t\t\t<div dojoAttachPoint=\"view_grid\" dojoType=\"dojox.grid.DataGrid\"   query=\"{ }\" rowsPerPage=\"50\" selectable=\"true\" ></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div dojoAttachPoint=\"expirectrl\" dojoType=\"prmax.iadmin.sales.SetExpireDate\" ></div>\r\n\t<div dojoType=\"dijit.Dialog\" title=\"Enter Order Confirmation\" dojoAttachPoint=\"sendorderconfirmationdialog\">\r\n\t\t<div dojoAttachPoint=\"sendorderconfirmationctrl\" dojoType=\"prmax.iadmin.accounts.OrderConfirmation\" ></div>\r\n\t</div>\r\n</div>\r\n",constructor:function(){this._tasks=new prcommon.data.QueryWriteStore({url:"/iadmin/tasks?group=sales",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true});this._row=null;this._taskstatusfilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus&nofilter"});this._userfilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=users&group=sales&nofilter"});this._tasktypefilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=tasktype&nofilter"});this._users=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=users&group=sales,accounts"});this._taskstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus"});this._customersources=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=customersources"});this._UpdatedCallBack=dojo.hitch(this,this._UpdatedCall);this._getModelItemBack=dojo.hitch(this,this._getModelItem);this._LoadCustomerCall=dojo.hitch(this,this._LoadCustomer);this._LoadCustomerSettingCallBack=dojo.hitch(this,this._LoadCustomerSettingCall);this._UpdatedSettingsCallBack=dojo.hitch(this,this._UpdatedSettingsCall);this._TaskCallBack=dojo.hitch(this,this._TaskCall);dojo.subscribe(PRCOMMON.Events.Task_Refresh,dojo.hitch(this,this._RefreshTask));},postCreate:function(){this.inherited(arguments);this.view_grid.set("structure",this._view);this.view_grid._setStore(this._tasks);this.view_grid["onRowClick"]=dojo.hitch(this,this._OnSelectRow);this.view_grid["onStyleRow"]=dojo.hitch(this,this._OnStyleRow);this.taskstatusid.store=this._taskstatus;this.assigntoid.store=this._users;this.customersourceid.store=this._customersources;this.taskstatusfilter.store=this._taskstatusfilter;this.userfilter.store=this._userfilter;this.tasktypefilter.store=this._tasktypefilter;this.taskstatusfilter.set("value",-1);this.userfilter.set("value",-1);this.tasktypefilter.set("value",-1);this.customertypeid.set("store",PRCOMMON.utils.stores.Customer_Types_Filter());this.customertypeid.set("value",-1);},_OnStyleRow:function(_1){var _2=this.view_grid.getItem(_1.index);if(_2&&_2.i.isoverdue==true){_1.customClasses+=" prmaxOverDueRow";}if(_2&&_2.i.istoday==true){_1.customClasses+=" prmaxCurrent";}ttl.GridHelpers.onStyleRow(_1);},_OnSelectRow:function(e){this._row=this.view_grid.getItem(e.rowIndex);dojo.addClass(this.updsettingsbtn.domNode,"prmaxhidden");dojo.xhrPost(ttl.utilities.makeParams({load:this._LoadCustomerSettingCallBack,url:"/iadmin/get_internal",content:{"icustomerid":this._row.i.customerid}}));this.crmviewer.LoadControls(null,null,null,this._row.i.customerid,this._row.i.taskid);this.icustomerid.set("value",this._row.i.customerid);this.taskstatusid.set("value",this._row.i.taskstatusid);this.emailactionstatus.set("value",this._row.i.emailactionstatusid==5?true:false);this.due_date.set("value",ttl.utilities.parseDate(this._row.i.due_date_full));dojo.attr(this.last_accessed_display,"innerHTML",this._row.i.last_login_display);this.assigntoid.set("value",this._row.i.userid);this.taskid.set("value",this._row.i.taskid);this.details_container.selectChild(this.details_view);this.view_grid.selection.clickSelectEvent(e);},_LoadCustomerSettingCall:function(_3){if(_3.success=="OK"){this.customersourceid.set("value",_3.data.cust.customersourceid);dojo.removeClass(this.updsettingsbtn.domNode,"prmaxhidden");}},resize:function(){this.borderControl.resize(arguments[0]);this.inherited(arguments);},_ClearFilter:function(){this.taskstatusfilter.set("value",-1);this.userfilter.set("value",-1);this.tasktypefilter.set("value",-1);this.overdue.set("checked",false);this.customertypeid.set("value",-1);},_view:{noscroll:false,cells:[[{name:"Due Date",width:"60px",field:"due_date_display"},{name:"Customer Name",width:"200px",field:"customername"},{name:"Contact Name",width:"150px",field:"contactname"},{name:"Tel.",width:"100px",field:"tel"},{name:"Owner",width:"150px",field:"user_name"},{name:"Status",width:"80px",field:"taskstatusdescription"},{name:"Type",width:"80px",field:"tasktypedescription"},{name:"Follow Up",width:"80px",field:"emailactionstatusdescription"},{name:"Started",width:"60px",field:"created_display"},{name:"Accessed",width:"60px",field:"last_login_display"},{name:"Source",width:"80px",field:"customertypename"}]]},_ExecuteFilter:function(){var _4={};if(arguments[0].iuserid!=-1){_4["iuserid"]=arguments[0].iuserid;}if(arguments[0].tasktypeid!=-1){_4["tasktypeid"]=arguments[0].tasktypeid;}if(arguments[0].taskstatusid!=-1){_4["taskstatusid"]=arguments[0].taskstatusid;}if(arguments[0].customertypeid!=-1){_4["customertypeid"]=arguments[0].customertypeid;}if(arguments[0].overdue.length>0){_4["overdue"]=1;}this.view_grid.setQuery(ttl.utilities.getPreventCache(_4));this.details_container.selectChild(this.blank_view);},_SetExpire:function(){this.expirectrl.Load(this._row.i.customerid,this._row.i.taskid);},_SendConfirmation:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._LoadCustomerCall,url:"/iadmin/get_internal",content:{"icustomerid":this._row.i.customerid}}));},_LoadCustomer:function(_5){if(_5.success=="OK"){this.sendorderconfirmationctrl.setCustomer(_5.data.cust.customerid,this.sendorderconfirmationdialog,_5.data.cust,this._row.i.taskid);this.sendorderconfirmationdialog.show();}else{alert("Problem Loading Customer Details");}},_UpdatedCall:function(_6){if(_6.success=="OK"){this.crmviewer.refresh(this._row.i.taskid);this._tasks.setValue(this._row,"tasktypedescription",_6.task.tasktypedescription,true);this._tasks.setValue(this._row,"taskstatusdescription",_6.task.taskstatusdescription,true);this._tasks.setValue(this._row,"due_date_display",_6.task.due_date_display,true);this._tasks.setValue(this._row,"emailactionstatusdescription",_6.task.emailactionstatusdescription,true);this.reason.set("value","");alert("Updated");}else{alert("Problem");}this.updbtn.cancel();},_getModelItem:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_Update:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.updbtn.cancel();return false;}if(this.reason.get("value").length==0){alert("Please Enter Details");this.updbtn.cancel();this.reason.focus();return false;}var _7=this.form.get("value");_7["due_date"]=ttl.utilities.toJsonDate(this.due_date.get("value"));dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._UpdatedCallBack),url:"/iadmin/task_update",content:_7}));},_UpdatedSettingsCall:function(_8){if(_8.success=="OK"){alert("Customer Details Updated");}else{alert("problem");}},_UpdateSettings:function(){if(confirm("Update Customer Details")){dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._UpdatedSettingsCallBack),url:"/iadmin/customer_task_settings_update",content:this.formsettingsupdate.get("value")}));}},_Refresh:function(){var _9={};this.view_grid.setQuery(ttl.utilities.getPreventCache(_9));this.details_container.selectChild(this.blank_view);},_GoToMainanence:function(){dojo.publish(PRCOMMON.Events.Show_Customer_Main,[this._row.i.customerid]);},_TaskCall:function(_a){if(_a.success=="OK"){this.crmviewer.refresh(this._row.i.taskid);this._tasks.setValue(this._row,"tasktypedescription",_a.task.tasktypedescription,true);this._tasks.setValue(this._row,"taskstatusdescription",_a.task.taskstatusdescription,true);this._tasks.setValue(this._row,"due_date_display",_a.task.due_date_display,true);this._tasks.setValue(this._row,"emailactionstatusdescription",_a.task.emailactionstatusdescription,true);this.reason.set("value","");this.taskstatusid.set("value",_a.task.taskstatusid);this.assigntoid.set("value",_a.task.userid);}},_RefreshTask:function(){if(this._row){dojo.xhrPost(ttl.utilities.makeParams({load:this._TaskCallBack,url:"/iadmin/task_get",content:{taskid:this._row.i.taskid}}));}}});}