/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.accounts.ReAllocation"]){dojo._hasResource["prmax.iadmin.accounts.ReAllocation"]=true;dojo.provide("prmax.iadmin.accounts.ReAllocation");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("prmax.iadmin.accounts.Allocation");dojo.require("ttl.BaseWidget");dojo.declare("prmax.iadmin.accounts.ReAllocation",[ttl.BaseWidget,prmax.iadmin.accounts.Allocation],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-attach-point=\"dialog\" data-dojo-props='title:\"Allocate\"'>\r\n\t\t<form dojoAttachPoint=\"form\"  onsubmit=\"return false\" dojoType=\"dijit.form.Form\">\r\n\t\t\t<input type=\"hidden\" dojoType=\"dijit.form.TextBox\" dojoAttachPoint=\"keyid\" name=\"keyid\" >\r\n\t\t\t<table width=\"600px\" cellpadding=\"0\" cellpadding=\"0\" >\r\n\t\t\t\t<tr><td colspan=\"2\"><div class=\"prmaxrowdisplaylarge\" style=\"text-align:center;display:inline\"></div><div class=\"prmaxrowdisplaylarge\" style=\"display:inline\" dojoAttachPoint=\"customername\"></div></td></tr>\r\n\t\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" >Value</td><td>\r\n\t\t\t\t\t<table width=\"100%\" cellpadding=\"0\" cellpadding=\"0\" ><tr>\r\n\t\t\t\t\t\t<td><input class=\"prmaxinput\" type=\"text\" readonly=\"readonly\" dojoType=\"dijit.form.CurrencyTextBox\" dojoAttachPoint=\"payment\" style=\"width:8em\"></input></td>\r\n\t\t\t\t\t\t<td class=\"prmaxrowlabel\">Amount to Allocte</td>\r\n\t\t\t\t\t\t<td class=\"prmaxrowlabel\"><input type=\"text\" dojoType=\"dijit.form.TextBox\" dojoAttachPoint=\"toallocate\" style=\"width:8em\" readonly=\"readonly\" ></input></td>\r\n\t\t\t\t\t</tr></table>\r\n\t\t\t\t</td></tr>\r\n\t\t\t\t<tr><td colspan=\"2\">\r\n\t\t\t\t\t<div dojoAttachPoint=\"alloc_grid\" dojoType=\"dojox.grid.DataGrid\" query=\"{ name:'*'}\" rowsPerPage=\"500\" style=\"width:590px;height:300px\"></div>\r\n\t\t\t\t</td></tr>\r\n\t\t\t\t<tr><td class=\"prmaxrowlabel\" colspan=\"2\" align=\"right\"><button dojoType=\"dojox.form.BusyButton\" labelBusy=\"Re-Allocation\" dojoAttachPoint=\"allocate\" type=\"button\" dojoAttachEvent=\"onClick:_ReAllocate\">Allocate</button></td></tr>\r\n\t\t\t</table>\r\n\t\t</form>\r\n\t</div>\r\n\t<div dojoAttachPoint=\"alloc_manual\" dojoType=\"prmax.iadmin.accounts.ManualAllocateAmount\"></div>\r\n</div>\r\n",constructor:function(){this._LoadCallBack=dojo.hitch(this,this._LoadCall);this._ReAllocateCallBack=dojo.hitch(this,this._ReAllocateCall);this._source="";},Load:function(_1,_2){this._customerid=_1;this.alloc_grid.resize({w:590,h:300});dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._LoadCallBack),url:"/iadmin/allocation_get_details",content:{keyid:_2}}));this.keyid.set("value",_2);},_LoadCall:function(_3){if(_3.success=="OK"){this._source=_3.data.source;this.alloc_grid.setQuery(dojo.mixin(ttl.utilities.getPreventCache(),{icustomerid:this._customerid,source:_3.data.source}));this.payment.set("value",_3.data.unallocated);this.toallocate.set("value",_3.data.unallocated);this.allocate.cancel();this.dialog.show();}},_onBlurAmount:function(){this._doallocation();},postCreate:function(){this._postCreate();this.inherited(arguments);},_ReAllocateCall:function(_4){if(_4.success=="OK"){alert("Re Allocated Done");this.dialog.hide();dojo.publish(PRCOMMON.Events.Financial_ReLoad,[]);}else{alert("Problem with allocations");}this.allocate.cancel();},_ReAllocate:function(){if(this.toallocate.get("value")>this.payment.get("value")){alert("Over Allocation");this.allocate.cancel();return;}var _5=this.form.get("value");_5["icustomerid"]=this._customerid;_5["unpaidamount"]=this.toallocate.get("value");_5["allocations"]=this.getAllocations();dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._ReAllocateCallBack),url:"/iadmin/allocation_reallocate",content:_5}));}});}