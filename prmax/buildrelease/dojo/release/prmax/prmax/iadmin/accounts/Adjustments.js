/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.accounts.Adjustments"]){dojo._hasResource["prmax.iadmin.accounts.Adjustments"]=true;dojo.provide("prmax.iadmin.accounts.Adjustments");dojo.require("prmax.iadmin.accounts.Allocation");dojo.require("ttl.BaseWidget");dojo.declare("prmax.iadmin.accounts.Adjustments",[ttl.BaseWidget,prmax.iadmin.accounts.Allocation],{widgetsInTemplate:true,templateString:"<div>\r\n\t<form data-dojo-attach-point=\"form\" data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t<table width=\"600px\" cellpadding=\"0\" cellpadding=\"0\" >\r\n\t\t\t<tr><td colspan=\"2\"><div class=\"prmaxrowdisplaylarge\" style=\"text-align:center;display:inline\">Adjustment for </div><div class=\"prmaxrowdisplaylarge\" style=\"display:inline\" data-dojo-attach-point=\"customername\"></div></td>\r\n\t\t\t<tr><td width=\"150px\"  align=\"right\" class=\"prmaxrowlabel\">Adjustment Type</td><td><select\r\n\t\t\t\t\tdata-dojo-props='name:\"adjustmenttypeid\",autoComplete:\"true\",labelType:\"html\"'\r\n\t\t\t\t\tdata-dojo-type=\"dijit.form.FilteringSelect\"\r\n\t\t\t\t\tdata-dojo-attach-point=\"adjustmenttypeid\"></select></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" >Value</td><td>\r\n\t\t\t\t<table width=\"100%\" cellpadding=\"0\" cellpadding=\"0\" ><tr>\r\n\t\t\t\t\t<td><input\r\n\t\t\t\t\t\t\t\tdata-dojo-props='\"class\":\"prmaxinput\",type:\"text\",name:\"value\",required:\"true\",trim:\"true\",style:\"width:8em\",constraints:{fractional:true,places:\"0,2\",min:0.01,max:99999.00}'\r\n\t\t\t\t\t\t\t\tdata-dojo-type=\"dijit.form.CurrencyTextBox\"\r\n\t\t\t\t\t\t\t\tdata-dojo-attach-point=\"payment\"\r\n\t\t\t\t\t\t\t\tdata-dojo-attach-event=\"onBlur:_onBlurAmount\"></input></td>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\">Amount Remaining</td>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\"><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"toallocate\" data-dojo-props='type:\"text\",style:\"width:8em\",readonly:\"readonly\"' ></input></td>\r\n\t\t\t\t</tr></table>\r\n\t\t\t</td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" >Adjustment Date</td><td><input data-dojo-props='type:\"text\",name:\"adjustmentdate\",required:\"true\"' data-dojo-attach-point=\"adjustmentdate\" data-dojo-type=\"dijit.form.DateTextBox\" ></td>\r\n\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" valign=\"top\">Message</td><td><div class=\"dialogprofileframe\" ><textarea data-dojo-attach-point=\"message\" data-dojo-props='name:\"message\",\"class\":\"dijitTextarea\",style:\"width:99%;height:99%\"' data-dojo-type=\"dijit.form.Textarea\" ></textarea></div></td></tr>\r\n\t\t\t<tr data-dojo-attach-point=\"alloc_view\"><td colspan=\"2\">\r\n\t\t\t\t<div data-dojo-attach-point=\"alloc_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='rowsPerPage:\"500\",style:\"width:590px;height:200px\"'></div>\r\n\t\t\t</td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" colspan=\"2\" align=\"right\"><button data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-point=\"addbtn\" data-dojo-props='busyLabel:\"Adding Adjustments ...\",type:\"button\"' data-dojo-attach-event=\"onClick:_Adjustment\">Adjust Account</button></td>\r\n\t\t</table>\r\n\t</form>\r\n\t<div data-dojo-attach-point=\"alloc_manual\" data-dojo-type=\"prmax.iadmin.accounts.ManualAllocateAmount\"></div>\r\n</div>\r\n",constructor:function(){this._AdjustmentCallBack=dojo.hitch(this,this._AdjustmentCall);this.adjustmenttypes=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=adjustmenttypes",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});},setCustomer:function(_1,_2,_3){this._customerid=_1;this._customername=_2;dojo.attr(this.customername,"innerHTML",this._customername);this._dialog=_3;this.alloc_grid.resize({w:590,h:300});this.alloc_grid.setQuery(dojo.mixin(ttl.utilities.getPreventCache(),{icustomerid:_1,source:"adjustments"}));this.addbtn.cancel();},_AdjustmentCall:function(_4){if(_4.success=="OK"){dojo.publish(PRCOMMON.Events.Financial_ReLoad,[]);alert("Adjustment Added");this._dialog.hide();this.Clear();}else{alert("Problem making Adjustment");}this.addbtn.cancel();},_Adjustment:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.addbtn.cancel();return false;}if(this.toallocate.get("value")>Math.abs(this.payment.get("value"))){alert("Over Allocation");this.addbtn.cancel();return;}var _5=this.form.get("value");_5["icustomerid"]=this._customerid;_5["allocations"]=this.getAllocations();_5["adjustmentdate"]=ttl.utilities.toJsonDate(this.adjustmentdate.get("value"));dojo.xhrPost(ttl.utilities.makeParams({load:this._AdjustmentCallBack,url:"/iadmin/adjust_account",content:_5}));},Clear:function(){this.payment.set("value","");this.message.set("value","");},postCreate:function(){this.adjustmentdate.set("value",new Date());this.adjustmenttypeid.store=this.adjustmenttypes;this.adjustmenttypeid.set("value",1);this._postCreate();this.inherited(arguments);},_onBlurAmount:function(){this._doallocation();}});}