/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.accounts.Diary"]){dojo._hasResource["prmax.iadmin.accounts.Diary"]=true;dojo.provide("prmax.iadmin.accounts.Diary");dojo.require("ttl.BaseWidget");dojo.require("prmax.iadmin.TaskAdd");dojo.declare("prmax.iadmin.accounts.Diary",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div dojoAttachPoint=\"borderControl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" gutters=\"false\">\r\n\t\t<div dojoType=\"dijit.layout.ContentPane\" region=\"top\" style=\"height:42px;width:100%;overflow:hidden;border:1px solid black\">\r\n\t\t\t<div class=\"dijitToolbarTop\" dojoType=\"dijit.Toolbar\" style=\"float:left:height:100%;width:100%\" >\r\n\t\t\t\t<div dojoType=\"dijit.form.DropDownButton\" iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\">\r\n\t\t\t\t\t<span>Filter By</span>\r\n\t\t\t\t\t<div dojoType=\"dijit.TooltipDialog\" title=\"Filter\" dojoAttachEvent=\"execute: _ExecuteFilter\">\r\n\t\t\t\t\t\t<table width=\"500px\">\r\n\t\t\t\t\t\t\t<tr><td><label >Owner</label></td><td><select dojoAttachPoint=\"userfilter\" name=\"iuserid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Task</label></td><td><select dojoAttachPoint=\"tasktypefilter\" name=\"tasktypeid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Status</label></td><td><select name=\"taskstatusid\" autoComplete=\"true\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\" dojoAttachPoint=\"taskstatusfilter\" ></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td><label >Dairy Types</label></td><td><select name=\"tasktagid\" autoComplete=\"true\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\" dojoAttachPoint=\"tasktagfilter\" ></select></td></tr>\r\n\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t\t<td align=\"left\"><button dojoType=\"dijit.form.Button\" type=\"button\" dojoAttachEvent=\"onClick:_ClearFilter\">Clear Filter by</button></td>\r\n\t\t\t\t\t\t\t\t<td align=\"right\"><button dojoType=\"dijit.form.Button\" type=\"submit\" name=\"submit\">Filter by</button></td>\r\n\t\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoType=\"dijit.form.Button\" iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\" dojoAttachEvent=\"onClick:_NewTask\">New</div>\r\n\t\t\t\t<div dojoType=\"dijit.form.Button\" iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\" dojoAttachEvent=\"onClick:_Refresh\">Refresh</div>\r\n\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div dojoAttachPoint=\"details_container\" dojoType=\"dijit.layout.StackContainer\" style=\"width:40%;height:100%\" region=\"right\"  splitter=\"true\" doLayout=\"true\" style=\"border:1px solid black\">\r\n\t\t\t<div dojoType=\"dijit.layout.ContentPane\" title=\"blank\" dojoAttachPoint=\"blank_view\" selected ></div>\r\n\t\t\t<div dojoType=\"dijit.layout.ContentPane\" title=\"details_view\" dojoAttachPoint=\"details_view\">\r\n\t\t\t\t<div dojoType=\"dijit.TitlePane\" title=\"Prospect Trial\" style=\"width: 100%\" >\r\n\t\t\t\t\t<form dojoAttachPoint=\"form\"  onsubmit=\"return false\" dojoType=\"dijit.form.Form\">\r\n\t\t\t\t\t\t<input type=\"hidden\" dojoAttachPoint=\"taskid\" name=\"taskid\" dojoType=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t\t<table width=\"99%\" class=\"prmaxtable\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"padding-top:5px\">\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Status</td><td><select name=\"taskstatusid\" autoComplete=\"true\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\" dojoAttachPoint=\"taskstatusid\" ></select></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Due Date</td><td><input type=\"text\" required=\"true\" dojoAttachPoint=\"due_date\" name=\"due_date\" dojoType=\"dijit.form.DateTextBox\" style=\"width:8em\" ></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Owner</td><td><select class=\"prmaxrequired\" required=\"true\" dojoAttachPoint=\"assigntoid\" name=\"assigntoid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Diary Type</td><td><select class=\"prmaxrequired\" required=\"true\" dojoAttachPoint=\"tasktagid\" name=\"tasktagid\" autoComplete=\"true\" style=\"width:15em\" dojoType=\"dijit.form.FilteringSelect\" labelType=\"html\"></select></td></td></tr>\r\n\t\t\t\t\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Reason</td><td ><div class=\"stdframe prmaxrequired\" style=\"height:150px;\" ><textarea class=\"prmaxrequired\" dojoAttachPoint=\"reason\" name=\"reason\" trim=\"true\" required=\"true\" dojoType=\"dijit.form.Textarea\" style=\"width:99%;height:80%\" ></textarea></div></td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\" align=\"right\"><button dojoType=\"dojox.form.BusyButton\" dojoAttachPoint=\"updbtn\" busyLabel=\"Updating...\" dojoAttachEvent=\"onClick:_Update\" label=\"Update\"><td></tr>\r\n\t\t\t\t\t\t\t<tr><td colspan=\"2\"><br/></td></tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div dojoType=\"dijit.TitlePane\" title=\"Notes\" style=\"width: 100%\" >\r\n\t\t\t\t\t<div  dojoType=\"prmax.crm.viewer\" dojoAttachPoint=\"crmviewer\" region=\"center\" contacthistorysourceid_default=\"2\" taskview=\"true\" style=\"width:100%;height:300px\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\" region=\"center\"  splitter=\"true\">\r\n\t\t\t<div dojoAttachPoint=\"view_grid\" dojoType=\"dojox.grid.DataGrid\"   query=\"{ }\" rowsPerPage=\"30\" ></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div dojoType=\"dijit.Dialog\" title=\"New Task\" dojoAttachPoint=\"newtaskdialog\">\r\n\t\t<div dojoAttachPoint=\"newtaskctrl\" dojoType=\"prmax.iadmin.TaskAdd\" ></div>\r\n\t</div>\r\n</div>\r\n",constructor:function(){this._tasks=new prcommon.data.QueryWriteStore({url:"/iadmin/tasks?group=accounts",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true});this._taskstatusfilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus&nofilter"});this._userfilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=users&group=accounts&nofilter"});this._tasktypefilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=tasktype&nofilter"});this._tasktagfilter=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=tasktags&group=accounts&nofilter"});this._users=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=users&group=sales,accounts"});this._taskstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus"});this._tasktags=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=tasktags&group=accounts"});this._UpdatedCallBack=dojo.hitch(this,this._UpdatedCall);this._getModelItemBack=dojo.hitch(this,this._getModelItem);this._LoadCustomerCall=dojo.hitch(this,this._LoadCustomer);},postCreate:function(){this.inherited(arguments);this.view_grid.set("structure",this._view);this.view_grid._setStore(this._tasks);this.view_grid["onRowClick"]=dojo.hitch(this,this._OnSelectRow);this.view_grid["onStyleRow"]=dojo.hitch(this,this._OnStyleRow);this.taskstatusid.store=this._taskstatus;this.assigntoid.store=this._users;this.tasktagid.store=this._tasktags;this.taskstatusfilter.store=this._taskstatusfilter;this.userfilter.store=this._userfilter;this.tasktypefilter.store=this._tasktypefilter;this.tasktagfilter.store=this._tasktagfilter;this.taskstatusfilter.set("value",-1);this.userfilter.set("value",-1);this.tasktypefilter.set("value",-1);this.tasktagfilter.set("value",-1);},_OnStyleRow:function(_1){var _2=this.view_grid.getItem(_1.index);if(_2&&_2.i.isoverdue==true){_1.customClasses+=" prmaxOverDueRow";}ttl.GridHelpers.onStyleRow(_1);},_OnSelectRow:function(e){this._row=this.view_grid.getItem(e.rowIndex);this.crmviewer.LoadControls(null,null,null,this._row.i.customerid,this._row.i.taskid);this.taskstatusid.set("value",this._row.i.taskstatusid);this.due_date.set("value",ttl.utilities.parseDate(this._row.i.due_date_full));this.assigntoid.set("value",this._row.i.userid);this.taskid.set("value",this._row.i.taskid);this.tasktagid.set("value",this._row.i.tasktagid);this.reason.set("value","");this.details_container.selectChild(this.details_view);this.view_grid.selection.clickSelectEvent(e);},resize:function(){this.borderControl.resize(arguments[0]);this.inherited(arguments);},_ClearFilter:function(){this.taskstatusfilter.set("value",-1);this.userfilter.set("value",-1);this.tasktypefilter.set("value",-1);this.overdue.set("checked",false);this.tasktagfilter.set("value",-1);},_view:{noscroll:false,cells:[[{name:" ",width:"2em",field:"customerid"},{name:"Customer Name",width:"200px",field:"customername"},{name:"Contact Name",width:"150px",field:"contactname"},{name:"Tel.",width:"100px",field:"tel"},{name:"Owner",width:"150px",field:"user_name"},{name:"Date",width:"60px",field:"due_date_display"},{name:"Status",width:"80px",field:"taskstatusdescription"},{name:"Type",width:"80px",field:"tasktypedescription"},{name:"Diary Type",width:"80px",field:"tasktagdescription"},{name:"Subject",width:"150px",field:"subject"}]]},_ExecuteFilter:function(){var _3={};if(arguments[0].iuserid!=-1){_3["iuserid"]=arguments[0].iuserid;}if(arguments[0].tasktypeid!=-1){_3["tasktypeid"]=arguments[0].tasktypeid;}if(arguments[0].taskstatusid!=-1){_3["taskstatusid"]=arguments[0].taskstatusid;}if(arguments[0].tasktagid!=-1){_3["tasktagid"]=arguments[0].tasktagid;}this.view_grid.setQuery(ttl.utilities.getPreventCache(_3));this.details_container.selectChild(this.blank_view);},_SetExpire:function(){this.expirectrl.Load(this._row.i.customerid,this._row.i.taskid);},_SendConfirmation:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._LoadCustomerCall,url:"/iadmin/get_internal",content:{"icustomerid":this._row.i.customerid}}));},_LoadCustomer:function(_4){if(_4.success=="OK"){this.sendorderconfirmationctrl.setCustomer(_4.data.cust.customerid,_4.data.cust.customername,_4.data.cust.email,this.sendorderconfirmationdialog,_4.data.cust.isadvancedemo);this.sendorderconfirmationdialog.show();}else{alert("Problem Loading Customer Details");}},_UpdatedCall:function(_5){if(_5.success=="OK"){this.crmviewer.refresh(this._row.i.taskid);this.tmp_row=null;var _6={identity:_5.task.taskid,onItem:this._getModelItemBack};this._tasks.fetchItemByIdentity(_6);if(this.tmp_row!=null){this._tasks.setValue(this.tmp_row,"tasktypedescription",_5.task.tasktypedescription,true);this._tasks.setValue(this.tmp_row,"taskstatusdescription",_5.task.taskstatusdescription,true);this._tasks.setValue(this.tmp_row,"due_date_display",_5.task.due_date_display,true);}this.reason.set("value","");alert("Updated");}else{alert("Problem");}this.updbtn.cancel();},_getModelItem:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_Update:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.updbtn.cancel();return false;}if(this.reason.get("value").length==0){alert("Please Enter Details");this.updbtn.cancel();this.reason.focus();return false;}var _7=this.form.get("value");_7["due_date"]=ttl.utilities.toJsonDate(this.due_date.get("value"));dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._UpdatedCallBack),url:"/iadmin/task_update",content:_7}));},_NewTask:function(){this.newtaskctrl.Load("accounts",this.newtaskdialog,this._tasks);this.newtaskdialog.show();},_Refresh:function(){this.view_grid.setQuery(ttl.utilities.getPreventCache({}));this.details_container.selectChild(this.blank_view);}});}