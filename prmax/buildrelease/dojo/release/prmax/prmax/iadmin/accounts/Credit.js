/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.accounts.Credit"]){dojo._hasResource["prmax.iadmin.accounts.Credit"]=true;dojo.provide("prmax.iadmin.accounts.Credit");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("prmax.iadmin.accounts.Allocation");dojo.require("dojox.validate.regexp");dojo.require("ttl.BaseWidget");dojo.declare("prmax.iadmin.accounts.Credit",[ttl.BaseWidget,prmax.iadmin.accounts.Allocation],{widgetsInTemplate:true,templateString:"<div>\r\n\t<form data-dojo-attach-point=\"form\"  data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t<table width=\"580px\" cellpadding=\"0\" cellpadding=\"0\" >\r\n\t\t\t<tr><td colspan=\"4\"><div class=\"prmaxrowdisplaylarge\" style=\"text-align:center;display:inline\">Credit for </div><div class=\"prmaxrowdisplaylarge\" style=\"display:inline\" data-dojo-attach-point=\"customername\"></div></td></tr>\r\n\t\t\t<tr>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\" align=\"right\">Cost</td>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\"><input data-dojo-type=\"dijit.form.CurrencyTextBox\" data-dojo-attach-point=\"cost\" data-dojo-props='\"class\":\"prmaxinput\",type:\"text\",name:\"cost\",required:true,trim:true,style:\"width:8em\",constraints:{min:0.01,max:99999.00,fractional:true,places:\"0,2\"}' data-dojo-attach-event=\"onBlur:_on_amount\" ></input></td>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\" align=\"right\">Amount Remaining</td>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\"><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"toallocate\" data-dojo-props='type:\"text\",style:\"width:8em\",readOnly:true' ></input></td>\r\n\t\t\t</tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td align=\"right\" class=\"prmaxrowlabel\">Vat</td>\r\n\t\t\t\t<td><input data-dojo-type=\"dijit.form.CurrencyTextBox\" data-dojo-props='type:\"text\",name:\"vat\",required:true,constraints:{min:0.00,max:99999.00,fractional:true,places:\"0,2\"},style:\"width:8em\"' data-dojo-attach-point=\"vat\" data-dojo-attach-event=\"onBlur:_on_vat_amount\"></input></td>\r\n\t\t\t</tr>\r\n\t\t\t<tr>\r\n\t\t\t\t\t<td class=\"prmaxrowlabel\" align=\"right\" >Gross</td>\r\n\t\t\t\t\t<td><input data-dojo-attach-point=\"payment\" data-dojo-type=\"dijit.form.CurrencyTextBox\" data-dojo-props='\"class\":\"prmaxinput\",type:\"text\",name:\"gross\",style:\"width:8em\",constraints:{min:0.00,max:99999.00,fractional:true,places:\"0,2\"},readOnly:true'></input></td>\r\n\t\t\t</tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" valign=\"top\">Message</td><td colspan=\"3\"><div class=\"dialogprofileframe\" ><textarea data-dojo-attach-point=\"message\" data-dojo-props='name:\"message\",\"class\":\"dijitTextarea\",style:\"width:99%;height:99%\"' data-dojo-type=\"dijit.form.Textarea\" ></textarea></div></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\" >Credit Date</td><td><input data-dojo-props='type:\"text\",name:\"payment_date\",required:\"true\"' data-dojo-attach-point=\"payment_date\" data-dojo-type=\"dijit.form.DateTextBox\" ></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" align=\"right\">Send Email</td><td><input data-dojo-attach-point=\"emailtocustomer\" data-dojo-props='\"class\":\"prmaxinput\",name:\"emailtocustomer\",type:\"checkbox\",checked:\"checked\"' data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-event=\"onClick:_email_required\"/><input data-dojo-attach-point=\"email\" data-dojo-props='required:true,\"class\":\"prmaxinput\",name:\"email\",type:\"text\",style:\"width:20em\",trim:\"true\",regExpGen:dojox.validate.regexp.emailAddress,invalidMessage:\"invalid email address\"' data-dojo-type=\"dijit.form.ValidationTextBox\" /></td></tr>\r\n\t\t\t<tr><td colspan=\"4\">\r\n\t\t\t\t<div data-dojo-attach-point=\"alloc_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='rowsPerPage:\"500\",style:\"width:690px;height:300px\"'></div>\r\n\t\t\t</td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowlabel\" colspan=\"4\" align=\"right\"><button data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-point=\"addbtn\" data-dojo-props='labelBusy:\"Crediting Account\",type:\"button\"' data-dojo-attach-event=\"onClick:_create\">Credit Account</button></td></tr>\r\n\t\t</table>\r\n\t</form>\r\n\t<div data-dojo-attach-point=\"alloc_manual\" data-dojo-type=\"prmax.iadmin.accounts.ManualAllocateAmount\"></div>\r\n</div>\r\n",constructor:function(){this._credit_call_back=dojo.hitch(this,this._credit_call);},setCustomer:function(_1,_2){this._customerid=_1.customerid;this._customername=_1.customername;this.email.set("value",_1.invoiceemail?_1.invoiceemail:_1.email);dojo.attr(this.customername,"innerHTML",this._customername);this._dialog=_2;this.alloc_grid.resize({w:590,h:300});this.alloc_grid.setQuery(dojo.mixin(ttl.utilities.getPreventCache({icustomerid:_1.customerid,source:"payment"})));this.addbtn.cancel();},_credit_call:function(_3){if(_3.success=="OK"){alert("Credit Added");this.Clear();dojo.publish(PRCOMMON.Events.Financial_ReLoad,[]);this._dialog.hide();}else{alert("Problem adding credit");}this.addbtn.cancel();},_create:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.addbtn.cancel();return false;}if(this.toallocate.get("value")>this.payment.get("value")){alert("Over Allocation");this.addbtn.cancel();return;}var _4=this.form.get("value");_4["icustomerid"]=this._customerid;_4["payment_date"]=ttl.utilities.toJsonDate(this.payment_date.get("value"));_4["unpaidamount"]=this.toallocate.get("value");_4["allocations"]=this.getAllocations();dojo.xhrPost(ttl.utilities.makeParams({load:this._credit_call_back,url:"/iadmin/credit_take",content:_4}));},_on_amount:function(){var _5=this.cost.get("value");var _6=_5*0.2;this.vat.set("value",dojo.number.format(_6,{places:2}));this.payment.set("value",dojo.number.format(_5+_6,{places:2}));this._doallocation();},Clear:function(){this.payment.set("value","0");this.vat.set("value",0);this.cost.set("value","0");this.message.set("value","");this.addbtn.cancel();},postCreate:function(){this._postCreate();this.inherited(arguments);},_email_required:function(){this.email.set("required",this.emailtocustomer.get("checked"));},_on_vat_amount:function(){var _7=this.cost.get("value");var _8=this.vat.get("value");this.payment.set("value",dojo.number.format(_7+_8,{places:2}));this._doallocation();}});}