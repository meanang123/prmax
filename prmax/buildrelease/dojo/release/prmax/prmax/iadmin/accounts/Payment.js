/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.iadmin.accounts.Payment"]){dojo._hasResource["prmax.iadmin.accounts.Payment"]=true;dojo.provide("prmax.iadmin.accounts.Payment");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("ttl.BaseWidget");dojo.require("prmax.iadmin.accounts.Allocation");dojo.declare("prmax.iadmin.accounts.Payment",[ttl.BaseWidget,prmax.iadmin.accounts.Allocation],{widgetsInTemplate:true,manualmode:false,templateString:"<div>\r\n\t<form data-dojo-attach-point=\"form\"  data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t<table width=\"600px\" cellpadding=\"0\" cellpadding=\"0\" >\r\n\t\t\t<tr><td colspan=\"2\"><div class=\"prmaxrowdisplaylarge\" style=\"text-align:center;display:inline\">Take Payment for </div><div class=\"prmaxrowdisplaylarge\" style=\"display:inline\" data-dojo-attach-point=\"customername\"></div></td>\r\n\t\t\t<tr><td width=\"150px\"  align=\"right\" class=\"prmaxrowtag\">Payment Type</td><td><select data-dojo-props='name:\"paymenttypeid\",autoComplete:true,labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"paymenttypeid\"></select></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" align=\"right\" >Value</td><td>\r\n\t\t\t\t<table width=\"100%\" cellpadding=\"0\" cellpadding=\"0\" ><tr>\r\n\t\t\t\t\t<td><input\r\n\t\t\t\t\tdata-dojo-type=\"dijit.form.CurrencyTextBox\"\r\n\t\t\t\t\tdata-dojo-props ='\"class\":\"prmaxinput\",type:\"text\",name:\"value\",required:true, trim:true,style:\"width:8em\",constraints:{min:0.01,max:99999.00,fractional:true,places:\"0,2\"}'data-dojo-attach-point=\"payment\" data-dojo-attach-event=\"onBlur:_onBlurAmount\"></input></td>\r\n\t\t\t\t\t<td data-dojo-attach-point=\"alloc_view_3\" class=\"prmaxhidden prmaxrowtag\">Amount to Allocted</td>\r\n\t\t\t\t\t<td data-dojo-attach-point=\"alloc_view_4\" class=\"prmaxhidden prmaxrowtag\">\r\n\t\t\t\t\t<input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"toallocate\" data-dojo-props='type:\"text\",style:\"width:8em\",readonly:\"readonly\"' ></input></td>\r\n\t\t\t\t</tr></table>\r\n\t\t\t</td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" align=\"right\">Send Email Confirmation</td><td><input data-dojo-attach-point=\"emailtocustomer\" data-dojo-props='\"class\":\"prmaxinput\",name:\"emailtocustomer\",type:\"checkbox\"' data-dojo-type=\"dijit.form.CheckBox\" checked /></td></tr>\r\n\t\t\t<tr data-dojo-attach-point=\"alloc_view_1\"><td class=\"prmaxrowtag\" align=\"right\">Expire Date</td><td><input data-dojo-props='type:\"text\",name:\"licence_expire\"' data-dojo-attach-point=\"licence_expire\" data-dojo-type=\"dijit.form.DateTextBox\" ></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" align=\"right\" valign=\"top\">Message</td><td><div class=\"dialogprofileframe\" ><textarea data-dojo-attach-point=\"message\" data-dojo-props='name:\"message\",\"class\":\"dijitTextarea\",style:\"width:99%;height:99%\"' data-dojo-type=\"dijit.form.Textarea\" ></textarea></div></td></tr>\r\n\t\t\t<tr data-dojo-attach-point=\"alloc_view_2\"><td class=\"prmaxrowtag\" align=\"right\" >Email Address</td><td><input data-dojo-props='\"class\":\"prmaxinput\",name:\"email\",type:\"text\",style:\"width:100%\",trim:true,required:true,regExpGen:dojox.validate.regexp.emailAddress,invalidMessage:\"invalid email address\",size:40,maxlength:70'data-dojo-attach-point=\"email\" data-dojo-type=\"dijit.form.ValidationTextBox\" /></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" align=\"right\" >Payment Date</td><td><input data-dojo-props='type:\"text\",name:\"payment_date\",required:true' data-dojo-attach-point=\"payment_date\" data-dojo-type=\"dijit.form.DateTextBox\" ></td>\r\n\t\t\t<tr data-dojo-attach-point=\"alloc_view\"><td colspan=\"2\"><div data-dojo-attach-point=\"alloc_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ name:\"*\"},rowsPerPage:500,style:\"width:590px;height:300px\"'></div></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" colspan=\"2\" align=\"right\"><button data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='busylabel:\"Taking Payment ...\",type:\"button\"' data-dojo-attach-point=\"btn\" data-dojo-attach-event=\"onClick:_TakePayment\">Take Payment</button></td>\r\n\t\t</table>\r\n\t</form>\r\n\t<div data-dojo-attach-point=\"alloc_manual\" data-dojo-type=\"prmax.iadmin.accounts.ManualAllocateAmount\"></div>\r\n</div>\r\n",constructor:function(){this._PaymentTakenCallBack=dojo.hitch(this,this._PaymentTakenCall);this.paymenttypes=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=paymenttypes",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});},setCustomer:function(_1,_2){this.btn.cancel();this._customerid=_1.customerid;this._customername=_1.customername;dojo.attr(this.customername,"innerHTML",_1.customername);if(_1.invoiceemail!=null&&_1.invoiceemail!=""){this.email.set("value",_1.invoiceemail);}else{this.email.set("value",_1.email);}this._dialog=_2;if(this.manualmode){this.alloc_grid.resize({w:590,h:300});this.alloc_grid.setQuery(dojo.mixin(ttl.utilities.getPreventCache(),{icustomerid:_1.customerid,source:"payment"}));}},_PaymentTakenCall:function(_3){if(_3.success=="OK"){if(this.manualmode){alert("Payment Taked");}else{alert("Payment Taken and invoice sent");}this.Clear();dojo.publish(PRCOMMON.Events.Financial_ReLoad,[]);this._dialog.hide();}else{alert("Problem taking payment");}this.btn.cancel();},_TakePayment:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.btn.cancel();return false;}if(this.manualmode){if(this.toallocate.get("value")>this.payment.get("value")){alert("Over Allocation");this.btn.cancel();return;}}var _4=this.form.get("value");_4["icustomerid"]=this._customerid;d=this.payment_date.get("value");if(d!=null){_4["payment_date"]=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();}if(this.manualmode){_4["unpaidamount"]=this.toallocate.get("value");_4["allocations"]=this.getAllocations();}else{var d=this.licence_expire.get("value");if(d!=null){_4["licence_expire"]=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();}}dojo.xhrPost(ttl.utilities.makeParams({load:this._PaymentTakenCallBack,url:"/iadmin/payment_take",content:_4}));},_onBlurAmount:function(){if(this.manualmode){var _5=this.payment.get("value");var _6=0;for(var c=0;c<this.alloc_store._items.length;c++){if(this.alloc_store._items[c]==null){continue;}_6+=dojo.number.round(parseFloat(this.alloc_store._items[c].i.allocated),2);}this.toallocate.set("value",dojo.number.format(dojo.number.round(_5-_6,2),{places:2}));}},Clear:function(){this.payment.set("value","");this.email.set("value","");this.emailtocustomer.set("checked",false);},postCreate:function(){this.inherited(arguments);this.paymenttypeid.store=this.paymenttypes;this.paymenttypeid.set("value","1");if(this.manualmode){dojo.addClass(this.alloc_view_1,"prmaxhidden");dojo.removeClass(this.alloc_view_3,"prmaxhidden");dojo.removeClass(this.alloc_view_4,"prmaxhidden");this._postCreate();}else{dojo.addClass(this.alloc_view,"prmaxhidden");}},_Allocate:function(){if(this.toallocate_value.isValid()==false){return;}if(this._allocted_row.i.unpaidamount/100<=this.toallocate_value.get("value")){alert("Over Allocation");return false;}this.alloc_store.setValue(this._allocted_row,"allocated",this.toallocate_value.get("value"),true);this._onBlurAmount();}});}