/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.user.UserAdmin"]){dojo._hasResource["prmax.user.UserAdmin"]=true;dojo.provide("prmax.user.UserAdmin");dojo.require("dijit._Templated");dojo.require("dijit._Widget");dojo.require("dijit._Container");dojo.require("dojox.form.PasswordValidator");dojo.declare("prmax.user.UserAdmin",[dijit._Widget,dijit._Templated,dijit._Container],{widgetsInTemplate:true,templateString:"<div >\r\n\t<div dojoAttachPoint=\"borderControl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" >\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\"  region=\"top\"  style=\"width:100%\">\r\n\t\t\t<div style=\"height:40px;width:100%;overflow:hidden;padding:0px;margin:0px\" class=\"searchresults\">\r\n\t\t\t\t<div style=\"height:100%;width:15%;float:left;padding:0px;margin:0px\" class=\"prmaxrowdisplaylarge\">Manage Users</div>\r\n\t\t\t\t<div class=\"dijitToolbarTop\" dojoType=\"dijit.Toolbar\" style=\"float:left:height:100%;width:85%;padding:0px;margin:0px\" >\r\n\t\t\t\t\t\t<div dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_ShowAddUser\"  iconClass=\"PrmaxResultsIcon PrmaxResultsEmpty\" showLabel=\"true\" dojoAttachPoint=\"addbutton\" label=\"Add New User\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\"   style=\"width:50%\" region=\"left\"  splitter=\"true\">\r\n\t\t\t<div dojoAttachPoint=\"usergrid\" dojoType=\"dojox.grid.DataGrid\" query=\"{ name:'*'}\" rowsPerPage=\"50\" style=\"width:100%:height:100%\"  ></div>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\"   region=\"center\"  >\r\n\t\t\t<div dojoAttachPoint=\"display_panel\" class=\"prmaxhidden\">\r\n\t\t\t    <form class=\"prmaxdefault\" dojoAttachPoint=\"updateform\" dojoType=\"dijit.form.Form\" onSubmit=\"return false\">\r\n\t\t\t\t\t<table style=\"width:300px\" class=\"prmaxtable\" >\r\n\t\t\t\t\t<tr><td colspan=\"2\" align=\"center\" class=\"prmaxrowdisplaylarge\">Change User Details</td></tr>\r\n\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t<td width=\"30%\" class=\"prmaxrowtag\">Email Address</td>\r\n\t\t\t\t\t\t<td><input dojoAttachPoint=\"update_email\" name=\"email\" type=\"text\" size=\"40\" maxlength=\"80\" trim=\"true\" dojoType=\"dijit.form.ValidationTextBox\" regExpGen=\"dojox.validate.regexp.emailAddress\" required=\"true\" trim=\"true\" invalidMessage=\"invalid email address\" size=\"40\" maxlength=\"70\"/></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t<td width=\"30%\" class=\"prmaxrowtag\">Display Name</td>\r\n\t\t\t\t\t\t<td><input dojoAttachPoint=\"update_displayname\" name=\"displayname\" type=\"text\" size=\"40\" maxlength=\"80\" trim=\"true\" dojoType=\"dijit.form.ValidationTextBox\" required=\"true\" trim=\"true\" invalidMessage=\"Must be entered\" size=\"40\" maxlength=\"40\"/></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t        <tr><td colspan=\"2\" align=\"right\"><button class=\"prmaxbutton\" dojoAttachPoint=\"updateNode\" dojoAttachEvent=\"onClick:_UpdateUser\" dojoType=\"dojox.form.BusyButton\" busyLabel=\"Please Wait Updating...\" label=\"Update\"></button></td></tr>\r\n\t\t\t\t\t<tr><td colspan=\"2\">&nbsp;</td></tr>\r\n\t\t\t        <tr><td colspan=\"2\"><button class=\"prmaxbutton\" dojoAttachPoint=\"resetNode\" dojoAttachEvent=\"onClick:_ResetPassword\" dojoType=\"dijit.form.Button\"><div style=\"width:8em\">Reset Password</div></button></td></tr>\r\n\t\t\t\t    <tr><td colspan=\"2\"><button class=\"prmaxbutton\" dojoAttachPoint=\"deleteNode\" dojoAttachEvent=\"onClick:_DeleteUser\" dojoType=\"dojox.form.BusyButton\"  busyLabel=\"Please Wait Deleting...\" ><div style=\"width:8em\">Delete User</div></button></td></tr>\r\n\t\t\t\t    </table>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div dojoType=\"dijit.Dialog\" title=\"Add User\" dojoAttachPoint=\"adddialog\">\r\n\t\t<form class=\"prmaxdefault\" dojoAttachPoint=\"addform\" dojoType=\"dijit.form.Form\" onSubmit=\"return false\">\r\n\t\t    <table style=\"width:350px\" class=\"prmaxtable\" >\r\n\t\t         <tr>\r\n\t\t\t\t\t<td width=\"30%\" class=\"prmaxrowtag\">Email Address</td>\r\n\t\t\t\t\t<td><input dojoAttachPoint=\"email\" name=\"email\" type=\"text\" size=\"40\" maxlength=\"80\" trim=\"true\" dojoType=\"dijit.form.ValidationTextBox\" regExpGen=\"dojox.validate.regexp.emailAddress\" required=\"true\" trim=\"true\" invalidMessage=\"invalid email address\" size=\"40\" maxlength=\"70\"/></td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t <tr>\r\n\t\t\t\t\t<td width=\"30%\" class=\"prmaxrowtag\">Display Name</td>\r\n\t\t\t\t\t<td><input dojoAttachPoint=\"displayname\" name=\"displayname\" type=\"text\" size=\"40\" maxlength=\"80\" trim=\"true\" dojoType=\"dijit.form.ValidationTextBox\" required=\"true\" trim=\"true\" invalidMessage=\"Must be entered\" size=\"40\" maxlength=\"40\"/></td>\r\n\t\t\t\t</tr>\r\n\t             <tr>\r\n\t\t\t\t\t<td width=\"30%\" class=\"prmaxrowtag\">Password</td>\r\n\t\t\t\t\t<td><input dojoAttachPoint=\"password_add\" name=\"password_add\" type=\"password\" size=\"20\" maxlength=\"20\" trim=\"true\" dojoType=\"dijit.form.ValidationTextBox\" required=\"true\" trim=\"true\" invalidMessage=\"Must be entered\" size=\"20\" maxlength=\"20\"/></td>\r\n\t\t\t\t</tr>\r\n\t\t\t\t<tr><td colspan=\"2\">&nbsp;</td></tr>\r\n\t\t        <tr><td align=\"left\"><button class=\"prmaxbutton\" dojoAttachEvent=\"onClick:_CloseAddDialog\" dojoType=\"dijit.form.Button\" label=\"Close\"></button></td>\r\n\t\t        <td align=\"right\"><button class=\"prmaxbutton\" dojoAttachPoint=\"saveAddNode\" dojoAttachEvent=\"onClick:_AddUser\" dojoType=\"dojox.form.BusyButton\" busyLabel=\"Please Wait Adding...\" label=\"Add\"></button></td></tr>\r\n\t\t\t\t<tr><td colspan=\"2\">&nbsp;</td></tr>\r\n\t\t    </table></form>\r\n\t</div>\r\n\t<div dojoType=\"dijit.Dialog\" title=\"Reset Password\" dojoAttachPoint=\"resetdialog\">\r\n\t\t<form class=\"prmaxdefault\" dojoAttachPoint=\"resetform\" dojoType=\"dijit.form.Form\" onSubmit=\"return false\">\r\n\t\t\t<table style=\"width:300px\" class=\"prmaxtable\" >\r\n\t\t\t<tr ><td colspan=\"2\"><div dojoAttachPoint=\"password\" dojoType=\"dojox.form.PasswordValidator\" name=\"password\" class=\"prmaxrowtag\">\r\n\t\t\t\t<table class=\"prmaxtable\" width=\"100%\" >\r\n\t\t\t\t\t<tr><td class=\"prmaxrowtag\" width=\"30%\">Password:</td><td><input dojoAttachPoint=\"password_1\" class=\"prmaxrequired\" type=\"password\" pwType=\"new\" /></td></tr>\r\n\t\t\t\t\t<tr><td class=\"prmaxrowtag\" >Verify:</td><td><input dojoAttachPoint=\"password_2\" class=\"prmaxrequired\" type=\"password\" pwType=\"verify\" /></td></tr>\r\n\t\t\t\t</table></div></td></tr>\r\n\t\t\t<tr><td align=\"left\"><button class=\"prmaxbutton\" dojoAttachEvent=\"onClick:_CloseDialog\" dojoType=\"dijit.form.Button\" label=\"Close\"></button></td>\r\n\t\t     <td align=\"right\"><button class=\"prmaxbutton\" dojoAttachPoint=\"resetPasswordNode\" dojoAttachEvent=\"onClick:_ResetPasswordButton\" dojoType=\"dojox.form.BusyButton\" busyLabel=\"Please Wait Changing...\" label=\"ResetPassword\"></button></td></tr>\r\n\t\t\t<tr><td colspan=\"2\">&nbsp;</td></tr>\r\n\t\t\t </table>\r\n\t\t</form>\r\n\t</div>\r\n</div>\r\n",constructor:function(){this.modelUserList=new prcommon.data.QueryWriteStore({url:"/user/list",nocallback:true,onError:ttl.utilities.globalerrorchecker});},postCreate:function(){this.usergrid.set("structure",this._view);this.usergrid._setStore(this.modelUserList);this.usergrid.onRowClick=dojo.hitch(this,this.onSelectRow);this.usergrid.onStyleRow=ttl.GridHelpers.onStyleRow;dojo.connect(this.addform,"onSubmit",dojo.hitch(this,this._Add));dojo.connect(this.resetform,"onSubmit",dojo.hitch(this,this._UpdatePassword));this._SavedCall=dojo.hitch(this,this._Saved);this._UpdatedCall=dojo.hitch(this,this._Updated);this._DeletedCall=dojo.hitch(this,this._Deleted);this._PasswordResetCall=dojo.hitch(this,this._PasswordReset);this._getModelItemCall=dojo.hitch(this,this._getModelItem);this.extended_security=PRMAX.utils.settings.extended_security;},_view:{noscroll:false,cells:[[{name:"Display Name",width:"250px",field:"display_name"},{name:"Email",width:"250px",field:"user_name"}]]},onSelectRow:function(e){this.row=this.usergrid.getItem(e.rowIndex).i;this._showPanel();this.usergrid.selection.clickSelectEvent(e);},_showPanel:function(){dojo.removeClass(this.display_panel,"prmaxhidden");this.update_email.set("value",this.row.user_name);this.update_displayname.set("value",this.row.display_name);},_hidePanel:function(){dojo.addClass(this.display_panel,"prmaxhidden");this.row=null;this.update_email.set("value","");this.update_displayname.set("value","");},_ShowAddUser:function(){this.saveAddNode.cancel();this.email.set("value",null);this.displayname.set("value",null);this.password_add.set("value",null);this.adddialog.show();this.email.focus();},_CloseAddDialog:function(){this.adddialog.hide();},_AddUser:function(){if(ttl.utilities.formValidator(this.addform)==false){alert("Not all required field filled in");this.saveAddNode.cancel();return;}var _1=this.password_add.value;if(this.extended_security){if(_1.length<8||this._has_lower_case(_1)==false||this._has_upper_case(_1)==false||this._has_number(_1)==false){alert("Please enter a valid password: minimum length 8 characters, at least one character upper case, one character lower case and one digit");this.saveAddNode.cancel();return;}}var _2=this.addform.get("value");_2["password"]=this.password_add.value;_2["extended_security"]=this.extended_security;dojo.xhrPost(ttl.utilities.makeParams({load:this._SavedCall,url:"/user/add",content:_2}));},_Saved:function(_3){if(_3.success=="OK"){this.saveAddNode.cancel();this.modelUserList.newItem(_3.data);this.adddialog.hide();}else{alert(_3.message);this.saveAddNode.cancel();}},_Add:function(){this.addform.submit();},_PasswordReset:function(_4){if(_4.success=="OK"){alert("Password Changed");this.resetPasswordNode.cancel();this.resetdialog.hide();}else{alert("Problem changing password");this.resetPasswordNode.cancel();}},_CloseDialog:function(){this.resetdialog.hide();},_UpdatePassword:function(){if(ttl.utilities.formValidator(this.resetform)==false){alert("Not all required field filled in");this.resetPasswordNode.cancel();return;}if(confirm("Update Password?")==true){var _5=this.password.value;if(this.extended_security){if(_5.length<8||this._has_lower_case(_5)==false||this._has_upper_case(_5)==false||this._has_number(_5)==false){alert("Please enter a valid password: minimum length 8 characters, at least one character upper case, one character lower case and one digit");this.resetPasswordNode.cancel();return;}}var _6=this.resetform.get("value");_6["extended_security"]=this.extended_security;_6["iuserid"]=this.row.user_id;_6["password"]=this.password.value;dojo.xhrPost(ttl.utilities.makeParams({load:this._PasswordResetCall,url:"/user/update_password",content:_6}));}else{this.resetPasswordNode.cancel();}},_ResetPassword:function(){this.resetPasswordNode.cancel();this.password_1.value="";this.password_2.value="";this.resetdialog.show();},_ResetPasswordButton:function(){this.resetform.submit();},_getModelItem:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_Deleted:function(_7){if(_7.success=="OK"){var _8={identity:this.row.user_id,onItem:this._getModelItemCall};this.modelUserList.fetchItemByIdentity(_8);if(this.tmp_row){this.modelUserList.deleteItem(this.tmp_row);}this._hidePanel();}else{alert("Problem Deleting User");}this.deleteNode.cancel();},_DeleteUser:function(){if(confirm("Delete user "+this.row.display_name+"?")==true){dojo.xhrPost(ttl.utilities.makeParams({load:this._DeletedCall,url:"/user/delete",content:{ruserid:this.row.user_id}}));}else{this.deleteNode.cancel();}},_Updated:function(_9){if(_9.success=="OK"){var _a={identity:this.row.user_id,onItem:this._getModelItemCall};this.modelUserList.fetchItemByIdentity(_a);if(this.tmp_row){this.modelUserList.setValue(this.tmp_row,"display_name",_9.data.display_name,true);this.modelUserList.setValue(this.tmp_row,"user_name",_9.data.user_name,true);}}else{if(_9.message!=undefined){alert(_9.message);}else{alert("Problem updating");}}this.updateNode.cancel();},_UpdateUser:function(){if(ttl.utilities.formValidator(this.updateform)==false){alert("Not all required field filled in");this.updateNode.cancel();return;}if(confirm("Update user details")==true){var _b=this.updateform.get("value");_b["ruserid"]=this.row.user_id;dojo.xhrPost(ttl.utilities.makeParams({load:this._UpdatedCall,url:"/user/update",content:_b}));}else{this.updateNode.cancel();}},resize:function(){this.borderControl.resize(arguments[0]);},Clear:function(){this._hidePanel();this.usergrid.setQuery(ttl.utilities.getPreventCache({}));},_has_lower_case:function(_c){var i=0;while(i<=_c.length){c=_c.charAt(i);if(c==c.toLowerCase()){return true;}i++;}return false;},_has_upper_case:function(_d){var i=0;while(i<=_d.length){c=_d.charAt(i);if(c==c.toUpperCase()){return true;}i++;}return false;},_has_number:function(_e){var i=0;while(i<=_e.length){c=_e.charAt(i);if(parseInt(c)){return true;}i++;}return false;},});}