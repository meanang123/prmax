/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.dataadmin.feedback.BouncedEmails"]){dojo._hasResource["prmax.dataadmin.feedback.BouncedEmails"]=true;dojo.provide("prmax.dataadmin.feedback.BouncedEmails");dojo.require("prmax.dataadmin.feedback.Completed");dojo.declare("prmax.dataadmin.feedback.BouncedEmails",[ttl.BaseWidget],{widgetsInTemplate:true,mainViewString:"/display/outletmain?outletid=${outletid}",templateString:"<div>\r\n\t<div  data-dojo-attach-point=\"borderControl\" data-dojo-type=\"dijit.layout.BorderContainer\"  style=\"width:100%;height:100%;overflow: hidden\" data-dojo-props=\"gutters:false\">\r\n\t\t<div  data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props=\"region:'left',splitter:true,'class':'bordered',style:'height:100%;width:40%',gutters:false\">\r\n\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-attach-point=\"controls\" data-dojo-props='region:\"top\",style:\"height:42px;width:100%;overflow:hidden\"'>\r\n\t\t\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-props='style:\"height:99%;width:100%;padding:0px;margin:0px\"'>\r\n\t\t\t\t\t<div data-dojo-attach-event=\"onClick:_Refresh\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"PrmaxResultsIcon PrmaxResultsEmpty\"'><span>Refresh</span></div>\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.form.DropDownButton\"  data-dojo-props='iconClass:\"PrmaxResultsIcon PrmaxResultsEmpty\",showLabel:true'>\r\n\t\t\t\t\t\t<span>Filter By</span>\r\n\t\t\t\t\t\t<div data-dojo-type=\"dijit.TooltipDialog\" data-dojo-props='title:\"Filter By\"' data-dojo-attach-event=\"execute:_Execute\">\r\n\t\t\t\t\t\t\t<table>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Exclude Auto Reply</label></td><td><input data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-point=\"autoreply\" data-dojo-props='type:\"checkbox\",name:\"autoreply\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Outlet Name</label></td><td><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"outletname\" data-dojo-props='type:\"text\",name:\"outletname\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Email Address</label></td><td><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"emailaddress\" data-dojo-props='type:\"text\",name:\"emailaddress\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Customer</label></td><td><select data-dojo-attach-point=\"customers\" data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-props='name:\"icustomerid\",autoComplete:true,searchAttr:\"customername\",labelType:\"html\"' ></select></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Top 50 PRmax</label></td><td><input data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-point=\"top50\" data-dojo-props='type:\"checkbox\",name:\"top50\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t\t\t<td align=\"left\"><button data-dojo-attach-event=\"onClick: _ClearFilter\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\"' >Clear Filter by</button></td>\r\n\t\t\t\t\t\t\t\t\t<td align=\"right\"><button data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"submit\",name:\"submit\"'>Filter by</button></td>\r\n\t\t\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region:\"center\"'>\r\n\t\t\t\t<div data-dojo-attach-point=\"result_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='style:\"height:100%;width:100%\",rowsPerPage:50'></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div data-dojo-attach-point=\"tabcont\" data-dojo-type=\"dijit.layout.TabContainer\" data-dojo-props=\"region:'center',splitter:true,'class':'bordered'\">\r\n\t\t\t<div data-dojo-attach-point=\"msg_basic_display\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Message',style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpane',selected:'selected'\"></div>\r\n\t\t\t<div data-dojo-attach-point=\"msg_display\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Original',style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpanel'\"></div>\r\n\t\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"controls\" data-dojo-props=\"preload:false,title:'Details','class':'bordered'\">\r\n\t\t\t\t<div title=\"blank\" data-dojo-attach-point=\"blank\" data-dojo-type=\"dijit.layout.ContentPane\" selected class=\"bordered\"></div>\r\n\t\t\t\t<div title=\"outlet\" data-dojo-attach-point=\"outletedit\" data-dojo-type=\"prmax.dataadmin.outlets.OutletEdit\" style=\"width:100%;height:100%\" class=\"bordered\"></div>\r\n\t\t\t\t<div title=\"freelance\" data-dojo-attach-point=\"freelanceedit\" data-dojo-type=\"prmax.dataadmin.freelance.FreelanceEdit\" style=\"width:100%;height:100%\" class=\"bordered\"></div>\r\n\t\t\t\t<div data-dojo-attach-point=\"isprivate\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:100%;height:100%\",\"class\":\"bordered\",title:\"isprivate\"'></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"completed_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Bounced Email Completed\"'>\r\n\t\t<div data-dojo-attach-point=\"completed_ctrl\" data-dojo-type=\"prmax.dataadmin.feedback.Completed\"></div>\r\n\t</div>\r\n\r\n</div>\r\n",constructor:function(){this.results=new prcommon.data.QueryWriteStore({url:"/dataadmin/bemails/list",onError:ttl.utilities.globalerrorchecker,nocallback:true});this._MessageLoadCallBack=dojo.hitch(this,this._MessageLoadCall);this._LoadCallBack=dojo.hitch(this,this._LoadCall);this._CompletedCallBack=dojo.hitch(this,this._CompletedCall);this.customer_front_id_data=new dojox.data.QueryReadStore({url:"/iadmin/customers_combo",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});dojo.subscribe(PRCOMMON.Events.BouncedEmail_Completed,dojo.hitch(this,this._CompletedEvent));},_CompletedEvent:function(_1){this.results.deleteItem(this._row);this.Clear();},_CompletedCall:function(_2){if(_2.success=="OK"){this.results.deleteItem(this._row);this.Clear();alert("Email marked as Ignored");}else{alert("Problem");}},Clear:function(){this.controls.selectChild(this.blank);this.msg_display.set("content","");this.msg_basic_display.set("content","");this.completed_dlg.hide();},postCreate:function(){this.result_grid.set("structure",this.view);this.result_grid._setStore(this.results);this.customers.set("store",this.customer_front_id_data);this.result_grid.onStyleRow=dojo.hitch(this,ttl.GridHelpers.onStyleRow);this.result_grid.onRowClick=dojo.hitch(this,this._OnSelectRow);this.inherited(arguments);},_OnSelectRow:function(e){this._row=this.result_grid.getItem(e.rowIndex);this._e=e;if(this._e.cellIndex==0){this.completed_ctrl.Load(this._row.i.bounceddistributionid);this.completed_dlg.show();}else{if(this._e.cellIndex==1){if(confirm("Mark as Ignore")){dojo.xhrPost(ttl.utilities.makeParams({load:this._CompletedCallBack,url:"/dataadmin/bemails/mark_as_ignore",content:{bounceddistributionid:this._row.i.bounceddistributionid}}));}}else{dojo.xhrPost(ttl.utilities.makeParams({load:this._LoadCallBack,url:"/dataadmin/bemails/get_and_lock",content:{bounceddistributionid:this._row.i.bounceddistributionid}}));}}this.result_grid.selection.clickSelectEvent(e);},_LoadCall:function(_3){if(_3.success=="OK"){this._Load_Details();}else{if(_3.success=="LO"){alert("This record is locked by "+_3.lock.username);}else{alert("Problem accessing record");}}},_Load_Details:function(){if(this._row.i.owneroutletid!=-1||this._row.i.owneremployeeid!=-1){this.isprivate.set("href",dojo.string.substitute(this.mainViewString,{outletid:this._row.i.outletid}));this.controls.selectChild(this.isprivate);}else{if(this._row.i.prmax_outlettypeid==42){this.controls.selectChild(this.freelanceedit);this.freelanceedit.Load(this._row.i.outletid);}else{if(this._row.i.prmax_outlettypeid!=null){this.controls.selectChild(this.outletedit);this.outletedit.Load(this._row.i.outletid);}else{this.controls.selectChild(this.blank);}}}this.tabcont.selectChild(this.msg_basic_display);this.msg_basic_display.set("href",dojo.string.substitute(this.MsgBasicView,{bounceddistributionid:this._row.i.bounceddistributionid}));this.msg_display.set("href",dojo.string.substitute(this.MsgView,{bounceddistributionid:this._row.i.bounceddistributionid}));},MsgView:"/dataadmin/bemails/msg_display?bounceddistributionid=${bounceddistributionid}",MsgBasicView:"/dataadmin/bemails/msg_basic_display?bounceddistributionid=${bounceddistributionid}",_MessageLoadCall:function(_4){},view:{cells:[[{name:" ",width:"12px",field:"",formatter:ttl.utilities.formatRowCtrl},{name:" ",width:"12px",field:"",formatter:ttl.utilities.deleteRowCtrl},{name:"Source",width:"65px",field:"sourcename"},{name:"Date",width:"60px",field:"createdate_display"},{name:"Outlet Name",width:"200px",field:"outletname"},{name:"Name",width:"150px",field:"contactname"},{name:"Job title",width:"150px",field:"job_title"},{name:"Subject",width:"250px",field:"subject"},{name:"Sent Customer",width:"150px",field:"customername"},{name:"Owner",width:"150px",field:"ownercustomername"}]]},resize:function(){this.borderControl.resize(arguments[0]);},_Refresh:function(){this._ClearFilter();},_ClearFilter:function(){this.autoreply.set("checked",false);this.outletname.set("value","");this.emailaddress.set("value","");this.customers.set("value",null);this.result_grid.setQuery(filter);},_Execute:function(){var _5={};if(arguments[0].autoreply=="on"){_5["autoreply"]=true;}if(arguments[0].top50=="on"){_5["top50"]=true;}if(arguments[0].outletname.length>0){_5["outletname"]=arguments[0].outletname;}if(arguments[0].emailaddress.length>0){_5["emailaddress"]=arguments[0].emailaddress;}if(arguments[0].icustomerid>0){_5["icustomerid"]=arguments[0].icustomerid;}this.result_grid.setQuery(_5);this.Clear();}});}