/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.display.DisplayCtrl"]){dojo._hasResource["prmax.display.DisplayCtrl"]=true;dojo.provide("prmax.display.DisplayCtrl");dojo.require("prcommon.advance.listview");dojo.require("dojox.collections.Dictionary");dojo.require("prcommon.contacthistory.edit");dojo.require("prcommon.crm.viewer_only");dojo.require("prcommon.crm.responses.resend");dojo.declare("prmax.display.DisplayCtrl",[dijit._Widget,dijit._Templated,dijit._Container],{mainViewStringEmpty:"/layout/std_outlet_view_startup",mainViewString:"/display/outletmain?outletid=${outletid}&cachebuster=${cachebuster}",widgetsInTemplate:true,private_data:true,source:"search",templateString:"<div>\r\n\t<div  dojoAttachPoint=\"borderCtrl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" gutters=\"false\" >\r\n\t\t<div dojoType=\"dijit.layout.StackContainer\" dojoAttachPoint=\"controls\" region=\"center\"  doLayout=\"true\" splitter=\"true\">\r\n\t\t\t<div  title=\"blank\" dojoAttachPoint=\"blank_view\" dojoType=\"dijit.layout.ContentPane\" selected></div>\r\n\t\t\t<div title=\"main\" dojoAttachPoint=\"tabControl\" dojotype=\"dijit.layout.TabContainer\" tabStrip=\"true\" region=\"center\" >\r\n\t\t\t\t<div dojoAttachPoint=\"mainView\" dojoType=\"ttl.layout.ContentPane\" title='Details' preload=\"true\" href=\"/layout/std_outlet_view_startup\" > </div>\r\n\t\t\t\t<div dojoAttachPoint=\"contactView\" dojoType=\"dijit.layout.BorderContainer\" title='Contacts' preload=\"true\" style=\"width:100%;height:100%\" selected=\"selected\" gutters=\"false\">\r\n\t\t\t\t\t<div dojoAttachPoint=\"contactdisplay\" region=\"center\" dojotype=\"prmax.employee.EmployeeDisplay\" style=\"height:50%;width:100%\"></div>\r\n\t\t\t\t\t<div dojoAttachPoint=\"contactgrid\" dojoType=\"dojox.grid.DataGrid\"   query=\"{ }\" rowsPerPage=\"30\" splitter=\"true\" region=\"bottom\" style=\"height:50%;width:100%\" ></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<!--\r\n\t\t\t\t<div dojoAttachPoint=\"profileView\" dojoType=\"ttl.layout.ContentPane\" title='Profile' preload=\"false\"></div>\r\n\t\t\t\t-->\r\n\t\t\t\t\r\n\t\t\t\t<div data-dojo-attach-point=\"advanceView\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='title:\"Features\",preload:true,\"class\":\"prmaxhidden\" '>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"advancectrl\" data-dojo-type=\"prcommon.advance.listview\" data-dojo-props='region:\"center\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"crmView\" data-dojo-type=\"dijit.layout.BorderContainer\", data-dojo-props='title:\"Engagement\",preload:true,\"class\":\"prmaxhidden\" '>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"crmctrl\" data-dojo-type=\"prcommon.crm.viewer_only\" data-dojo-props='region:\"center\",mode:\"outlet\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"resendView\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='title:\"Contact\",preload:true'>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"resendctrl\" data-dojo-type=\"prcommon.crm.responses.resend\" data-dojo-props='region:\"center\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div dojoType=\"prcommon.contacthistory.edit\"></div>\r\n\r\n</div>\r\n\r\n",constructor:function(){this._check_outlet_call_back=dojo.hitch(this,this._check_outlet_call);this.modelemployeeslist=new prcommon.data.QueryWriteStore({url:"/employees/contactlist",onError:ttl.utilities.globalerrorchecker,nocallback:true});this.modelemployeeslist.SetNoCallBackMode(true);try{this.ctrldata=new PRMAX.DisplayObject();}catch(e){alert("missing 1");this.ctrldata=new Object();}this.mainViewButton=null;this.loaded_advance=false;this.loaded_contacts=false;this.movetab=true;this._context=new dojox.collections.Dictionary();this._context.add("search",new PRMAX.DisplayContext("search",this));if(PRMAX.utils.settings.advancefeatures){this._context.add("advance",new PRMAX.DisplayContext("advance",this));}this.onLoadDisplayCtrlCall=dojo.hitch(this,this.onLoadDisplayCtrl);this._AddedToListCallBack=dojo.hitch(this,this._AddedToListCall);this._DeleteFromListCallBack=dojo.hitch(this,this._DeleteFromListCall);this._ChangeEmployeeCallback=dojo.hitch(this,this._ChangeEmployeeCall);this._DeleteEmployeeCallBack=dojo.hitch(this,this._DeleteEmployeeCall);this._GetEntryCallBack=dojo.hitch(this,this._getContactEntry);dojo.subscribe(PRCOMMON.Events.Employee_Deleted,dojo.hitch(this,this._EmployeeDeletedEvent));dojo.subscribe(PRCOMMON.Events.Employee_Updated,dojo.hitch(this,this._EmployeeUpdateEvent));dojo.subscribe(PRCOMMON.Events.Outlet_Deleted,dojo.hitch(this,this._OutletDeleteEvent));dojo.subscribe(PRCOMMON.Events.Outlet_Updated,dojo.hitch(this,this._OutletUpdateEvent));dojo.subscribe(PRCOMMON.Events.Employee_Add,dojo.hitch(this,this._EmployeeAddEvent));dojo.subscribe(PRCOMMON.Events.Employee_Override,dojo.hitch(this,this._EmployeeOverridesChanged));dojo.subscribe(PRCOMMON.Events.Outlet_Overrides,dojo.hitch(this,this._OutletOverridesChanged));dojo.subscribe(PRCOMMON.Events.Display_Clear,dojo.hitch(this,this.ClearEvent));dojo.subscribe(PRCOMMON.Events.Display_Clear,dojo.hitch(this,this.ClearEvent));dojo.subscribe(PRCOMMON.Events.Display_View_Changed,dojo.hitch(this,this.ViewChangedEvent));dojo.subscribe(PRCOMMON.Events.Display_Load,dojo.hitch(this,this.LoadEvent));dojo.subscribe(PRCOMMON.Events.Display_ReLoad,dojo.hitch(this,this.RefreshEvent));dojo.subscribe("/update/engagement_label",dojo.hitch(this,this._UpdateEngagementLabelEvent));this.iefix=false;},onSelectTab:function(_1){if(_1.id==this.contactView.id&&this.loaded_contacts===false){this.loaded_contacts=true;this.contactgrid.setQuery(ttl.utilities.getPreventCache({outletid:this.ctrldata.outletid}));}if(_1.id==this.advanceView.id&&this.loaded_advance===false){this.loaded_advance=true;if(this.advanceView.get("class")=="prmaxhidden"){this.advanceView.set("class","");}this.advancectrl.Load(this.ctrldata.outletid);}if(_1.id==this.contactView.id&&dojo.isIE==8&&this.iefix==false){dojo.style(this.contactgrid.domNode,"width",dojo.style(this.contactgrid.domNode,"width")-10+"px");dojo.style(this.contactgrid.domNode,"height",dojo.style(this.contactgrid.domNode,"height")-10+"px");this.iefix=true;}},_printReport:function(){dijit.byId("std_report_control").StartDialog({reportoutputtypeid:0,reporttemplateid:2,outletid:this.ctrldata.outletid});},postCreate:function(){dojo.subscribe(this.tabControl.id+"-selectChild",dojo.hitch(this,this.onSelectTab));this.contactgrid.set("structure",this.layoutEmployeeList);this.contactgrid.onStyleRow=dojo.hitch(this,this.onContactRowStyle);this.contactgrid.onRowClick=dojo.hitch(this,this.onSelectContactRow);this.contactgrid.onCellClick=dojo.hitch(this,this.onCellClick);this.contactgrid.onRowContextMenu=dojo.hitch(this,this.onRowContextMenu);this.contactgrid._setStore(this.modelemployeeslist);this.contactgrid.canSort=function(_2){return (_2==1||_2==4)?false:true;};this.inherited(arguments);},_LoadButtons:function(){this.mainViewButton=this.mainView.controlButton;this.contactsTabButton=this.contactView.controlButton;this.advanceTabButton=this.advanceView.controlButton;this.crmView.set("title",PRMAX.utils.settings.crm_engagement_plural);this.crmTabButton=this.crmView.controlButton;if(this.crmTabButton){this.crmTabButton.set("label",PRMAX.utils.settings.crm_engagement_plural);}this.freelancerContactTabButton=this.resendView.controlButton;},_UpdateEngagementLabelEvent:function(){this.crmView.set("title",PRMAX.utils.settings.crm_engagement_plural);this.crmTabButton.set("label",PRMAX.utils.settings.crm_engagement_plural);},onCellClick:function(e){if(e.cellIndex>0&&e.cellIndex<4){this.onSelectContactRow(e);if(e.cellIndex==3){this.onRowContextMenu(e);}}else{this.inherited(arguments);}},onRowContextMenu:function(e){this.contactgrid.selection.clickSelectEvent(e);this._context_row=this.contactgrid.getItem(e.rowIndex);var _3=null;var _4=this._context.item(this.source);if(this._context_row.i.customerid!=-1||this._context_row.i.ccustomerid!=-1){_3=_4._private_record_context_menu();}if(this._context_row.i.customerid==-1||this._context_row.i.ccustomerid==-1){_3=_4._std_record_context_menu();}if(this._context_row.i.customerid!=-1&&this._context_row.i.ccustomerid==-1){_3=_4._private_record_context_menu2();}if(_3){_3._openMyself(e);}},onContactRowStyle:function(_5){if(_5.over){_5.customClasses+=" dojoxGridRowOver";return;}if(_5.selected){_5.customClasses+=" prmaxSelectedRow";return;}var _6=this.contactgrid.getItem(_5.index);if(_6&&_6.i.employeeid==this.grid_employeeid){_5.customClasses+=" employeeSelected";return;}else{if(_6&&_6.i.override_primary){_5.customClasses+=" overridePrimaryRow";return;}else{if(_6&&_6.i.prn_primary){_5.customClasses+=" prnPrimaryRow";return;}else{if(_6&&_6.i.customerid!=-1){_5.customClasses+=" overridePrivateRow";return;}}}}if(_5.odd){_5.customClasses+=" dojoxGridRowOdd";}},showOptionsTabs:function(_7){if(this.mainViewButton==null){return;}var _8="";if(_7.outletid==-1){_8="none";}this.mainViewButton.domNode.style.display=_8;if(this.crmTabButton){this.crmTabButton.domNode.style.display=(PRMAX.utils.settings.crm)?_8:"none";}if(this.freelancerContactTabButton){this.freelancerContactTabButton.domNode.style.display=(ttl.data.utilities.isIndividual(_7.outlettypeid))?_8:"none";}this.advanceTabButton.domNode.style.display=(PRMAX.utils.settings.advancefeatures)?_8:"none";if(_8==""&&ttl.data.utilities.isIndividual(_7.outlettypeid)){_8="none";}this.contactsTabButton.domNode.style.display=_8;if((ttl.data.utilities.isIndividual(_7.outlettypeid)===true&&(this.tabControl.selectedChildWidget==this.extendedtabControl||this.tabControl.selectedChildWidget==this.contactView))||(ttl.data.utilities.isIndividual(_7.outlettypeid)===false&&this.tabControl.selectedChildWidget==this.resendView)){this.tabControl.selectChild(this.mainView);}},layoutEmployeeList:{cells:[[{name:" ",width:"15px",field:"customerid",formatter:ttl.utilities.formatContactInfo},{name:"Contact",width:"200px",field:"contactname"},{name:"Job Title",width:"350px",field:"job_title"},{name:" ",width:"15px",field:"",formatter:ttl.utilities.formatRowCtrl}]]},_OutletDeleteEvent:function(_9){if(this.ctrldata.outletid==_9.outletid){this.Clear();}},_Load:function(_a){if(this.mainViewButton==null){this._LoadButtons();}this.grid_employeeid=_a.employeeid;if(this.ctrldata.outletid!=_a.outletid||_a===null){if(_a){this.Clear(false);this.ctrldata.Set(_a);}this.showOptionsTabs(this.ctrldata);this._SetMainView();this.contactdisplay.Clear();this.contactgrid.setQuery(ttl.utilities.getPreventCache({outletid:this.ctrldata.outletid}));this.controls.selectChild(this.tabControl);dojo.xhrPost(ttl.utilities.makeParams({load:this._check_outlet_call_back,url:"/outlets/check_outlet",content:{outletid:this.ctrldata.outletid}}));if(PRMAX.utils.settings.crm&&this.crmctrl){this.crmctrl.load_outlet(this.ctrldata.outletid,this.ctrldata.outletname);}if(ttl.data.utilities.isIndividual(this.ctrldata.outlettypeid)===false){try{if(this.tabControl.selectedChildWidget==this.contactView){this.loaded_contacts=true;}if(this.tabControl.selectedChildWidget==this.advanceView){this.loaded_advance=true;}}catch(e){}this.loadEmployee();}else{this.resendctrl.Load(_a.email,_a.employeeid);}}else{if(this.ctrldata.advancefeatureid!=_a.advancefeatureid&&_a!=null&&_a.advancefeatureid!=-1&&PRMAX.utils.settings.advancefeatures){this.ctrldata.Set(_a);this.advancectrl.ShowFeature(this.ctrldata.advancefeatureid);}}},_SetMainView:function(){this.mainView.set("href",dojo.string.substitute(this.mainViewString,{outletid:this.ctrldata.outletid,cachebuster:new Date().getTime()}));},refresh:function(_b){if(this.ctrldata.outletid==_b){this._Load();}},Clear:function(_c){this.controls.selectChild(this.blank_view);this.mainView.set("content","");if(_c===undefined){this.mainView.set("href",this.mainViewStringEmpty);}this.loaded_contacts=false;this.loaded_advance=false;this.contactgrid.selection.clear();this.ctrldata.Clear();this.showOptionsTabs(this.ctrldata);this.loadEmployee();if(_c===undefined||_c===true){this.contactgrid.setQuery();this.tabControl.selectChild(this.contactView);}},onSelectContactRow:function(e){var _d=this.contactgrid.getItem(e.rowIndex);this.ctrldata.employeeid=_d.i.employeeid;this.ctrldata.contactname=_d.i.contactname;this.loadEmployee();this.contactgrid.selection.clickSelectEvent(e);},loadEmployee:function(){this.contactdisplay.LoadEmployee(this.ctrldata.employeeid,this.ctrldata.contactname);},_AddEmployee:function(){PRMAX.search.largeDialog.set("content","<div dojoType=\"prmax.employee.EmployeeEdit\" addsession=\"true\" employeeid=\"-1\" outletid=\""+this.ctrldata.outletid+"\"></div>");PRMAX.search.largeDialog.show("Add Contact  ("+this.ctrldata.outletname+")");},_EditEmployee:function(){if(this._context_row.i.customerid==-1){PRMAX.search.stdDialog.set("content","<div dojoType=\"prmax.employee.EmployeeOverride\" employeeid=\""+this._context_row.i.employeeid+"\"></div>");PRMAX.search.stdDialog.show("Change Contact Details ("+this._context_row.i.contactname+")");}else{PRMAX.search.largeDialog.set("content","<div dojoType=\"prmax.employee.EmployeeEdit\" employeeid=\""+this._context_row.i.employeeid+"\" outletid=\"-1\"></div>");PRMAX.search.largeDialog.show("Edit Contact  ("+this._context_row.i.contactname+")");}},_EmployeeDeletedEvent:function(_e){this.content=null;var _f={identity:_e.employee.employeeid,onItem:this._GetEntryCallBack};this.modelemployeeslist.fetchItemByIdentity(_f);if(this.content!==null){this.modelemployeeslist.deleteItem(this.content);}if(this.ctrldata.employeeid==_e.employee.employeeid){this.ctrldata.employeeid=-1;this.ctrldata.sessionsearchid=-1;}if(this.ctrldata.employeeid==_e.employee.employeeid){this.ctrldata.employeeid=-1;this.loadEmployee();}},_DeleteEmployeeCall:function(_10){if(_10.success=="OK"){dojo.publish(PRCOMMON.Events.Employee_Deleted,[_10.data]);alert("Contact Deleted");}else{alert("Problem Deleting Contact");}},_DeleteEmployee:function(){if(confirm("Delete Contact "+this._context_row.i.job_title+" "+this._context_row.i.contactname)){dojo.xhrPost(ttl.utilities.makeParams({load:this._DeleteEmployeeCallBack,url:"/employees/employee_delete",content:{employeeid:this._context_row.i.employeeid}}));}},_AddedToListCall:function(_11){if(_11.success=="OK"){dojo.publish(PRCOMMON.Events.SearchSession_Added,[_11.data,_11.count]);alert("Added to Results");}else{if(_11.success=="DU"){alert("Already in results");}else{alert("Problem adding to results");}}},_AddToResults:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._AddedToListCallBack,url:"/search/sessionaddemployee",content:{employeeid:this._context_row.i.employeeid}}));},_DeleteFromListCall:function(_12){if(_12.success=="OK"){dojo.publish(PRCOMMON.Events.SearchSession_Deleted,[_12.data]);alert(" Contact deleted from Results");}},_DeleteToResults:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._DeleteFromListCallBack,url:"/search/sessiondeleteemployee",content:{employeeid:this._context_row.i.employeeid}}));},_ChangeEmployeeCall:function(_13){if(_13.success=="DU"){alert("Already in Results");}if(_13.success=="OK"){alert("Changed to Contact "+_13.data.contactname);this.grid_employeeid=_13.data.employeeid;dojo.publish(PRCOMMON.Events.Employee_Updated,[_13.data,_13.data.sessionsearchid]);this.contactgrid.update();}},_ChangeSelectedRow:function(){if(this.grid_employeeid!=this._context_row.i.employeeid){if(confirm("Change Contact to "+this._context_row.i.job_title+" "+this._context_row.i.contactname)){dojo.xhrPost(ttl.utilities.makeParams({load:this._ChangeEmployeeCallback,url:"/search/sessionchangeemployee",content:{employeeid:this._context_row.i.employeeid,sessionsearchid:this.ctrldata.sessionsearchid}}));}}else{alert("Already Selected");}},_EmployeeAddEvent:function(_14){if(this.ctrldata.outletid==_14.outletid){var _15=this.modelemployeeslist.newItem(_14);gHelper.AddRowToQueryWriteGrid(this.contactgrid,_15);this.ctrldata.employeeid=_14.employeeid;this.loadEmployee();}},_EmployeeOverridesChanged:function(_16){if(this.ctrldata.employeeid===_16.employeeid){this.loadEmployee();}},_OutletOverridesChanged:function(_17){if(this.ctrldata.outletid===_17.outlet.outletid){this._SetMainView();}},_getContactEntry:function(){this.content=arguments[0];},_EmployeeUpdateEvent:function(_18){var _19={identity:_18.employeeid,onItem:this._GetEntryCallBack};this.modelemployeeslist.fetchItemByIdentity(_19);if(this.content){this.modelemployeeslist.setValue(this.content,"job_title",_18.job_title,true);this.modelemployeeslist.setValue(this.content,"contactname",_18.contactname,true);}if(this.ctrldata.employeeid===_18.employeeid){this.loadEmployee();}},_OutletUpdateEvent:function(_1a){if(this.ctrldata.outletid===_1a.outlet.outletid){this._SetMainView();}},LoadEvent:function(_1b,_1c){this.source=(_1c!=null)?_1c:"search";this._Load(_1b);if(_1b.advancefeatureid>0){this.tabControl.selectChild(this.advanceView);}else{if(this.ctrldata.outletid){if(ttl.data.utilities.isIndividual(this.ctrldata.outlettypeid)===false){if(this.movetab==true){this.tabControl.selectChild(this.contactView);this.movetab=false;}}}}},ClearEvent:function(_1d){this.Clear(_1d);},RefreshEvent:function(){if(this.ctrldata.outletid>0){this._SetMainView();this.loadEmployee();}},resize:function(){this.borderCtrl.resize(arguments[0]);this.inherited(arguments);},ViewChangedEvent:function(_1e){if(_1e==null||_1e=="outlet_view"){if(this.ctrldata.outletid){if(ttl.data.utilities.isIndividual(this.ctrldata.outlettypeid)===false){this.tabControl.selectChild(this.contactView);}else{this.tabControl.selectChild(this.mainView);}}}else{if(_1e=="advance_view"){this.tabControl.selectChild(this.advanceView);}}},_check_outlet_call:function(_1f){if(_1f.has_advancefeatures!=null&&_1f.has_advancefeatures!=undefined){if(PRMAX.utils.settings.advancefeatures){if(_1f.has_advancefeatures==true){dojo.style(this.advanceTabButton.domNode,"display","");this.advancectrl.Load(this.ctrldata.outletid,this.ctrldata.advancefeatureid);}else{if(this.tabControl.selectedChildWidget==this.advanceView){this.tabControl.selectChild(this.contactView);}dojo.style(this.advanceTabButton.domNode,"display","none");}}}}});}