/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.crm.viewer"]){dojo._hasResource["prmax.crm.viewer"]=true;dojo.provide("prmax.crm.viewer");dojo.declare("prmax.crm.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div dojoAttachPoint=\"borderControl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" gutters=\"false\" >\r\n\t\t<div dojoType=\"dijit.layout.ContentPane\" dojoAttachPoint=\"controls\" region=\"top\" style=\"height:42px;width:100%;overflow:hidden\">\r\n\t\t\t<button dojotype=\"dijit.form.Button\" label=\"Add Note\" dojoAttachEvent=\"onClick:_AddNoteShow\"></button>\r\n\t\t\tFilter By <select class=\"prmaxrequired\" name=\"contacthistorysourceid\" autoComplete=\"true\" searchAttr=\"name\" dojoType=\"dijit.form.FilteringSelect\" required=\"true\" invalidMessage=\"Please Select Contact History Type\" labelType=\"html\" dojoAttachPoint=\"contacthistorysourceid\"></select>\r\n\t\t\t<button dojotype=\"dijit.form.Button\" label=\"Filter\" dojoAttachEvent=\"onClick:_Filter\"></button>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\"   style=\"width:100%\" region=\"center\"  splitter=\"true\">\r\n\t\t\t<div dojoAttachPoint=\"viewer_grid\" dojoType=\"dojox.grid.DataGrid\"   query=\"{ }\" rowsPerPage=\"30\" style=\"width:100%;height:100%\" ></div>\r\n\t\t</div>\r\n\t\t<div dojotype=\"dijit.layout.ContentPane\"   style=\"width:100%;height:30%\" class=\"scrollpanel\" region=\"bottom\"  splitter=\"true\">\r\n\t\t\t<div dojoAttachPoint=\"view_details\" dojotype=\"prmax.crm.ViewContact\" class=\"scrollpanel\" isdelete=\"true\"  isedit=\"true\" style=\"width:100%;height:100%\"></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div dojoAttachPoint=\"addctrl\" dojoType=\"dijit.Dialog\" title=\"Add Contact Note\">\r\n\t\t<div dojoAttachPoint=\"addctrl1\" dojotype=\"prmax.crm.AddContact\" showclose=\"true\" style=\"width:600px;height:300px\"></div>\r\n\t</div>\r\n</div>\r\n",contacthistorysourceid_default:-1,taskview:false,constructor:function(){this._SetContactNoteCallBack=dojo.hitch(this,this._SetContactNoteCall);this._customerid=-2;this._taskid=null;dojo.subscribe(PRCOMMON.Events.Dialog_Close,dojo.hitch(this,this._DialogCloseEvent));dojo.subscribe(PRCOMMON.Events.Crm_Note_Add,dojo.hitch(this,this._AddNoteEvent));dojo.subscribe(PRCOMMON.Events.Crm_Note_Update,dojo.hitch(this,this._UpdateNoteEvent));dojo.subscribe(PRCOMMON.Events.Crm_Note_Delete,dojo.hitch(this,this._DeleteNoteEvent));this.filter_db=new prcommon.data.QueryWriteStore({url:"/crm/filter",nocallback:true,onError:ttl.utilities.globalerrorchecker});},view:{cells:[[{name:"Date",width:"120px",field:"taken_display"},{name:"Subject",width:"auto",field:"subject"},{name:"Source Type",width:"auto",field:"contacthistorydescription"},{name:"Source",width:"auto",field:"source"}]]},view2:{cells:[[{name:"Date",width:"120px",field:"taken_display"},{name:"Subject",width:"auto",field:"subject"}]]},postCreate:function(){this.contacthistorysourceid.store=PRCOMMON.utils.stores.ContactHistoryTypes(true);this.contacthistorysourceid.set("value",this.contacthistorysourceid_default);if(this.taskview){this.viewer_grid.set("structure",this.view2);dojo.addClass(this.controls.domNode,"prmaxhidden");}else{this.viewer_grid.set("structure",this.view);}this.viewer_grid._setStore(this.filter_db);this.viewer_grid.onRowClick=dojo.hitch(this,this.onSelectRow);this.viewer_grid.onStyleRow=dojo.hitch(this,this.onStyleRow);this.inherited(arguments);},onStyleRow:function(_1){ttl.GridHelpers.onStyleRow(_1);},onSelectRow:function(e){var _2=this.viewer_grid.getItem(e.rowIndex);this.view_details.Load(_2.i.contacthistoryid);this.viewer_grid.selection.clickSelectEvent(e);},_Filter:function(){var _3={contacthistorysourceid:this.contacthistorysourceid.get("value"),icustomerid:this._customerid};if(this._taskid){_3["taskid"]=this._taskid;}this.viewer_grid.setQuery(ttl.utilities.getPreventCache(_3));},_AddNoteShow:function(){this.addctrl.show();},LoadControls:function(_4,_5,_6,_7,_8){this._customerid=_7;this.addctrl1.LoadControls(_4,_5,_6,_7,_8);this.view_details.Clear();if(this._customerid!=null&&this.contacthistorysourceid_default!=-1){this.addctrl1.set("contacthistorysourceid_default",this.contacthistorysourceid_default);this._Filter();}this.refresh();},refresh:function(){this._Filter();},resize:function(){this.borderControl.resize(arguments[0]);this.inherited(arguments);},_DialogCloseEvent:function(_9){if(_9=="add_contact"){this.addctrl.hide();}},_AddNoteEvent:function(_a){this.filter_db.newItem(_a);},_SetContactNoteCall:function(){this._row=arguments[0];},_UpdateNoteEvent:function(_b){this._row=null;var _c={identity:_b.contacthistoryid,onItem:this._SetContactNoteCallBack};this.filter_db.fetchItemByIdentity(_c);if(this._row){this.filter_db.setValue(this._row,"subject",_b.subject,true);this.filter_db.setValue(this._row,"contacthistorydescription",_b.contacthistorydescription,true);}},_DeleteNoteEvent:function(_d){this._row=null;var _e={identity:_d,onItem:this._SetContactNoteCallBack};this.filter_db.fetchItemByIdentity(_e);if(this._row){this.filter_db.deleteItem(this._row);}}});}