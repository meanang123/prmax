/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.email.wordtohtml"]){dojo._hasResource["prmax.email.wordtohtml"]=true;dojo.provide("prmax.email.wordtohtml");dojo.require("ttl.BaseWidget");dojo.declare("prmax.email.wordtohtml",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<form  dojoAttachPoint=\"wordtohtml_form\" method=\"post\" name=\"wordtohtml_form\" enctype=\"multipart/form-data\"  onSubmit=\"return false;\">\r\n\t\t<input class=\"prmaxinput\" type=\"hidden\" dojoAttachPoint=\"wordtohtml_cache\" name=\"wordtohtml_cache\" value=\"-1\">\r\n\t\t<input class=\"prmaxinput\" type=\"hidden\" dojoAttachPoint=\"emailtemplateid\" name=\"emailtemplateid\" value=\"-1\">\r\n\t\t<br/>\r\n\t\t<table width=\"99%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" border = \"0\">\r\n\t\t\t<tr><td width=\"10%\" align=\"right\" nowrap class=\"prmaxrowtag\" data-dojo-attach-point=\"subject_label\">Release Title/Subject</td><td width=\"90%\"><input style=\"width:95%\" type=\"text\" dojoAttachPoint=\"subject\" size=\"80\" maxlength=\"80\" dojoType=\"dijit.form.ValidationTextBox\" required=\"true\" trim=\"true\"/></td></tr>\r\n\t\t\t<tr><td colspan=\"2\"class=\"prmaxrowtag\" data-dojo-attach-point=\"uploadrelease_mgs\">Please enter the Title of your Press Release (which will become the Subject for the email as seen by Journalists).</td></tr>\r\n\t\t\t<tr><td  >&nbsp;</td></tr>\r\n\t\t\t<tr><td width=\"10%\" aling=\"right\" class=\"prmaxrowtag\" data-dojo-attach-point=\"doc_label\">Release Document</td><td width=\"90%\" ><input style=\"width:100%\" size=\"30\" class=\"prmaxinput\" type=\"file\" dojoAttachPoint=\"wordtohtml_file\" name=\"wordtohtml_file\"></td></tr>\r\n\t\t\t<tr><td  >&nbsp;</td></tr>\r\n\t\t\t<tr><td colspan=\"2\"><p  class=\"prmaxrowtag\">The following file types can be uploaded .doc, .docx .txt, .htm and.html.  Upload may take a few minutes.</p></td></tr>\r\n\t\t\t<tr><td colspan=\"2\" align=\"right\"><button class=\"prmaxbutton\"  dojoAttachPoint=\"saveNode\" type=\"button\"  dojoType=\"dijit.form.Button\" label=\"Upload Document\" dojoAttachEvent=\"onClick:_Add\"></button></td></tr>\r\n\t\t\t<tr><td >\r\n\t\t\t\t<div dojoAttachPoint=\"progressNode\" style=\"display:none;\">\r\n\t\t\t\t\t<p>Uploading started. Please wait as this may take several minutes</p>\r\n\t\t\t\t\t<div dojoType=\"dijit.ProgressBar\" dojoAttachPoint=\"downloadProgress\" style=\"width:200px\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</td></tr>\r\n\t\t</table>\r\n\t</form>\r\n</div>\r\n",sourcename:"sendrelease",constructor:function(){this._AddedCallback=dojo.hitch(this,this._Added);this.maximum=100;this._current=1;this._OnGetStatusCallBack=dojo.hitch(this,this._GetReportBuildStatus);this._OnStatusCallBack=dojo.hitch(this,this._OnStatusCall);this._ErrorCallBack=dojo.hitch(this,this._Error);this._mswordqueueid=null;dojo.subscribe("/update/distribution_label",dojo.hitch(this,this._UpdateDistributionLabelEvent));},Load:function(_1,_2,_3){dojo.attr(this.emailtemplateid,"value",_3);this.subject.set("value",_1);try{dojo.attr(this.wordtohtml_file,"value",_2==null?"":_2);}catch(e){}},_Clear:function(){this.progressNode.style.display="none";this._mswordqueueid=-1;this._current=1;this.saveNode.set("disabled",false);},_Added:function(_4){if(_4.success=="OK"){if(_4.data.statusid==2){this._mswordqueueid=_4.mswordqueueid;this._Wait();}else{this._mswordqueueid=_4.mswordqueueid;this._current=2;this.downloadProgress.update({maximum:this.maximum,progress:this._current});this._Wait();}}else{if(_4.success=="FA"){alert(_4.message);this._Clear();}else{alert("Problem Converting Document");this._Clear();}}},_Add:function(){if(this.wordtohtml_file.value.length==0){this.wordtohtml_file.focus();return;}if(this.wordtohtml_file.value.indexOf(",")!=-1){alert("Please rename the file remove commas");this.wordtohtml_file.focus();return;}var _5=this.wordtohtml_file.value;var _6=_5.substring(_5.lastIndexOf(".")+1);if(_6!="doc"&&_6!="docx"&&_6!="DOC"&&_6!="DOCX"&&_6!="txt"&&_6!="TXT"&&_6!="html"&&_6!="htm"&&_6!="HTML"&&_6!="HTM"){alert("Upload doc, docx html, html and txt files only");this.wordtohtml_file.focus();return;}this.saveNode.set("disabled",true);this.wordtohtml_cache.value=new Date().valueOf();this.progressNode.style.display="block";this.downloadProgress.update({maximum:this.maximum,progress:this._current});dojo.io.iframe.send({url:"/emails/wordtohtml_add",handleAs:"json",load:this._AddedCallback,form:this.wordtohtml_form,error:this._ErrorCallBack});},_Error:function(_7,_8){alert("Problem Converting Document");this._Clear();},_Wait:function(){if(this._mswordqueueid==-1){this.Stop();}else{++this._current;if(this._current>this.maximum){this._current=1;}this.downloadProgress.update({maximum:this.maximum,progress:this._current});setTimeout(this._OnGetStatusCallBack,2000);}},_OnStatusCall:function(_9){if(_9.success=="OK"){if(_9.data.statusid==0||_9.data.statusid==1){this._Wait();}else{try{dojo.publish(PRCOMMON.Events.Word_Html_Data,[{html:_9.data.html,sourcename:this.sourcename}]);}catch(e){alert(e);}alert("Upload Completed");this._Clear();}}else{this.Stop();}},Stop:function(){this._Clear();},Clear:function(){this._Clear();},_GetReportBuildStatus:function(){if(this._mswordqueueid!=-1){if(this._current%2==0){dojo.xhrPost(ttl.utilities.makeParams({load:this._OnStatusCallBack,url:"/emails/mswordtohtml_status",content:{mswordqueueid:this._mswordqueueid}}));}else{this._Wait();}}},_getSubjectAttr:function(){return this.subject.get("value");},_getDocumentAttr:function(){return this.wordtohtml_file.value;},postCreate:function(){this.inherited(arguments);if(PRMAX.utils.settings.has_e_e_s==true){this.subject.set("maxLength",255);}dojo.attr(this.subject_label,"innerHTML",PRMAX.utils.settings.distribution_description+" Title/Subject");dojo.attr(this.uploadrelease_mgs,"innerHTML","Please enter the Title of your "+PRMAX.utils.settings.distribution_description+" (which will become the Subject for the email as seen by Journalists).");dojo.attr(this.doc_label,"innerHTML",PRMAX.utils.settings.distribution_description+" Document");},_UpdateDistributionLabelEvent:function(){dojo.attr(this.subject_label,"innerHTML",PRMAX.utils.settings.distribution_description+" Title/Subject");dojo.attr(this.uploadrelease_mgs,"innerHTML","Please enter the Title of your "+PRMAX.utils.settings.distribution_description+" (which will become the Subject for the email as seen by Journalists).");dojo.attr(this.doc_label,"innerHTML",PRMAX.utils.settings.distribution_description+" Document");}});}