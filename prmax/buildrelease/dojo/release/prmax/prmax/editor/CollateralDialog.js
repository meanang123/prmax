/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prmax.editor.CollateralDialog"]){dojo._hasResource["prmax.editor.CollateralDialog"]=true;dojo.provide("prmax.editor.CollateralDialog");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit._editor._Plugin");dojo.require("dijit.TooltipDialog");dojo.require("dijit.form.Button");dojo.require("dijit.form.ValidationTextBox");dojo.require("dojo.string");dojo.provide("prmax.collateral.adddialog");dojo.declare("prmax.editor._CollateralButton",[dijit._Widget,dijit._Templated],{label:"",widgetsInTemplate:true,plainText:false,templateString:"<span style='white-space: nowrap' class='dijit dijitReset dijitInline'>"+"<label class='dijitLeft dijitInline' for='${selectId}'>${label}</label>"+"<input dojoType='dijit.form.FilteringSelect' required=false labelType=html labelAttr=collateralcode searchAttr=collateralcode "+"tabIndex='-1' id='${selectId}' dojoAttachPoint='select' value='' style='width:150px'/>"+"<input class=\"dijitLeft dijitInline\" id=\"${add_dialog_btn}\" dojoType=\"dijit.form.ToggleButton\" iconClass=\"fa fa-plus\" showLabel=\"false\" label=\"Add Collateral\" dojoAttachPoint=\"add_btn\">"+"</span>",postMixInProperties:function(){this.inherited(arguments);this.label="Collateral";this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.selectId=this.id+"_select";this.add_dialog_btn=this.id+"+add_btn";this.inherited(arguments);},postCreate:function(){this._emailtemplatedid=-1;this.select.store=new dojox.data.QueryReadStore({url:"/icollateral/collateral_list?emailtemplateid="+this._emailtemplatedid,onError:ttl.utilities.globalerrorchecker});this.select.set("value","",false);this.disabled=this.select.get("disabled");},_add_collateral_event:function(_1){this.add_dialog.hide();this.select.set("value",_1.collateralid,false);},_getValueAttr:function(){return this.select.get("value");},focus:function(){this.select.focus();},_setDisabledAttr:function(_2){this.disabled=_2;this.select.set("disabled",_2);},_setEmailTemplateIdAttr:function(_3){this._emailtemplatedid=_3;this.select.store=new dojox.data.QueryReadStore({url:"/icollateral/collateral_list?emailtemplateid="+this._emailtemplatedid,onError:ttl.utilities.globalerrorchecker});}});dojo.declare("prmax.editor.CollateralDialog",dijit._editor._Plugin,{useDefaultCommand:false,_initButton:function(){params=this.params;if(this.params.custom){params.values=this.params.custom;}this.button=new prmax.editor._CollateralButton(params);this.connect(this.button.add_btn,"onChange",function(){this.button.add_dialog.show();});this.connect(this.button.select,"onChange",function(_4){if(_4==""){return;}this.editor.focus();this.editor.execCommand(this.command,_4);var _5={identity:_4,onItem:dojo.hitch(this,function(){this.tmp_row=arguments[0].i;})};this.button.select.store.fetchItemByIdentity(_5);var _6={urlInput:PRMAX.utils.settings.collateralurl,collateralid:this.tmp_row.collateralid,collateralname:this.tmp_row.collateralname,ext:this.tmp_row.ext};var _7="";var _8=this.tmp_row.ext.toLowerCase();if(_8==".jpg"||_8==".gif"||_8==".bmp"||_8==".tif"||_8==".tiff"||_8==".jpeg"||_8==".png"){var _9=true;if(confirm("To add as a link press OK\nTo add as an image press Cancel?")){_9=false;}if(_9){_7="<img src='${urlInput}/${collateralid}${ext}'></img>";}else{_7="<a href='${urlInput}/${collateralid}${ext}'>${collateralname}</a>";}}else{_7="<a href='${urlInput}/${collateralid}${ext}'>${collateralname}</a>";}this.editor.execCommand("inserthtml",dojo.string.substitute(_7,_6));this.button.select.set("value","");});this.button.add_dialog=new prmax.collateral.adddialog(params);dojo.subscribe(PRCOMMON.Events.Collateral_Add,dojo.hitch(this.button,this.button._add_collateral_event));},updateState:function(){var _a=this.editor;var _b=this.command;if(!_a||!_a.isLoaded||!_b.length){return;}if(this.button){var _c;try{_c=_a.queryCommandValue(_b)||"";}catch(e){_c="";}var _d=dojo.isString(_c)&&_c.match(/'([^']*)'/);if(_d){_c=_d[1];}if(!_c&&_b==="formatBlock"){var _e;var _f=dijit.range.getSelection(this.editor.window);if(_f&&_f.rangeCount>0){var _10=_f.getRangeAt(0);if(_10){_e=_10.endContainer;}}while(_e&&_e!==_a.editNode&&_e!==_a.document){var tg=_e.tagName?_e.tagName.toLowerCase():"";if(tg&&dojo.indexOf(this.button.values,tg)>-1){_c=tg;break;}_e=_e.parentNode;}}if(_c!==this.button.get("value")){this.button.set("value",_c,false);}}},_setEmailTemplateIdAttr:function(_11){this.button.set("EmailTemplateId",_11);}});dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(o){if(o.plugin){return;}switch(o.args.name){case "insertCollateral":o.plugin=new prmax.editor.CollateralDialog({command:o.args.name});PRMAX.utils.fieldControl["collateral"]=o.plugin;}});}