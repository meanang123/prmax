/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.documents.upload"]){dojo._hasResource["prcommon.documents.upload"]=true;dojo.provide("prcommon.documents.upload");dojo.require("ttl.BaseWidget");dojo.require("dijit.ProgressBar");dojo.require("dijit.form.Button");dojo.require("dojo.io.iframe");dojo.declare("prcommon.documents.upload",[ttl.BaseWidget],{widgetsInTemplate:true,sourcename:"response",templateString:"<div>\r\n\t<form data-dojo-attach-point=\"wordtohtml_form\" method=\"post\" name=\"wordtohtml_form\" enctype=\"multipart/form-data\"  onSubmit=\"return false;\" style=\"margin:5px\">\r\n\t\t<input class=\"prmaxinput\" type=\"hidden\" data-dojo-attach-point=\"wordtohtml_cache\" name=\"wordtohtml_cache\" value=\"-1\">\r\n\t\t<input class=\"prmaxinput\" type=\"hidden\" data-dojo-attach-point=\"emailtemplateid\" name=\"emailtemplateid\" value=\"-1\">\r\n\t\t<input class=\"prmaxinput\" type=\"hidden\" data-dojo-attach-point=\"exclude_images\" name=\"exclude_images\" value=\"true\">\r\n\t\t<br/>\r\n\t\t<table width=\"99%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" border = \"0\">\r\n\t\t\t<tr><td width=\"20%\" align=\"right\" class=\"prmaxrowtag\">File Name: </td><td width=\"90%\" ><input style=\"width:100%\" size=\"30\" class=\"prmaxinput\" type=\"file\" data-dojo-attach-point=\"wordtohtml_file\" name=\"wordtohtml_file\"></td></tr>\r\n\t\t\t<tr><td  >&nbsp;</td></tr>\r\n\t\t\t<tr><td colspan=\"2\"><p  class=\"prmaxrowtag\">The following file types can be uploaded .doc, .docx .txt, .htm and.html. Upload may take a few minutes.</p></td></tr>\r\n\t\t\t<tr><td colspan=\"2\" align=\"right\"><button data-dojo-attach-point=\"saveNode\" data-dojo-props='type:\"button\",\"class\":\"prmaxbutton\",label:\"Upload Document\"' data-dojo-type=\"dijit.form.Button\" data-dojo-attach-event=\"onClick:_Add\"></button></td></tr>\r\n\t\t\t<tr><td  >&nbsp;</td></tr>\r\n\t\t\t<tr><td colspan=\"2\" >\r\n\t\t\t\t<div data-dojo-attach-point=\"progressNode\" style=\"display:none;\">\r\n\t\t\t\t\t<p>Uploading started. Please wait as this may take several minutes</p>\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.ProgressBar\" data-dojo-attach-point=\"downloadProgress\" data-dojo-props='style:\"width:200px\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t</td></tr>\r\n\t\t</table>\r\n\t</form>\r\n</div>\r\n",constructor:function(){this._AddedCallback=dojo.hitch(this,this._Added);this.maximum=100;this._current=1;this._OnGetStatusCallBack=dojo.hitch(this,this._GetReportBuildStatus);this._OnStatusCallBack=dojo.hitch(this,this._OnStatusCall);this._ErrorCallBack=dojo.hitch(this,this._Error);this._mswordqueueid=null;},Load:function(_1){this._dialog=_1;},_Clear:function(){this.progressNode.style.display="none";this._mswordqueueid=-1;this._current=1;this.saveNode.set("disabled",false);this._dialog.hide();},_Added:function(_2){if(_2.success=="OK"){if(_2.data.statusid==2){this._mswordqueueid=_2.mswordqueueid;this._Wait();}else{this._mswordqueueid=_2.mswordqueueid;this._current=2;this.downloadProgress.update({maximum:this.maximum,progress:this._current});this._Wait();}}else{if(_2.success=="FA"){alert(_2.message);this._Clear();}else{alert("Problem Converting Document");this._Clear();}}},_Add:function(){if(this.wordtohtml_file.value.length==0){this.wordtohtml_file.focus();return;}var _3=this.wordtohtml_file.value;var _4=_3.substring(_3.lastIndexOf(".")+1);if(_4!="doc"&&_4!="docx"&&_4!="DOC"&&_4!="DOCX"&&_4!="txt"&&_4!="TXT"&&_4!="html"&&_4!="htm"&&_4!="HTML"&&_4!="HTM"){alert("Upload doc, docx html, html and txt files only");this.wordtohtml_file.focus();return;}this.saveNode.set("disabled",true);this.wordtohtml_cache.value=new Date().valueOf();this.progressNode.style.display="block";this.downloadProgress.update({maximum:this.maximum,progress:this._current});dojo.io.iframe.send({url:"/emails/wordtohtml_add_exclude_images",handleAs:"json",load:this._AddedCallback,form:this.wordtohtml_form,error:this._ErrorCallBack});},_Error:function(_5,_6){alert("Problem Converting Document");this._Clear();},_Wait:function(){if(this._mswordqueueid==-1){this.Stop();}else{++this._current;if(this._current>this.maximum){this._current=1;}this.downloadProgress.update({maximum:this.maximum,progress:this._current});setTimeout(this._OnGetStatusCallBack,2000);}},_OnStatusCall:function(_7){if(_7.success=="OK"){if(_7.data.statusid==0||_7.data.statusid==1){this._Wait();}else{try{dojo.publish(PRCOMMON.Events.Word_Html_Data,[{html:_7.data.html,sourcename:this.sourcename}]);}catch(e){}alert("Upload Completed");this._Clear();}}else{this.Stop();}},Stop:function(){this._Clear();},Clear:function(){this._Clear();},_GetReportBuildStatus:function(){if(this._mswordqueueid!=-1){if(this._current%2==0){dojo.xhrPost(ttl.utilities.makeParams({load:this._OnStatusCallBack,url:"/emails/mswordtohtml_status",content:{mswordqueueid:this._mswordqueueid}}));}else{this._Wait();}}},_getSubjectAttr:function(){return this.subject.get("value");},_getDocumentAttr:function(){return this.wordtohtml_file.value;}});}