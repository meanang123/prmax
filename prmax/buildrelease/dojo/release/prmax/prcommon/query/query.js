/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.query.query"]){dojo._hasResource["prcommon.query.query"]=true;dojo.provide("prcommon.query.query");dojo.require("ttl.BaseWidget");dojo.require("dijit.Menu");dojo.require("dijit.MenuBar");dojo.require("dijit.MenuBarItem");dojo.require("dijit.PopupMenuBarItem");dojo.require("dijit.form.CheckBox");dojo.declare("prcommon.query.query",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div >\r\n\t<div dojoAttachPoint=\"borderControl\" dojotype=\"dijit.layout.BorderContainer\" style=\"width:100%;height:100%\" >\r\n\t\t<div dojotype=\"dijit.layout.BorderContainer\" region=\"center\">\r\n\t\t\t<div dojotype=\"dijit.layout.ContentPane\" region=\"top\" style=\"width:100%;height:240px\">\r\n\t\t\t\t<textarea name = \"query_text\" style=\"width:100%\" rows=9 class=\"prmaxdefault\" dojoAttachPoint=\"query_text\"></textarea>\r\n\t\t\t\t<table cellpadding=\"0\" cellpadding=\"0\" width=\"100%\">\r\n\t\t\t\t\t<tr><td><button dojoAttachPoint=\"execute_button\" dojoType=\"dojox.form.BusyButton\" dojoAttachEvent=\"onClick:_Execute\" busyLabel=\"Wait Executing\">Execute</button></td>\r\n\t\t\t\t<td>\r\n\t\t\t\t\t<form dojoAttachPoint=\"to_excel_form\" target=\"_newtab\" method=\"post\" action=\"/query/to_excel\" dojoAttachEvent=\"onsubmit:_To_Excel\" >\r\n\t\t\t\t\t\t<input type=\"hidden\"  dojoAttachPoint=\"query_text_to_excel\" name = \"query_text\" dojoType=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t\t<input type=\"hidden\"  dojoAttachPoint=\"tmp_to_excel\" name = \"tmp_cache\" dojoType=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t<button type=\"submit\" dojoType=\"dijit.form.Button\" label=\"To Excel\" ></button>\r\n\t\t\t\t</form></td>\r\n\t\t\t\t<td align=\"right\">Visible to Research</td><td><input name=\"visibletoresearch\" type=\"checkbox\" dojoAttachPoint=\"visibletoresearch\"  dojotype=\"dijit.form.CheckBox\" dojoAttachEvent=\"onClick:_VisibleToResearch\" /></td>\r\n\t\t\t\t<td align=\"right\"><button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_Save\">Save As</button><select dojoAttachPoint=\"select\" dojotype =\"dijit.form.FilteringSelect\"  searchAttr=\"subject\" labelType=\"html\" ></select><button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:_Load\">Load</button></td></tr></table>\r\n\t\t\t\t<br/>\r\n\t\t\t</div>\r\n\t\t\t<div dojotype=\"dijit.layout.ContentPane\" region=\"center\" dojoAttachPoint=\"result_view\">\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t<div dojoAttachPoint=\"savedlg\" dojotype=\"dijit.Dialog\" style=\"width:300px;height:200px\" title=\"Save Query\">\r\n\t\t<div class=\"dijitDialogPaneContentArea\">\r\n\t\t\t<form class=\"prmaxdefault\" dojoAttachPoint=\"formNode\" dojoType=\"dijit.form.Form\" onSubmit=\"return false\">\r\n\t\t\t\t<table style=\"width:100%;border-collapse:collapse;\" cellspacing=\"1\" cellpadding=\"1\" border=\"0\">\r\n\t\t\t\t<tr><td class=\"prmaxrowtag\">Subject</td><td><input style=\"float:left\" name=\"subject\" type=\"text\" dojoAttachPoint=\"subject_name\"  dojoType=\"dijit.form.ValidationTextBox\" trim=\"true\" required=\"true\"/></td></tr>\r\n\t\t\t\t</table>\r\n\t\t\t</form>\r\n\t\t</div>\r\n\t\t<div class=\"dijitDialogPaneActionBar\">\r\n\t\t\t\t<button dojoType=\"dijit.form.Button\" type=\"button\" dojoAttachEvent=\"onClick:_Query_Save\" style=\"float:left\">OK</button>\r\n\t\t\t\t<button dojoType=\"dijit.form.Button\" type=\"button\" dojoAttachEvent=\"onClick:_CancelDialog\" style=\"float:right\">Cancel</button>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n",constructor:function(){this._QueryCallBack=dojo.hitch(this,this._QueryCall);this._QueryLoadCallBack=dojo.hitch(this,this._QueryLoadCall);this._QuerySaveCallBack=dojo.hitch(this,this._QuerySaveCall);this._QueryUpdateCallBack=dojo.hitch(this,this._QueryUpdateCall);this.queries=new dojox.data.QueryReadStore({url:"/query/queries",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});},postCreate:function(){this.select.store=this.queries;this.inherited(arguments);},resize:function(){this.borderControl.resize(arguments);this.inherited(arguments);},_QueryCall:function(_1){if(_1.success=="OK"){this.result_view.setContent(_1.data);}else{alert("problem");}this.execute_button.cancel();},_Execute:function(){var _2=dojo.attr(this.query_text,"value");dojo.xhrPost(ttl.utilities.makeParams({load:this._QueryCallBack,url:"/query/execute",content:{query_text:_2}}));},_QueryLoadCall:function(_3){if(_3.success=="OK"){dojo.attr(this.query_text,"value",_3.data.query_text);this.visibletoresearch.set("value",_3.data.typeid);}else{alert("problem");}},_Load:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._QueryLoadCallBack,url:"/query/load",content:{queryhistoryid:this.select.get("value")}}));},_Save:function(){var _4=dojo.attr(this.query_text,"value");if(_4.length>0){this.savedlg.show();}},_CancelDialog:function(){this.savedlg.hide();},_QuerySaveCall:function(_5){if(_5.success=="OK"){alert("Query Saved");this._CancelDialog();}else{alert("problem");}},_Query_Save:function(){if(ttl.utilities.formValidator(this.formNode)==false){alert("Not all required field filled in");return;}var _6=dojo.attr(this.query_text,"value");dojo.xhrPost(ttl.utilities.makeParams({load:this._QuerySaveCallBack,url:"/query/save",content:{query_text:_6,subject:this.subject_name.get("value")}}));},_To_Excel:function(){this.query_text_to_excel.set("value",dojo.attr(this.query_text,"value"));this.tmp_to_excel.set("value",new Date());return true;},_VisibleToResearch:function(){var _7={};_7["queryhistoryid"]=this.select.get("value");_7["visibletoresearch"]=this.visibletoresearch.get("value");dojo.xhrPost(ttl.utilities.makeParams({load:this._QueryUpdateCallBack,url:"/query/toresearch",content:_7}));},_QueryUpdateCall:function(_8){if(_8.success=="OK"){alert("Query Updated");}else{alert("Problem");}},});}