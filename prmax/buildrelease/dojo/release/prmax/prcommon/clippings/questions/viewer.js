/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.clippings.questions.viewer"]){dojo._hasResource["prcommon.clippings.questions.viewer"]=true;dojo.provide("prcommon.clippings.questions.viewer");dojo.require("ttl.BaseWidget");dojo.require("dijit.Menu");dojo.require("dijit.MenuBar");dojo.require("dijit.MenuBarItem");dojo.require("dijit.PopupMenuBarItem");dojo.require("prcommon.clippings.questions.add");dojo.require("prcommon.clippings.questions.edit");dojo.declare("prcommon.clippings.questions.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"border_control\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-point='style:\"width:100%;height:100%\",gutters:false' >\r\n\t\t<span class=\"std_menu_view\">\r\n\t\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-attach-point=\"controls\" data-dojo-props='region:\"top\",style:\"height:38px;width:100%;padding:0x;margin:0px;overflow:hidden\",\"class\":\"std_menu_view\"'>\r\n\t\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"Create New Question\",iconClass:\"fa fa-line-chart fa-3x\"' data-dojo-attach-event=\"onClick:_new_question\"></button>\r\n\t\t\t</div>\r\n\t\t</span>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\"  data-dojo-props='region:\"center\",splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"viewer_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:30,style:\"width:100%;height:100%\"' ></div>\r\n\t\t</div>\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"details_view\" data-dojo-props='region:\"right\",splitter:true,style:\"width:50%;height:100%\"'>\r\n\t\t\t<div title=\"blank\" data-dojo-attach-point=\"blank\" data-dojo-type=\"dijit.layout.ContentPane\"></div>\r\n\t\t\t<div data-dojo-type=\"prcommon.clippings.questions.edit\" data-dojo-attach-point=\"edit_question_ctrl\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t</div>\r\n\t\t<div data-dojo-attach-point=\"add_new_question_dlg\" data-dojo-type=\"dijit.Dialog\"  data-dojo-props='title:\"Add New Question\",style:\"width:500px;height:460px\"'>\r\n\t\t\t<div data-dojo-type=\"prcommon.clippings.questions.add\" data-dojo-attach-point=\"add_new_question_ctrl\"></div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n",constructor:function(){this._questions=new dojox.data.JsonRestStore({target:"/clippings/questions/list_by_source",idAttribute:"questionid"});this._menu_item_std=null;this._menu_item_deleted=null;dojo.subscribe("/clippings/question/global",dojo.hitch(this,this._add_question_event));dojo.subscribe("/clippings/question/update",dojo.hitch(this,this._update_question_event));this._remove_question_call_back=dojo.hitch(this,this._remove_question_call);this._restore_question_call_back=dojo.hitch(this,this._restore_question_call);this._show_edit_call_back=dojo.hitch(this,this._show_edit);},view1:{noscroll:false,cells:[[{name:" ",styles:"text-align: center;",width:"15px",formatter:ttl.utilities.format_row_ctrl},{name:"Name",width:"250px",field:"questiontext"},{name:"Type",width:"100px",field:"questiondescription"},{name:"Scope",width:"100px",field:"scopetype"},{name:"Description",width:"100px",field:"scopename"},{name:"Status",width:"80px",field:"has_been_deleted"}]]},postCreate:function(){this.viewer_grid.set("structure",this.view1);this.viewer_grid._setStore(this._questions);this.viewer_grid["onRowClick"]=dojo.hitch(this,this._on_row_click);this.inherited(arguments);},_on_row_click:function(e){var _1=this.viewer_grid.getItem(event.rowIndex);if(_1){this._row=_1;if(this._row.has_been_deleted=="Deleted"){if(this._menu_item_deleted==null){this._menu_item_deleted=new dijit.Menu();this._menu_item_deleted.addChild(new dijit.MenuItem({label:"Restore",iconClass:"fa fa-undo",onClick:dojo.hitch(this,this._restore_question)}));}this._menu_item_deleted._openMyself(e);}else{if(this._menu_item_std==null){this._menu_item_std=new dijit.Menu();this._menu_item_std.addChild(new dijit.MenuItem({label:"Remove",iconClass:"fa fa-trash",onClick:dojo.hitch(this,this._remove_question)}));this._menu_item_std.addChild(new dijit.MenuItem({label:"Edit",iconClass:"fa fa-pencil-square-o",onClick:dojo.hitch(this,this._edit_question)}));}this._menu_item_std._openMyself(e);}}},_restore_question:function(){if(confirm("Restore "+this._row.questiontext+" from analysis?")){dojo.xhrPost(ttl.utilities.makeParams({load:this._restore_question_call_back,url:"/clippings/questions/restore_question",content:{questionid:this._row.questionid}}));}},_restore_question_call:function(_2){if(_2.success=="OK"){this._questions.setValue(this._row,"has_been_deleted","");this.details_view.selectChild(this.blank);}else{alert("Problem");}},_remove_question:function(){if(confirm("Remove "+this._row.questiontext+" from analysis?")){dojo.xhrPost(ttl.utilities.makeParams({load:this._remove_question_call_back,url:"/clippings/questions/remove_question",content:{questionid:this._row.questionid}}));}},_edit_question:function(){this.edit_question_ctrl.load(this._row.questionid,this._show_edit_call_back);},_show_edit:function(){this.details_view.selectChild(this.edit_question_ctrl);},_remove_question_call:function(_3){if(_3.success=="OK"){if(_3.msg){alert(_3.msg);this._questions.setValue(this._row,"has_been_deleted","Deleted");this.details_view.selectChild(this.blank);}else{this._questions.deleteItem(this._row);this.details_view.selectChild(this.blank);}}else{alert("Problem");}},resize:function(){this.border_control.resize(arguments[0]);},load:function(_4,_5){this.viewer_grid.setQuery(ttl.utilities.getPreventCache({sourcetypeid:_4}));},_new_question:function(){this.details_view.selectChild(this.blank);this.add_new_question_ctrl.clear();this.add_new_question_dlg.show();},_add_question_event:function(_6){this._questions.newItem(_6);this.add_new_question_dlg.hide();this.details_view.selectChild(this.blank);},_update_question_event:function(_7){this._questions.setValue(this._row,"questiontext",_7.questiontext);this._questions.setValue(this._row,"questiondescription",_7.questiondescription);this._questions.setValue(this._row,"scopetype",_7.scopetype);this._questions.setValue(this._row,"scopename",_7.scopename);this._questions.setValue(this._row,"has_been_deleted",_7.has_been_deleted);}});}