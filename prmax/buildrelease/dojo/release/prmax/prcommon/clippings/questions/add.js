/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.clippings.questions.add"]){dojo._hasResource["prcommon.clippings.questions.add"]=true;dojo.provide("prcommon.clippings.questions.add");dojo.require("ttl.BaseWidget");dojo.require("dijit.Menu");dojo.require("dijit.MenuBar");dojo.require("dijit.MenuBarItem");dojo.require("dijit.PopupMenuBarItem");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.NumberTextBox");dojo.require("dijit.form.CurrencyTextBox");dojo.require("dojo.store.Memory");dojo.require("dojo.data.ObjectStore");dojo.require("dojo.store.util.SimpleQueryEngine");dojo.declare("prcommon.clippings.questions.add",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-point='style:\"width:100%;height:100%\",gutters:false' >\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"wizard_pages\" data-dojo-props='region:\"center\"'>\r\n\t\t\t<div data-dojo-attach-point=\"page_start\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"margin:10px\", \"class\":\"common_prmax_layout\"'>\r\n\t\t\t\t<form data-dojo-attach-point=\"main_form\" data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t\t\t<h2>Question Details</h2>\r\n\t\t\t\t\t<hr/>\r\n\t\t\t\t\t<label class=\"label_1\">Name</label><input data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"questiontext\",type:\"text\",maxlength:80,trim:true,required:true,style:\"width:24em\",invalidMessage:\"Name cannot be Empty\"' data-dojo-attach-point=\"questiontext\" data-dojo-type=\"dijit.form.ValidationTextBox\"/><br/><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_is_text\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",checked:\"checked\",type:\"radio\",value:\"3\"'/>&nbsp;Text</label><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_yes_no\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"1\"'/>&nbsp;Yes/No</label><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_list\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"2\"'/>&nbsp;List</label><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_multiple\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"6\"'/>&nbsp;Multiple</label><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_numeric\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"4\"'/>&nbsp;Numeric</label><br/>\r\n\t\t\t\t\t<label class=\"label_1\"><input data-dojo-attach-point=\"question_currency\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"questiontypeid\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"5\"'/>&nbsp;Currency</label><br/>\r\n\t\t\t\t\t<br/><br/><br/><br/><br/><br/>\r\n\t\t\t\t\t<hr/>\r\n\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_next_page_start_page\" data-dojo-attach-point=\"_btn_start_page\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Next\",\"class\":\"btnright \"'></button><br/><br/>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-attach-point=\"page_answers\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"margin:10px\",\"class\":\"common_prmax_layout\"'>\r\n\t\t\t\t<h2>Answers</h2>\r\n\t\t\t\t<hr/>\r\n\t\t\t\t<button data-dojo-attach-event=\"onClick:_add_answer\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"New Answer\",\"class\":\"btnright\"'></button><br/>\r\n\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:350px;height:250px\"'>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"answer_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='rowsPerPage:30,style:\"width:100%;height:100%;\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<hr/>\r\n\t\t\t\t<button data-dojo-attach-event=\"onClick:_next_page_page_answers\" data-dojo-attach-point=\"_btn_page_answers_next\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Next\",\"class\":\"btnright \"'></button>\r\n\t\t\t\t<button data-dojo-attach-event=\"onClick:_prev_page_page_answers\" data-dojo-attach-point=\"_btn_page_answers_prev\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Prev\",\"class\":\"btnright \"'></button><br/><br/>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-attach-point=\"page_restrictions\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"margin:10px\",\"class\":\"common_prmax_layout\"'>\r\n\t\t\t\t<h2>Restrict Scope</h2>\r\n\t\t\t\t<hr/>\r\n\t\t\t\t<form data-dojo-attach-point=\"restrict_form\" data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"restrict_global_label_view\"><label class=\"label_2\"><input data-dojo-attach-point=\"restrict_global\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"restrict\",\"class\":\"prmaxdefault\",checked:\"checked\",type:\"radio\",value:\"1\"' data-dojo-attach-event='onChange:_change_restrict_view'/>&nbsp;No Restriction</label><br/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"restrict_client_label_view\"><label class=\"label_2\"><input data-dojo-attach-point=\"restrict_client\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"restrict\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"2\",style:\"float:left\"' data-dojo-attach-event='onChange:_change_restrict_view'/><p data-dojo-attach-point=\"client_label_1\" style=\"float:left\">Client</p></label><br/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"restrict_campaign_label_view\"><label class=\"label_2\"><input data-dojo-attach-point=\"restrict_campaign\" data-dojo-type=\"dijit.form.RadioButton\" data-dojo-props='name:\"restrict\",\"class\":\"prmaxdefault\",type:\"radio\",value:\"3\",style:\"float:left\"' data-dojo-attach-event='onChange:_change_restrict_view'/><p data-dojo-attach-point=\"issue_label_1\" style=\"float:left\">&nbsp;Issue</p></label><br/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"restrict_client_view\" class=\"prmaxhidden\"><label class=\"label_1\" data-dojo-attach-point=\"client_label_2\">Client</label><select data-dojo-props='name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\",required:false' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"restrict_issue_view\" class=\"prmaxhidden\"><label  data-dojo-attach-point=\"issue_label_2\" class=\"label_1\">Issue</label><select data-dojo-props='name:\"issueid\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"issueid\"></select></div>\r\n\t\t\t\t\t<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>\r\n\t\t\t\t\t<hr/>\r\n\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_next_page_restrict\" data-dojo-attach-point=\"_btn_page_restrict_next\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Next\",\"class\":\"btnright \"'></button>\r\n\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_prev_page_restrict\" data-dojo-attach-point=\"_btn_page_restrict_prev\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Prev\",\"class\":\"btnright \"'></button><br/><br/>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-attach-point=\"page_default\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"margin:10px\",\"class\":\"common_prmax_layout\"'>\r\n\t\t\t\t<h2>Default Answer</h2>\r\n\t\t\t\t<hr/>\r\n\t\t\t\t<form data-dojo-attach-point=\"default_form\" data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"default_text_view\" class=\"prmaxhidden\"><label class=\"label_1\">Text</label><input data-dojo-props='\"class\":\"prmaxinput\", name:\"default_answer_text\",type:\"text\",maxlength:80,trim:true,style:\"width:16em\"' data-dojo-attach-point=\"default_answer_text\" data-dojo-type=\"dijit.form.ValidationTextBox\"/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"default_list_view\" class=\"prmaxhidden\"><label class=\"label_1\">List</label><select data-dojo-props='\"class\":\"prmaxinput\", name:\"default_answer_answerid\",autoComplete:true,searchAttr:\"answertext\",required:false,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"default_answer_answerid\"></select></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"default_yes_no_view\" class=\"prmaxhidden\"><label class=\"label_1\">Yes/No</label><input data-dojo-props='name:\"default_answer_boolean\",type:\"checkbox\"' data-dojo-attach-point=\"default_answer_boolean\" data-dojo-type=\"dijit.form.CheckBox\"/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"default_numeric\" class=\"prmaxhidden\"><label class=\"label_1\">Number</label><input data-dojo-props='\"class\":\"prmaxinput\", name:\"default_answer_number\",type:\"text\",style:\"width:7em\",constraints:{min:0,max:999999999},value:\"0\"' data-dojo-attach-point=\"default_answer_number\" data-dojo-type=\"dijit.form.NumberTextBox\"/></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"default_currency_view\" class=\"prmaxhidden\"><label class=\"label_1\">Currency</label><input data-dojo-props='\"class\":\"prmaxinput\", name:\"default_answer_currency\",type:\"text\",style:\"width:8em\",constraints:{fractional:true,places:\"0,2\",min:0.00,max:999999.00},value:\"0.00\"' data-dojo-attach-point=\"default_answer_currency\" data-dojo-type=\"dijit.form.CurrencyTextBox\"/></div>\r\n\t\t\t\t\t<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>\r\n\t\t\t\t\t<hr/>\r\n\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_save\" data-dojo-attach-point=\"savebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Saving ...\",label:\"Save\",\"class\":\"btnright \"'></button>\r\n\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_prev_page_page_default\" data-dojo-attach-point=\"_btn_page_page_default\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Prev\",\"class\":\"btnright \"'></button><br/><br/>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"new_answer_dlg\" data-dojo-type=\"dijit.Dialog\"  data-dojo-props='title:\"New Answer\",style:\"width:500px;height:150px\"'>\r\n\t\t<form data-dojo-attach-point=\"add_answer_form\" data-dojo-props='onsubmit:\"return false\",\"class\":\"common_prmax_layout\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t<br/>\r\n\t\t\t<label class=\"label_1\">Text</label><input data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"answertext\",type:\"text\",maxlength:80,trim:true,required:true,style:\"width:20em\"' data-dojo-attach-point=\"answertext\" data-dojo-type=\"dijit.form.ValidationTextBox\"/><br/><br/>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Close\",\"class\":\"btnleft\"' data-dojo-attach-event=\"onClick:_close\"></button>\r\n\t\t\t<button data-dojo-attach-event=\"onClick:_add_answer_add\" data-dojo-attach-point=\"addanswerbtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Saving ...\",label:\"Add\",\"class\":\"btnright \"'></button>\r\n\t\t</form>\r\n\t</div>\r\n</div>\r\n\r\n\r\n",publish_path:"/clippings/question/global",globalonly:false,constructor:function(){this._save_call_back=dojo.hitch(this,this._save_call);this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._issues=new dojox.data.JsonRestStore({target:"/crm/issues/issues_list_rest",idAttribute:"id"});this._clientid=null;this._issueid=null;},postCreate:function(){this.inherited(arguments);this.clientid.set("store",this._clients);this.clientid.set("value","-1");this.issueid.set("store",this._issues);this.issueid.set("value","-1");this.answer_grid.set("structure",this.view);this._memorystore=dojo.store.Memory();this._store=dojo.data.ObjectStore({objectStore:this._memorystore});this.answer_grid._setStore(this._store);this.answer_grid.canSort=function(){return false;};this.answer_grid["onRowClick"]=dojo.hitch(this,this._on_row_click);this.default_answer_answerid.set("store",this._store);dojo.attr(this.issue_label_1,"innerHTML","&nbsp;"+PRMAX.utils.settings.issue_description);dojo.attr(this.issue_label_2,"innerHTML",PRMAX.utils.settings.issue_description);dojo.attr(this.client_label_1,"innerHTML","&nbsp;"+PRMAX.utils.settings.client_name);dojo.attr(this.client_label_2,"innerHTML",PRMAX.utils.settings.client_name);if(this.globalonly==true){dojo.addClass(this.restrict_client_label_view,"prmaxhidden");dojo.addClass(this.restrict_campaign_label_view,"prmaxhidden");this.restrict_global.set("checked",true);}},_on_row_click:function(e){var _1=this.answer_grid.getItem(event.rowIndex);if(_1&&confirm("Remove Answer")){this._store.deleteItem(_1);}},view:{cells:[[{name:"Answer Text",width:"auto",field:"answertext"},{name:" ",width:"20px",formatter:ttl.utilities.format_row_ctrl}]]},clear:function(){this.questiontext.set("value","");this.question_is_text.set("checked",true);this._memorystore=dojo.store.Memory();this._store=dojo.data.ObjectStore({objectStore:this._memorystore});this.answer_grid._setStore(this._store);this.answer_grid.setQuery(ttl.utilities.getPreventCache({}));this.savebtn.cancel();this.default_answer_answerid.set("store",this._store);this.restrict_global.set("checked",true);this.wizard_pages.selectChild(this.page_start);},load:function(_2,_3){this._clientid=_2;if(this._clientid!=null){this.restrict_client.set("checked",true);this.clientid.set("value",this._clientid);dojo.addClass(this.restrict_global_label_view,"prmaxhidden");dojo.addClass(this.restrict_campaign_label_view,"prmaxhidden");}this._issueid=_3;if(this._issueid!=null){this.restrict_campaign.set("checked",true);this.issueid.set("value",this._issueid);dojo.addClass(this.restrict_global_label_view,"prmaxhidden");dojo.addClass(this.restrict_client_label_view,"prmaxhidden");}},_next_page_start_page:function(){if(ttl.utilities.formValidator(this.main_form)==false){this.questiontext.focus();return;}if(this._has_multiple_answer()){this.wizard_pages.selectChild(this.page_answers);}else{this.wizard_pages.selectChild(this.page_restrictions);}},_next_page_page_answers:function(){this._store.save();if(this._memorystore.data.length<=0){alert("No Answers Specified");}else{this.wizard_pages.selectChild(this.page_restrictions);}},_prev_page_page_answers:function(){this.wizard_pages.selectChild(this.page_start);},_prev_page_page_default:function(){this.wizard_pages.selectChild(this.page_restrictions);},_next_page_restrict:function(){var _4=this.restrict_form.get("value")["restrict"];if(_4=="2"){var _5=this.clientid.get("value");if(_5==null||_5==""||_5=="-1"){alert("No Client Selected");this.clientid.focus();return;}}if(_4=="3"){var _5=this.issueid.get("value");if(_5==null||_5==""||_5=="-1"){alert("No Issue Selected");this.issueid.focus();return;}}this._show_default_selection();this.wizard_pages.selectChild(this.page_default);},_prev_page_restrict:function(){if(this._has_multiple_answer()){this.wizard_pages.selectChild(this.page_answers);}else{this.wizard_pages.selectChild(this.page_start);}},_save:function(){if(ttl.utilities.formValidator(this.main_form)==false){alert("Not all required field filled in");this.savebtn.cancel();return;}var _6=this.main_form.get("value");_6=dojo.mixin(_6,this.default_form.get("value"));_6=dojo.mixin(_6,this.restrict_form.get("value"));this._store.save();if(this._memorystore.data.length>0){var _7=new Array();for(var _8 in this._memorystore.data){_7.push({answertext:this._memorystore.data[_8].answertext,id:this._memorystore.data[_8].id});}_6["answers"]=dojo.toJson(_7);}dojo.xhrPost(ttl.utilities.makeParams({load:this._save_call_back,url:"/clippings/questions/add",content:_6}));},focus:function(){this.questiontext.focus();},resize:function(){this.frame.resize({w:500,h:500});},_has_multiple_answer:function(){if(this.question_list.get("checked")==true||this.question_multiple.get("checked")==true){return true;}else{return false;}},_show_default_selection:function(){var _9=this.main_form.get("value")["questiontypeid"];dojo.addClass(this.default_yes_no_view,"prmaxhidden");dojo.addClass(this.default_text_view,"prmaxhidden");dojo.addClass(this.default_numeric,"prmaxhidden");dojo.addClass(this.default_currency_view,"prmaxhidden");dojo.addClass(this.default_list_view,"prmaxhidden");switch(_9){case "1":dojo.removeClass(this.default_yes_no_view,"prmaxhidden");break;case "2":dojo.removeClass(this.default_list_view,"prmaxhidden");break;case "3":dojo.removeClass(this.default_text_view,"prmaxhidden");break;case "4":dojo.removeClass(this.default_numeric,"prmaxhidden");break;case "5":dojo.removeClass(this.default_currency_view,"prmaxhidden");break;case "6":break;}},_save_call:function(_a){if(_a.success=="OK"){dojo.publish(this.publish_path,[_a.data,this._clientid,this._issueid]);}else{if(_a.success=="DU"){alert("Already Exists");this.wizard_pages.selectChild(this.page_start);this.questiontext.focus();}else{alert("Problem Saving Question");}}this.savebtn.cancel();},_change_restrict_view:function(){var _b=this.restrict_form.get("value")["restrict"];switch(_b){case "1":dojo.addClass(this.restrict_client_view,"prmaxhidden");dojo.addClass(this.restrict_issue_view,"prmaxhidden");this.issueid.set("required",false);this.clientid.set("required",false);this.issueid.set("value",-1);this.clientid.set("required",-1);break;case "2":dojo.removeClass(this.restrict_client_view,"prmaxhidden");dojo.addClass(this.restrict_issue_view,"prmaxhidden");this.issueid.set("required",false);this.issueid.set("value",-1);this.clientid.set("required",true);break;case "3":dojo.addClass(this.restrict_client_view,"prmaxhidden");dojo.removeClass(this.restrict_issue_view,"prmaxhidden");this.issueid.set("required",true);this.clientid.set("required",false);this.clientid.set("value",-1);break;}},_add_answer:function(){this.new_answer_dlg.show();},_add_answer_add:function(){if(ttl.utilities.formValidator(this.add_answer_form)==false){alert("Not all required field filled in");this.addanswerbtn.cancel();return;}var _c=this.answertext.get("value");this._store.save();if(this._memorystore.data.length>0){for(var _d in this._memorystore.data){if(this._memorystore.data[_d].answertext==_c){alert("Answer Already Exists");this.addanswerbtn.cancel();this.answertext.focus();return;}}}this._store.newItem({id:PRCOMMON.utils.uuid.createUUID(),answertext:this.answertext.get("value")});this.new_answer_dlg.hide();this.addanswerbtn.cancel();this.answertext.set("value","");this._store.save();},_close:function(){this.new_answer_dlg.hide();}});}