/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.issues.update"]){dojo._hasResource["prcommon.crm.issues.update"]=true;dojo.provide("prcommon.crm.issues.update");dojo.require("prcommon.crm.solidsocial.viewercoverage");dojo.require("prcommon.clippings.questions.analysis_viewer");dojo.declare("prcommon.crm.issues.update",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='gutters:false,style:\"width:100%;height:100%\"' >\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"display_view\" data-dojo-props='region:\"center\"'>\r\n\t\t\t<div title=\"blank\" data-dojo-attach-point=\"blank\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='selected:\"selected\",style:\"width:100%;height:100%\"'></div>\r\n\t\t\t<div data-dojo-attach-point=\"tabcont\" data-dojo-type=\"dijit.layout.TabContainer\" data-dojo-props=\"region:'center',splitter:true,'class':'bordered'\">\r\n\t\t\t\t<div data-dojo-attach-point=\"details\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Details',style:'height:100%;width:500px;overflow :auto','class':'bordered scrollpane',selected:'selected'\">\r\n\t\t\t\t\t<span class=\"common_prmax_layout\">\r\n\t\t\t\t\t<form class=\"prmaxdefault\" data-dojo-attach-point=\"formnode\" data-dojo-type=\"dijit.form.Form\" onSubmit=\"return false\">\r\n\t\t\t\t\t\t<input data-dojo-props='name:\"issueid\",type:\"hidden\",value:\"-1\"' data-dojo-attach-point=\"issueid\" data-dojo-type=\"dijit.form.TextBox\"/><br/>\r\n\t\t\t\t\t\t<br/>\r\n\t\t\t\t\t\t<label class=\"label_1\">Title</label><input data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"name\",type:\"text\",maxlength:80,trim:true,required:true,style:\"width:20em\"' data-dojo-attach-point=\"issuename\" data-dojo-type=\"dijit.form.ValidationTextBox\"/><br/>\r\n\t\t\t\t\t\t<label class=\"label_1\">Document</label><select data-dojo-props='\"class\":\"prmaxinput\",name:\"documentid\",autoComplete:true,searchAttr:\"description\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"documentid\" ></select><br/>\r\n\t\t\t\t\t\t<label class=\"label_1\">Client</label><select data-dojo-props='\"class\":\"prmaxinput\",name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select><br/>\r\n\t\t\t\t\t\t<label data-dojo-attach-point=\"briefing_notes_label\">Briefing Notes</label><br/>\r\n\t\t\t\t\t\t<div class=\"stdframe\" style=\"height:250px;\" data-dojo-attach-point=\"notes_frame\"><textarea data-dojo-attach-point=\"briefingnotes\" data-dojo-props='\"class\":\"prmaxinput\",name:\"briefingnotes\",trim:true,required:true,style:\"width:99%;height:80%\"' data-dojo-type=\"dijit.form.Textarea\" ></textarea></div><br/>\r\n\t\t\t\t\t\t<label class=\"label_1\" data-dojo-attach-point=\"briefing_notes_status_label\">Notes Status</label><select data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"briefingnotesstatusid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Briefing Note Status\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"briefingnotesstatusid\" data-dojo-attach-event=\"onChange:_change_colour\"></select><br/>\r\n\t\t\t\t\t\t<label class=\"label_1\">Approved By</label><select data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"approvedbyid\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"approvedbyid\"></select><br/><br/>\r\n\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_delete_issue\" data-dojo-attach-point=\"deletebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Deleting ...\",label:\"Delete\",\"class\":\"btnleft\"'></button>\r\n\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_archive_issue\" data-dojo-attach-point=\"archivebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Archiving ...\",label:\"Archive\",\"class\":\"btnleft\"'></button>\r\n\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_update_issue\" data-dojo-attach-point=\"savebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Upating...\",label:\"Update\",\"class\":\"btnright\"'></button><br/><br/>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"history\"  data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props=\"title:'History',style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpanel'\">\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region: \"center\"'>\r\n\t\t\t\t\t\t<div data-dojo-attach-point=\"history_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:30,style:\"width:100%;height:100%\"' ></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"history_view_ctrl\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region: \"right\",style:\"width:70%;height:100%\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"engagements\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Engagements',style:'height:100%;width:100%;margin:0px;padding:0px;overflow :auto','class':'bordered scrollpanel'\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"engagements_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:30,style:\"width:100%;height:100%\"' ></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"coverage\" data-dojo-type=\"prcommon.crm.solidsocial.viewercoverage\" data-dojo-props=\"title:'Coverage',style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpanel'\"></div>\r\n\t\t\t\t<div data-dojo-attach-point=\"analysis_tab\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='title:\"Analysis\",gutters:false' >\r\n\t\t\t\t\t<div data-dojo-type=\"prcommon.clippings.questions.analysis_viewer\" data-dojo-props='region:\"center\",style:\"width:100%;height:100%\"' data-dojo-attach-point=\"analysis_ctrl\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n",history_view:"/crm/issues/history_view?issuehistoryid=${issuehistoryid}",constructor:function(){this._update_call_back=dojo.hitch(this,this._update_call);this._load_call_back=dojo.hitch(this,this._load_call);this._load_briefing_call_back=dojo.hitch(this,this._load_briefing_call);this._delete_issue_call_back=dojo.hitch(this,this._delete_issue_call);this._error_call_back=dojo.hitch(this,this._error_call);this._archive_issue_call_back=dojo.hitch(this,this._archive_issue_call);this._documents=new dojox.data.JsonRestStore({target:"/crm/documents/rest_combo",idAttribute:"id"});this._briefingnotesstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups_restricted?searchtype=briefingnotesstatus"});this._users=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this.filter_db=new prcommon.data.QueryWriteStore({url:"/crm/issues/issue_history",nocallback:true,onError:ttl.utilities.globalerrorchecker});this.issue_engagements=new prcommon.data.QueryWriteStore({url:"/crm/issues/issue_engagements",nocallback:true,onError:ttl.utilities.globalerrorchecker});},view:{cells:[[{name:"Changed",width:"auto",field:"changed_display"}]]},view1:{cells:[[{name:"Date",width:"60px",field:"taken_display"},{name:"Subject",width:"auto",field:"subject"},{name:"Contact",width:"auto",field:"contactname"},{name:"Status",width:"auto",field:"contacthistorystatusdescription"}]]},postCreate:function(){this.history_grid.set("structure",this.view);this.history_grid._setStore(this.filter_db);this.history_grid.onRowClick=dojo.hitch(this,this._on_select_row);this.engagements_grid.set("structure",this.view1);this.engagements_grid._setStore(this.issue_engagements);this.documentid.set("store",this._documents);this.documentid.set("value",-1);this.briefingnotesstatusid.set("store",this._briefingnotesstatus);this.briefingnotesstatusid.set("value",1);this.approvedbyid.set("store",this._users);this.approvedbyid.set("value",PRMAX.utils.settings.uid);this.clientid.set("store",this._clients);this.clientid.set("value","-1");this.engagements.set("title",PRMAX.utils.settings.crm_engagement_plural);dojo.attr(this.briefing_notes_label,"innerHTML",PRMAX.utils.settings.briefing_notes_description);dojo.attr(this.briefing_notes_status_label,"innerHTML",PRMAX.utils.settings.briefing_notes_description+" Status");this.inherited(arguments);},_on_select_row:function(e){this._selected_row=this.history_grid.getItem(e.rowIndex);this.history_view_ctrl.set("href",dojo.string.substitute(this.history_view,{issuehistoryid:this._selected_row.i.issuehistoryid}));},_save_call:function(_1){if(_1.success=="OK"){dojo.publish(PRCOMMON.Events.Issue_Update,[_1.data]);}else{alert("Problem Updating Issue");}this.savebtn.cancel();},_load_call:function(_2){if(_2.success=="OK"){this.issueid.set("value",_2.data.issueid);this.issuename.set("value",_2.data.name);this.briefingnotes.set("value",_2.data.briefingnotes);this.history_grid.setQuery({issueid:_2.data.issueid});this.engagements_grid.setQuery({issueid:_2.data.issueid});this.documentid.set("value",_2.data.documentid);this.briefingnotesstatusid.set("value",_2.data.briefingnotesstatusid);this.approvedbyid.set("value",_2.data.approvedbyid);if(_2.data.clientid>0){this.clientid.set("value",_2.data.clientid);}else{this.clientid.set("value",-1);}this._display_colours(_2.data.background_colour,_2.data.text_colour);this.tabcont.selectChild(this.details);this.coverage.load(_2.data.issueid);this.analysis_ctrl.load(null,_2.data.issueid);this.display_view.selectChild(this.tabcont);this.deletebtn.cancel();this.archivebtn.cancel();this._issuestatusid=_2.data.issuestatusid;this._setup_archive();}else{alert("Problem Loading Issue");}},_setup_archive:function(){if(this._issuestatusid==1){this.archivebtn.set("label","Archive");this._command_url="/crm/issues/archive";}else{this.archivebtn.set("label","Un-Archive");this._command_url="/crm/issues/unarchive";}},startup:function(){this.inherited(arguments);if(PRMAX.utils.settings.clippings==false){this.analysis_tab.controlButton.domNode.style.display="none";}if(PRMAX.utils.settings.updatum==false){this.coverage.controlButton.domNode.style.display="none";}},_clear:function(){this.documentid.set("value",-1);this.briefingnotesstatusid.set("value",1);this.approvedbyid.set("value",PRMAX.utils.settings.uid);},clear:function(){this.display_view.selectChild(this.blank);this.history_view_ctrl.set("content","");this._clear();},resize:function(){this.frame.resize(arguments[0]);},load:function(_3){this.clear();this._issueid=_3;dojo.xhrPost(ttl.utilities.makeParams({load:this._load_call_back,url:"/crm/issues/get",content:{issueid:_3}}));},_update_issue:function(){if(ttl.utilities.formValidator(this.formnode)==false){alert("Not all required field filled in");this.savebtn.cancel();return;}dojo.xhrPost(ttl.utilities.makeParams({load:this._update_call_back,url:"/crm/issues/update",content:this.formnode.get("value")}));},_update_call:function(_4){if(_4.success=="OK"){dojo.publish(PRCOMMON.Events.Issue_Update,[_4.data]);}else{alert("Problem Updating Issue");}this.savebtn.cancel();},_change_colour:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._load_briefing_call_back,url:"/crm/issues/briefingnoteget",content:{briefingnotesstatusid:this.briefingnotesstatusid.get("value")}}));},_load_briefing_call:function(_5){if(_5.success=="OK"){this._display_colours(_5.data.background_colour,_5.data.text_colour);}else{}},_display_colours:function(_6,_7){if(_7){dojo.style(this.briefingnotes.domNode,"color",_7);dojo.style(this.notes_frame,"color",_7);}else{dojo.style(this.briefingnotes.domNode,"color","inherit");dojo.style(this.notes_frame,"color","inherit");}if(_6){dojo.style(this.briefingnotes.domNode,"backgroundColor",_6);dojo.style(this.notes_frame,"backgroundColor",_6);}else{dojo.style(this.briefingnotes.domNode,"backgroundColor","transparent");dojo.style(this.notes_frame,"backgroundColor","transparent");}},_delete_issue:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._delete_issue_call_back,error:this._error_call_back,url:"/crm/issues/archive",content:{issueid:this._issueid}}));},_delete_issue_call:function(_8){if(_8.success=="OK"){dojo.publish(PRCOMMON.Events.Issue_Delete,[this._issueid]);}else{alert("Problem");}this.deletebtn.cancel();this.archivebtn.cancel();},_error_call:function(_9,_a){this.deletebtn.cancel();this.archivebtn.cancel();ttl.utilities.xhrPostError(_9,_a);},_archive_issue:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._archive_issue_call_back,error:this._error_call_back,url:this._command_url,content:{issueid:this._issueid}}));},_archive_issue_call:function(_b){this.deletebtn.cancel();this.archivebtn.cancel();if(_b.success=="OK"){if(this._issuestatusid==1){dojo.publish(PRCOMMON.Events.Issue_Update,[_b.data]);this._issuestatusid=2;}else{dojo.publish(PRCOMMON.Events.Issue_Update,[_b.data]);this._issuestatusid=1;}this._setup_archive();}else{alert("Problem");}}});}