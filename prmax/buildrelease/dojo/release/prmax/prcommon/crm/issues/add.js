/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.issues.add"]){dojo._hasResource["prcommon.crm.issues.add"]=true;dojo.provide("prcommon.crm.issues.add");dojo.require("prcommon.crm.solidsocial.preview");dojo.require("prcommon.documents.adddialog");dojo.declare("prcommon.crm.issues.add",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div style=\"width:500px;height:450px;margin:10px\">\r\n\t<form data-dojo-attach-point=\"formnode\" data-dojo-type=\"dijit.form.Form\" data-dojo-props='\"class\":\"common_prmax_layout prmaxdefault\",\"onSubmit\":\"return false\"'>\r\n\t\t<br/>\r\n\t\t<label class=\"label_1\">Title</label><input data-dojo-props='\"class\":\"prmaxrequired prmaxinput\",name:\"name\",type:\"text\",maxlength:80,trim:true,required:true,style:\"width:26em\"' data-dojo-attach-point=\"issue\" data-dojo-type=\"dijit.form.ValidationTextBox\"/><br/>\r\n\t\t<label class=\"label_1\">Document</label><select data-dojo-props='\"class\":\"prmaxinput\",name:\"documentid\",autoComplete:true,searchAttr:\"description\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"documentid\" ></select><button data-dojo-attach-event=\"onClick:_new_document\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"New\"'></button><br/>\r\n\t\t<label class=\"label_1\">Client</label><select data-dojo-props='\"class\":\"prmaxinput\",name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select><br/>\r\n\t\t<label data-dojo-attach-point=\"briefing_notes_label\">Briefing Notes</label><br/><br/>\r\n\t\t<div class=\"stdframe\" style=\"height:150px;\" data-dojo-attach-point=\"notes_frame\" ><textarea data-dojo-attach-point=\"briefingnotes\" data-dojo-props='\"class\":\"prmaxinput\",name:\"briefingnotes\",trim:true,required:true,style:\"width:99%;height:80%\"' data-dojo-type=\"dijit.form.Textarea\" ></textarea></div><br/>\r\n\t\t<label class=\"label_1\" data-dojo-attach-point=\"briefing_notes_status_label\">Notes Status</label><select data-dojo-props='\"class\":\"prmaxrequired prmaxinput\", name:\"briefingnotesstatusid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Briefing Note Status\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"briefingnotesstatusid\" data-dojo-attach-event=\"onChange:_change_colour\"></select><br/>\r\n\t\t<label class=\"label_1\">Approved By</label><select data-dojo-props='\"class\":\"prmaxrequired prmaxinput\", name:\"approvedbyid\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"approvedbyid\"></select><br/><br/>\r\n\t\t<br/><br/>\r\n\t\t<button data-dojo-attach-event=\"onClick:_close\" data-dojo-attach-point=\"closebtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Close\",\"class\":\"btnleft\"'></button>\r\n\t\t<button data-dojo-attach-event=\"onClick:_save\" data-dojo-attach-point=\"savebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Adding...\",label:\"Add\",\"class\":\"btnright\"'></button><br/><br/>\r\n\t</form>\r\n\t<div data-dojo-attach-point=\"add_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='style:\"width:600px;height:500px\"'>\r\n\t\t<div data-dojo-props='style:\"width:100%;height:100%\"' data-dojo-attach-point=\"add_ctrl\" data-dojo-type=\"prcommon.crm.solidsocial.preview\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"addctrl\" data-dojo-type=\"prcommon.documents.adddialog\" data-dojo-props='style:\"width:400px;height:200px;margin:10px\"'></div>\r\n</div>\r\n",constructor:function(){this._save_call_back=dojo.hitch(this,this._save_call);this._add_issue_call_back=dojo.hitch(this,this._add_issue_call);this._documents=new dojox.data.JsonRestStore({target:"/crm/documents/rest_combo",idAttribute:"id"});this._briefingnotesstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups_restricted?searchtype=briefingnotesstatus"});this._users=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._load_briefing_call_back=dojo.hitch(this,this._load_briefing_call);this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._pub_event=PRCOMMON.Events.Issue_Add;dojo.subscribe(PRCOMMON.Events.Document_Add,dojo.hitch(this,this._add_event));},postCreate:function(){dojo.attr(this.briefing_notes_label,"innerHTML",PRMAX.utils.settings.briefing_notes_description);dojo.attr(this.briefing_notes_status_label,"innerHTML",PRMAX.utils.settings.briefing_notes_description+" Status");this.inherited(arguments);this._dialog=null;this.documentid.set("store",this._documents);this.documentid.set("value",-1);this.briefingnotesstatusid.set("store",this._briefingnotesstatus);this.briefingnotesstatusid.set("value",1);this.approvedbyid.set("store",this._users);this.approvedbyid.set("value",null);this.clientid.set("store",this._clients);this.clientid.set("value","-1");},_save:function(){if(ttl.utilities.formValidator(this.formnode)==false){alert("Not all required field filled in");this.savebtn.cancel();return;}dojo.xhrPost(ttl.utilities.makeParams({load:this._save_call_back,url:"/crm/issues/add",content:this.formnode.get("value")}));},_setDialogAttr:function(_1){this._dialog=_1;},_setPublish_eventAttr:function(_2){this._pub_event=_2;},_save_call:function(_3){if(_3.success=="OK"){dojo.publish(this._pub_event,[_3.data]);this._close();}else{alert("Problem Adding Issue");this.savebtn.cancel();}},_clear:function(){this.savebtn.cancel();this.issue.set("value","");this.briefingnotes.set("value","");this.documentid.set("value",-1);this.briefingnotesstatusid.set("value",1);this.approvedbyid.set("value",null);this.clientid.set("value","-1");},_close:function(){if(this._dialog!=null){this._dialog.hide();}this._clear();},clear:function(){this._clear();},_add_event:function(_4){this.documentid.set("value",_4.documentid);},_new_document:function(){this.addctrl.show();},_change_colour:function(){dojo.xhrPost(ttl.utilities.makeParams({load:this._load_briefing_call_back,url:"/crm/issues/briefingnoteget",content:{briefingnotesstatusid:this.briefingnotesstatusid.get("value")}}));},_load_briefing_call:function(_5){if(_5.success=="OK"){this._display_colours(_5.data.background_colour,_5.data.text_colour);}else{}},_display_colours:function(_6,_7){if(_7){dojo.style(this.briefingnotes.domNode,"color",_7);dojo.style(this.notes_frame,"color",_7);}else{dojo.style(this.briefingnotes.domNode,"color","inherit");dojo.style(this.notes_frame,"color","inherit");}if(_6){dojo.style(this.briefingnotes.domNode,"backgroundColor",_6);dojo.style(this.notes_frame,"backgroundColor",_6);}else{dojo.style(this.briefingnotes.domNode,"backgroundColor","transparent");dojo.style(this.notes_frame,"backgroundColor","transparent");}},_show_selection:function(){this.add_ctrl.load(this.monitoring_words.get("value"));this.add_dlg.show();},_show_preview:function(){if(this.monitoring.get("checked")){dojo.removeClass(this.monitoring_view,"prmaxhidden");}else{dojo.addClass(this.monitoring_view,"prmaxhidden");}}});}