/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.issues.viewer"]){dojo._hasResource["prcommon.crm.issues.viewer"]=true;dojo.provide("prcommon.crm.issues.viewer");dojo.require("prcommon.data.QueryWriteStore");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.form.DropDownButton");dojo.require("dijit.TooltipDialog");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.TextBox");dojo.require("dojox.grid.DataGrid");dojo.require("prcommon.crm.issues.add");dojo.require("prcommon.crm.issues.update");dojo.require("prcommon.crm.issues.archive");dojo.require("prcommon.crm.issues.settings");dojo.declare("prcommon.crm.issues.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='gutters:false,style:\"width:100%;height:100%\"' >\r\n\t<span class=\"std_menu_view\">\r\n\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-props='region:\"top\",style:\"height:38px;width:100%;overflow:hidden\",\"class\":\"std_menu_view\"'>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"fa fa-plus fa-3x\"' data-dojo-attach-event=\"onClick:_add_issue\" data-dojo-attach-point=\"addbtn\"></button>\r\n\t\t\t<div data-dojo-type=\"dijit.form.DropDownButton\"  data-dojo-props='iconClass:\"fa fa-filter fa-3x\",showLabel:true'>\r\n\t\t\t\t<span></span>\r\n\t\t\t\t<div data-dojo-type=\"dijit.TooltipDialog\" data-dojo-props='title:\"Filter By\"' data-dojo-attach-event=\"execute:_filter\">\r\n\t\t\t\t\t<table>\r\n\t\t\t\t\t\t<tr><td><label>Active Only</label></td><td><input data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-point=\"autoonly\" data-dojo-props='\"class\":\"prmaxinput\",type:\"checkbox\",name:\"autoonly\",checked:true,value:\"1\"' ></td></tr>\r\n\t\t\t\t\t\t<tr><td><label>Name</label></td><td><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"issuename\" data-dojo-props='\"class\":\"prmaxinput\",type:\"text\",name:\"issuename\"' ></td></tr>\r\n\t\t\t\t\t\t<tr><td><label data-dojo-attach-point=\"briefing_notes_label\">Briefing Status</label></td><td><select data-dojo-props='\"class\":\"prmaxinput\",name:\"briefingnotesstatusid\",autoComplete:true,searchAttr:\"name\",required:false,labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"filter_briefingnotesstatusid\"></select></td></tr>\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td align=\"left\"><button data-dojo-attach-event=\"onClick: _clear_filter\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\"'>Clear</button></td>\r\n\t\t\t\t\t\t\t<td align=\"right\"><button data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"submit\",name:\"submit\"'>Submit</button></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"fa fa-cog fa-3x\"' data-dojo-attach-event=\"onClick:_settings_function\"></button>\r\n\t\t</div>\r\n\t\t</span>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region:\"center\",splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"viewer_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:30,style:\"width:100%;height:100%\"' ></div>\r\n\t</div>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:50%;height:100%\",\"class\":\"scrollpanel\",region:\"right\",splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"update_issue_ctrl\" data-dojo-type=\"prcommon.crm.issues.update\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"new_issue_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"New\"'>\r\n\t\t<div data-dojo-attach-point=\"new_issue_ctrl\" data-dojo-type=\"prcommon.crm.issues.add\" data-dojo-props='style:\"width:500px\"'></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"archive_issue_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Change Status\"'>\r\n\t\t<div data-dojo-attach-point=\"archive_issue_ctrl\" data-dojo-type=\"prcommon.crm.issues.archive\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"settings_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Briefing Notes Status\"'>\r\n\t\t<div data-dojo-attach-point=\"settings_ctrl\" data-dojo-type=\"prcommon.crm.issues.settings\"></div>\r\n\t</div>\r\n\r\n</div>\r\n",constructor:function(){this._briefingnotesstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups_restricted?searchtype=briefingnotesstatus&nofilter=1"});this.filter_db=new prcommon.data.QueryWriteStore({url:"/crm/issues/issues_list",nocallback:true,onError:ttl.utilities.globalerrorchecker});this._menu=null;this._menu2=null;this._get_model_item_call=dojo.hitch(this,this._get_model_item);dojo.subscribe(PRCOMMON.Events.Issue_Add,dojo.hitch(this,this._new_issue_event));dojo.subscribe(PRCOMMON.Events.Issue_Update,dojo.hitch(this,this._update_issue_event));dojo.subscribe(PRCOMMON.Events.Issue_Delete,dojo.hitch(this,this._delete_issue_event));},view:{cells:[[{name:"Created",width:"120px",field:"created_display"},{name:"Name",width:"auto",field:"name"},{name:"Status",width:"120px",field:"issuestatusdescription"},{name:" ",width:"15px",styles:"text-align: center;",width:"20px",formatter:ttl.utilities.format_row_ctrl}]]},postCreate:function(){this.viewer_grid.set("structure",this.view);this.viewer_grid._setStore(this.filter_db);this.viewer_grid.onRowClick=dojo.hitch(this,this.on_select_row);this.filter_briefingnotesstatusid.set("store",this._briefingnotesstatus);this.filter_briefingnotesstatusid.set("value",-1);dojo.attr(this.new_issue_dlg,"title","New "+PRMAX.utils.settings.issue_description);dojo.attr(this.briefing_notes_label,"innerHTML",PRMAX.utils.settings.briefing_notes_description);dojo.attr(this.settings_dlg,"title","New "+PRMAX.utils.settings.briefing_notes_description+" Status");this.inherited(arguments);},on_select_row:function(e){this._selected_row=this.viewer_grid.getItem(e.rowIndex);if(e.cellIndex==4){var _1=null;if(this._selected_row.i.issuestatusid=="1"){if(this._menu===null){this._menu=new dijit.Menu();this._menu.addChild(new dijit.MenuItem({label:"View",onClick:dojo.hitch(this,this._update_issue)}));this._menu.addChild(new dijit.MenuItem({label:"Archive",onClick:dojo.hitch(this,this._archive_issue)}));this._menu.addChild(new dijit.MenuItem({label:"New",onClick:dojo.hitch(this,this._add_issue)}));this._menu.startup();}_1=this._menu;}else{if(this._menu2===null){this._menu2=new dijit.Menu();this._menu2.addChild(new dijit.MenuItem({label:"View",onClick:dojo.hitch(this,this._update_issue)}));this._menu2.addChild(new dijit.MenuItem({label:"Un Archive",onClick:dojo.hitch(this,this._unarchive_issue)}));this._menu2.addChild(new dijit.MenuItem({label:"New",onClick:dojo.hitch(this,this._add_issue)}));this._menu2.startup();}_1=this._menu2;}_1._openMyself(e);}else{this.update_issue_ctrl.load(this._selected_row.i.issueid);}this.viewer_grid.selection.clickSelectEvent(e);},_filter:function(){var _2={};if(arguments[0].autoonly!="1"){_2["all_issues"]=1;}if(arguments[0].issuename!=""){_2["issuename"]=arguments[0].issuename;}if(arguments[0].briefingnotesstatusid!="-1"){_2["briefingnotesstatusid"]=arguments[0].briefingnotesstatusid;}this.viewer_grid.setQuery(ttl.utilities.getPreventCache(_2));this.update_issue_ctrl.clear();},refresh:function(){this._filter();},_add_issue:function(){this.update_issue_ctrl.clear();this.new_issue_ctrl.set("dialog",this.new_issue_dlg);this.new_issue_ctrl.clear();this.new_issue_dlg.show();},_clear_filter:function(){this.autoonly.set("checked",true);this.issuename.set("value","");this.filter_briefingnotesstatusid.set("value",-1);},resize:function(){this.frame.resize(arguments[0]);},_new_issue_event:function(_3){this.filter_db.newItem(_3);},_update_issue_event:function(_4){this.tmp_row=null;var _5={identity:_4.issueid,onItem:this._get_model_item_call};this.filter_db.fetchItemByIdentity(_5);if(this.tmp_row){this.filter_db.setValue(this.tmp_row,"issuestatusdescription",_4.issuestatusdescription,true);this.filter_db.setValue(this.tmp_row,"name",_4.name,true);}},_delete_issue_event:function(_6){this.filter_db.deleteItem(this._selected_row);this.update_issue_ctrl.clear();},_update_issue:function(){this.update_issue_ctrl.load(this._selected_row.i.issueid);},_archive_issue:function(){this.archive_issue_ctrl.set("dialog",this.archive_issue_dlg);this.archive_issue_ctrl.load(this._selected_row.i,"archive");this.archive_issue_dlg.show();},_unarchive_issue:function(){this.archive_issue_ctrl.set("dialog",this.archive_issue_dlg);this.archive_issue_ctrl.load(this._selected_row.i,"unarchive");this.archive_issue_dlg.show();},_get_model_item:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_settings_function:function(){this.settings_ctrl.set("dialog",this.settings_dlg);this.settings_ctrl.load();this.settings_dlg.show();this.settings_ctrl.force_startup();}});}