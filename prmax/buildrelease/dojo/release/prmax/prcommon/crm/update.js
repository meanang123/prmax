/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.update"]){dojo._hasResource["prcommon.crm.update"]=true;dojo.provide("prcommon.crm.update");dojo.require("ttl.BaseWidget");dojo.require("prmax.search.PersonSelect");dojo.require("prmax.search.PersonSelect2");dojo.require("prmax.search.PersonSelectDetails");dojo.require("prcommon.crm.issues.selectmultiple");dojo.require("prcommon.crm.issues.add");dojo.require("prcommon.crm.responses.sendreply");dojo.require("prcommon.common.ExpandedText");dojo.require("prcommon.documents.adddialog");dojo.declare("prcommon.crm.update",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-point='style:\"width:680px;height:100%\",gutters:false' >\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"display_view\" data-dojo-props='region:\"center\"'>\r\n\t\t\t<div data-dojo-attach-point=\"tabcont\" data-dojo-type=\"dijit.layout.TabContainer\" data-dojo-props=\"region:'center',splitter:true,'class':'bordered'\">\r\n\t\t\t\t<div data-dojo-attach-point=\"details_view\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Details',style:'height:100%;width:500px;overflow :auto','class':'bordered scrollpane common_prmax_layout',selected:'selected'\">\r\n\t\t\t\t\t<br/>\r\n\t\t\t\t\t<form data-dojo-attach-point=\"form\" data-dojo-type=\"dijit.form.Form\" data-dojo-props='onSubmit:\"return false\"'>\r\n\t\t\t\t\t\t<input data-dojo-attach-point=\"contacthistoryid\"  data-dojo-props='name:\"contacthistoryid\",type:\"hidden\",value:\"-1\"' data-dojo-type=\"dijit.form.TextBox\" />\r\n\r\n\t\t\t\t\t\t<input data-dojo-props='name:\"outletid\",type:\"hidden\",value:\"-1\"' data-dojo-attach-point=\"outletid\"  data-dojo-type=\"dijit.form.TextBox\" />\r\n\t\t\t\t\t\t<input data-dojo-props='name:\"employeeid\",type:\"hidden\",value:\"-1\"' data-dojo-attach-point=\"employeeid\"  data-dojo-type=\"dijit.form.TextBox\" />\r\n\t\t\t\t\t\t<table width=\"550px\" class=\"prmaxtable\">\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td rowspan=\"2\"><span data-dojo-props='name:\"contact\",placeHolder:\"Select contact <br/><br/><br/>\",required:false,style:\"width:230px;height:75px;float:left\"' data-dojo-type=\"prmax.search.PersonSelect2\" data-dojo-attach-point=\"contact\"></span></td>\r\n\t\t\t\t\t\t\t<td><span><input data-dojo-props='placeHolder:\"Date\", type:\"text\",name:\"taken\",required:\"true\",\"class\":\"input_field input_date noborders prmax-padding-left-small prmaxdate\"' data-dojo-attach-point=\"taken\" data-dojo-type=\"dijit.form.DateTextBox\" ></span></td>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\"><select data-dojo-props='style:\"width:150px\",placeHolder:\"Taken By\", name:\"taken_by\",\"class\":\"prmaxrequired prmaxinputselect\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Taken By\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"taken_by\"></select></span></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", style:\"width:150px\", placeHolder:\"Client\", name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", style:\"width:150px\",placeHolder:\"Issue\", \"class\":\"prmaxrequired\",name:\"issueid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"issueid\" data-dojo-attach-event=\"onChange:_issue_selected\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<input data-dojo-props='\"class\":\"prmaxinput\", placeHolder:\"Subject\", type:\"text\",name:\"crm_subject\",style:\"width:450px;margin-top:10px;margin-bottom:2px\"' data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"crm_subject\" />\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<textarea placeHolder=\"Briefing Notes\" data-dojo-attach-point=\"details\" name=\"details\" required style=\"width:450px;margin-top:10px;min-height:70px;\"></textarea>\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<textarea placeHolder=\"Details\" data-dojo-attach-point=\"outcome\" name=\"outcome\" style=\"width:450px;min-height:70px;margin-top:10px;\"></textarea>\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\" style=\"float:left\">\r\n\t\t\t\t\t\t\t<input data-dojo-attach-event=\"onClick:_send_reply\" data-dojo-attach-point=\"sendreplybtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='\"class\":\"prmax-padding-left-large\",type:\"button\",label:\"Send Reply\",\"class\":\"btnleft\",disabled:\"disabled\"'><br />\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<textarea placeHolder=\"Response Details\" name=\"crm_response\" style=\"width:450px;margin-top:10px;min-height:70px;\" data-dojo-attach-point=\"crm_response\"></textarea>\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr data-dojo-attach-point=\"chud5_view\" class=\"prmaxhidden\">\r\n\t\t\t\t\t\t\t<td data-dojo-attach-point=\"chud1_view\" class=\"prmaxhidden\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"User Define 1\", name:\"chud1id\",autoComplete:true,searchAttr:\"description\",required:false,invalidMessage:\"User Defined\",labelType:\"html\",style:\"width:150px\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"chud1id\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t\t<td data-dojo-attach-point=\"chud2_view\" class=\"prmaxhidden\" colspan=\"2\"><span class=\"prmax-padding-left-verylarge\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"User Define 2\", name:\"chud2id\",autoComplete:true,searchAttr:\"description\",required:false,invalidMessage:\"User Defined\",labelType:\"html\",style:\"width:150px\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"chud2id\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr data-dojo-attach-point=\"chud6_view\" class=\"prmaxhidden\">\r\n\t\t\t\t\t\t\t<td data-dojo-attach-point=\"chud3_view\" class=\"prmaxhidden\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"User Define 3\", name:\"chud3id\",autoComplete:true,searchAttr:\"description\",required:false,invalidMessage:\"User Defined\",labelType:\"html\",style:\"width:150px\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"chud3id\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t\t<td data-dojo-attach-point=\"chud4_view\" class=\"prmaxhidden\" colspan=\"2\"><span class=\"prmax-padding-left-verylarge\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"User Define 4\", name:\"chud4id\",autoComplete:true,searchAttr:\"description\",required:false,invalidMessage:\"User Defined\",labelType:\"html\",style:\"width:150px\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"chud4id\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td colspan=\"3\" ><span>\r\n\t\t\t\t\t\t\t\t<label style=\"padding-left:50px !important\" class=\"label_1\">Document</label>\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"Document\", style:\"width:150px\",name:\"documentid\",autoComplete:true,searchAttr:\"description\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"documentid\" ></select>\r\n\t\t\t\t\t\t\t\t<button class=\"prmaxbutton\" data-dojo-attach-point=\"previewbtn\" data-dojo-attach-event=\"onClick:_preview\" data-dojo-type=\"dijit.form.Button\">View</button>\r\n\t\t\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_new_document\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"New\"'></button>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td colspan=\"3\">\r\n\t\t\t\t\t\t\t<div data-dojo-type=\"prcommon.crm.issues.selectmultiple\" data-dojo-props='style:\"width:4;padding-left:50px\",displaytitle:\"Other Issues\",displayselect:\"\",name:\"extraissues\",startopen:false' data-dojo-attach-point=\"extraissues\">\r\n\t\t\t\t\t\t\t</div></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t\t<tr><td><span>\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"Call Type\",\"class\":\"prmaxrequired\",name:\"contacthistorytypeid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Select\",labelType:\"html\",style:\"width:100px;float:left;\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"contacthistorytypeid\"></select>\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"Status\",\"class\":\"prmaxrequired\",name:\"contacthistorystatusid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Status\",labelType:\"html\",style:\"width:100px;float:left;\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"contacthistorystatusid\"></select><br/>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t    <td colspan=\"2\"><span>\r\n\t\t\t\t\t\t\t\t<input data-dojo-props='\"class\":\"prmaxdate\", placeHolder:\"Deadline\",type:\"text\",name:\"follow_up_date\",required:true,style:\"width:120px;float:right\"' data-dojo-attach-point=\"follow_up_date\" data-dojo-type=\"dijit.form.DateTextBox\" >\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"Task Owner\",\"class\":\"prmaxrequired\",name:\"follow_up_ownerid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Follow Up Only\",labelType:\"html\",style:\"width:120px;float:right\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"follow_up_ownerid\"></select><br/>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t<tr><td>\r\n\t\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_close\" data-dojo-attach-point=\"closebtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\",label:\"Close\",\"class\":\"btnleft\"'></button>\r\n\t\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_delete\" data-dojo-attach-point=\"deletebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Deleting...\",label:\"Delete\",\"class\":\"btnleft\"'></button>\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t<td colspan=\"2\" align=\"right\">\r\n\t\t\t\t\t\t\t<button data-dojo-attach-event=\"onClick:_save\" data-dojo-attach-point=\"savebtn\" data-dojo-type=\"dojox.form.BusyButton\" data-dojo-props='type:\"button\",busyLabel:\"Please Wait Updating...\",label:\"Update\"'></button><br/><br/>\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t</table><br/><br/>\r\n\t\t\t\t\t\r\n\t\t\t\t\t</form>\r\n\r\n\t\t\t\t\t<div data-dojo-attach-point=\"person_select_dlg\" data-dojo-type=\"prmax.search.PersonSelect\"></div>\r\n\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"history\"  data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props=\"title:'History',style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpanel'\">\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region: \"center\"'>\r\n\t\t\t\t\t\t<div data-dojo-attach-point=\"history_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:30,style:\"width:100%;height:100%\"' ></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"history_view_ctrl\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='\"class\":\"prmaxrowdisplay_profile\", region: \"right\",style:\"width:70%;height:100%;overflow:auto\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-attach-point=\"blank\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'blank',style:'height:100%;width:500px',selected:'selected'\"></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"new_issue_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"New Issue\"'>\r\n\t\t<div data-dojo-attach-point=\"new_issue_ctrl\" data-dojo-type=\"prcommon.crm.issues.add\"></div>\r\n\t</div>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-attach-point=\"client_add_dialog\" data-dojo-props='title:\"Add New Client\",style:\"width:700px;height:600px\"'>\r\n\t\t<div data-dojo-type=\"prmax.customer.clients.add\" data-dojo-attach-point=\"client_add_ctrl\"></div>\r\n\t</div>\r\n\t\r\n\t<div data-dojo-attach-point=\"send_reply_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Send Reply\", style:\"width:550px;height:580px\"'>\r\n\t\t<div data-dojo-attach-point=\"send_reply_ctrl\" data-dojo-type=\"prcommon.crm.responses.sendreply\"></div>\r\n\t</div>\r\n\t\r\n\t<div data-dojo-attach-point=\"text_view_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Add Notes\"'>\r\n\t\t<div data-dojo-attach-point=\"text_view_ctrl\" data-dojo-type=\"prcommon.common.ExpandedText\" data-dojo-props='style:\"width:600px;height:500px\"'></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"addctrl\" data-dojo-type=\"prcommon.documents.adddialog\"></div>\r\n</div>\r\n",history_view:"/crm/history_view?contacthistoryhistoryid=${contacthistoryhistoryid}",show_close:true,constructor:function(){this._DocumentCallBack=dojo.hitch(this,this._DocumentCall);this._users=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._contacthistorystatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=contacthistorystatus"});this._contacthistorytypes=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=prmaxcontacthistorytypes"});this._load_call_back=dojo.hitch(this,this._load_call);this._save_call_back=dojo.hitch(this,this._save_call);this._delete_call_back=dojo.hitch(this,this._delete_call);this._error_call_back=dojo.hitch(this,this._error_call);this._client_add_call_back=dojo.hitch(this,this._client_add_call);this._on_select_contact_call_back=dojo.hitch(this,this._on_select_contact);this._tmp_size=null;this._contactemail="";this._issues=new dojox.data.QueryReadStore({url:"/crm/issues/issues_list",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});this._history=new prcommon.data.QueryWriteStore({url:"/crm/ch_history",nocallback:true,onError:ttl.utilities.globalerrorchecker});for(var _1 in this._fields){var _2=this._fields[_1];this["_chud"+_2]=new dojox.data.QueryReadStore({url:"/crm/user_defined?fieldid="+_2,onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});}this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._documents=new dojox.data.JsonRestStore({target:"/crm/documents/rest_combo",idAttribute:"id"});dojo.subscribe(PRCOMMON.Events.Issue_Add,dojo.hitch(this,this._new_issue_event));dojo.subscribe("/crm/settings_change",dojo.hitch(this,this._settings_event));dojo.subscribe(PRCOMMON.Events.Document_Add,dojo.hitch(this,this._add_event));dojo.subscribe("/crm/update_response",dojo.hitch(this,this._update_response_event));dojo.subscribe("/crm/update_person",dojo.hitch(this,this._update_person_event));},_fields:["1","2","3","4"],view:{cells:[[{name:"Changed",width:"65px",field:"created_display"},{name:"Type",width:"65px",field:"changetype"},{name:"User",width:"auto",field:"user_name"}]]},postCreate:function(){this.taken_by.store=this._users;this.follow_up_ownerid.store=this._users;this.contacthistorystatusid.store=this._contacthistorystatus;this.contacthistorytypeid.store=this._contacthistorytypes;this.issueid.store=this._issues;this.clientid.set("store",this._clients);dojo.attr(this.sendreplybtn,"disabled",true);if(PRMAX.utils.settings.required_client){dojo.addClass(this.clientid,"prmaxrequired");this.clientid.set("query",{required_client:true});}else{dojo.removeClass(this.clientid,"prmaxrequired");this.clientid.set("value","-1");}this.documentid.set("store",this._documents);this.history_grid.set("structure",this.view);this.history_grid._setStore(this._history);this.history_grid.onRowClick=dojo.hitch(this,this._on_select_row);this.chud1id.store=this._chud1;this.chud2id.store=this._chud2;this.chud3id.store=this._chud3;this.chud4id.store=this._chud4;var _3=false;for(var _4 in this._fields){var _5=this._fields[_4];if(PRMAX.utils.settings["crm_user_define_"+_5]!=""&&PRMAX.utils.settings["crm_user_define_"+_5]!=null){dojo.removeClass(this["chud"+_5+"_view"],"prmaxhidden");_3=true;}this["chud"+_5+"id"].store=this["_chud"+_5];}if(_3==true){dojo.removeClass(this["chud5_view"],"prmaxhidden");dojo.removeClass(this["chud6_view"],"prmaxhidden");}if(this.show_close==false){dojo.addClass(this.closebtn.domNode,"prmaxhidden");}this.new_issue_dlg.set("label",PRMAX.utils.settings.issue_description);this.extraissues.set("displaytitle","Other "+PRMAX.utils.settings.issue_description+"s");this.inherited(arguments);},_on_select_row:function(e){this._selected_row=this.history_grid.getItem(e.rowIndex);this.history_view_ctrl.set("href",dojo.string.substitute(this.history_view,{contacthistoryhistoryid:this._selected_row.i.contacthistoryhistoryid}));},load:function(_6,_7){this._clear();this._contacthistoryid=_6;this._contactemail=_7;dojo.xhrPost(ttl.utilities.makeParams({load:this._load_call_back,url:"/crm/get_edit",content:{contacthistoryid:_6}}));},_load_call:function(_8){if(_8.success=="OK"){this.contacthistoryid.set("value",_8.data.ch.contacthistoryid);var _9=_8.data.contactname;if(_8.data.outlet==null||_8.data.outlet.outletid==""){this.outletid.set("value",-1);}else{this.outletid.set("value",_8.data.outlet.outletid);this.contact.outletid.set("value",_8.data.outlet.outletid);}if(_8.data.employee==null||_8.data.employee.employeeid==""){this.employeeid.set("value",-1);}else{this.employeeid.set("value",_8.data.employee.employeeid);this.contact.employeeid.set("value",_8.data.employee.employeeid);}if(_8.data.outlet!=null&&_8.data.outlet.outletname!=""){if(_9!=null&&_9!=""){_9+="<br /><br />"+_8.data.outlet.outletname;}else{_9=" Outlet: "+_8.data.outlet.outletname;}}if(_8.data.contact){this.contact.set("value",_8.data.contact.contactid);}this.contact.set("Displayvalue",_9);if(_8.data.ch.crm_response==""){this.sendreplybtn.set("disabled",true);}else{this.sendreplybtn.set("disabled",false);}this.taken.set("value",ttl.utilities.fromJsonDate(_8.data.ch.taken));this.taken_by.set("value",_8.data.ch.taken_by);this.contacthistorystatusid.set("value",_8.data.ch.contacthistorystatusid);this.contacthistorytypeid.set("value",_8.data.ch.contacthistorytypeid);this.clientid.set("value",_8.data.ch.clientid);this.documentid.set("value",_8.data.ch.documentid);this._document_data=_8.data.document;this.details.value=_8.data.ch.details;this.outcome.value=_8.data.ch.outcome;this.crm_response.value=_8.data.ch.crm_response;this.crm_subject.set("value",_8.data.ch.crm_subject);for(var _a in this._fields){var _b=this._fields[_a];this["chud"+_b+"id"].set("value",_8.data.ch["chud"+_b+"id"]);}if(_8.data.chi.primary){this.issueid.set("value",_8.data.chi.primary.issueid);}else{this.issueid.set("value",null);}this.extraissues.set("value",_8.data.chi.si);if(_8.data.task){this.follow_up_ownerid.set("value",_8.data.ch.follow_up_ownerid);this.follow_up_date.set("value",ttl.utilities.fromJsonDate(_8.data.ch.follow_up_date));}else{this.follow_up_ownerid.set("value",null);this.follow_up_date.set("value",null);}this.display_view.selectChild(this.tabcont);this.tabcont.selectChild(this.details_view);this.history_grid.setQuery({contacthistoryid:_8.data.ch.contacthistoryid});}else{}},_clear:function(){this.clientid.set("value",-1);this.documentid.set("value",-1);this.history_view_ctrl.set("href",dojo.string.substitute(this.history_view,{contacthistoryhistoryid:-1}));this.tabcont.selectChild(this.details_view);},clear:function(){this.display_view.selectChild(this.blank);this._clear();},_new_issue:function(){this.new_issue_ctrl.clear();this.new_issue_ctrl.set("dialog",this.new_issue_dlg);this.new_issue_dlg.show();},_save:function(){if(this.details.value==""){this.savebtn.cancel();alert(PRMAX.utils.settings.briefing_notes_description+" cannot be empty");return;}var _c=this.form.get("value");_c["taken"]=ttl.utilities.toJsonDate(this.taken.get("value"));_c["follow_up_date"]=ttl.utilities.toJsonDate(this.follow_up_date.get("value"));_c["outletid"]=this.outletid.value;_c["employeeid"]=this.employeeid.value;_c["details"]=this.details.value;_c["outcome"]=this.outcome.value;_c["crm_response"]=this.crm_response.value;dojo.xhrPost(ttl.utilities.makeParams({load:this._save_call_back,error:this._error_call_back,url:"/crm/update_note",content:_c}));},_save_call:function(_d){if(_d.success=="OK"){alert(PRMAX.utils.settings.crm_engagement+" changed");dojo.publish("/crm/update_note",[_d.data]);dojo.publish("/crm/update_person",[_d.data]);}else{alert("Problem updating "+PRMAX.utils.settings.crm_engagement);}this.savebtn.cancel();},_new_issue_event:function(_e){this.issueid.set("value",_e.issueid);},resize:function(){if(arguments[0]==null){this.frame.resize(this._tmp_size);}else{this.frame.resize(arguments[0]);}},_error_call:function(_f,_10){ttl.utilities.xhrPostError(_f,_10);this.savebtn.cancel();this.deletebtn.cancel();},_setTmpsizeAttr:function(_11){if(_11){this._tmp_size=new Object();this._tmp_size.w=580;this._tmp_size.h=_11.h;}},_settings_event:function(){for(var key in this._fields){var _12=this._fields[key];if(PRMAX.utils.settings["crm_user_define_"+_12]!=""&&PRMAX.utils.settings["crm_user_define_"+_12]!=null){dojo.removeClass(this["chud"+_12+"_view"],"prmaxhidden");}else{dojo.addClass(this["chud"+_12+"_view"],"prmaxhidden");}}},_download:function(){ttl.utilities.gotoDialogPageStatic("/crm/documents/download/"+this._document_data.documentid+this._document_data.ext);},_close:function(){dojo.publish("/crm/update_note_close");},_new_client:function(){this.client_add_ctrl.Load(-1,this._client_add_call_back);this.client_add_dialog.show();},_client_add_call:function(_13,_14){this.clientid.set("value",_14.clientid);this.client_add_dialog.hide();},_issue_selected:function(){var _15=this.issueid.get("value");if(_15!=null&&_15!=""&&_15!="-1"){dojo.xhrPost(ttl.utilities.makeParams({load:this._issue_brief_call_back,url:"/crm/issues/get_briefing_notes",content:{issueid:_15}}));}},_new_document:function(){this.addctrl.show();},_add_event:function(_16){this.documentid.set("value",_16.documentid);},_send_reply:function(){this.send_reply_ctrl.set("dialog",this.send_reply_dlg,this.crm_subject.value,this.contacthistoryid.value,this._contactemail);this.send_reply_ctrl.load(this.send_reply_dlg,this.crm_subject.value,this.contacthistoryid.value,this._contactemail);this.send_reply_dlg.show();},_update_response_event:function(_17){this.history_grid.setQuery({contacthistoryid:_17.data.contacthistoryid});},_delete:function(){if(confirm("Delete "+PRMAX.utils.settings.crm_engagement+"?")){dojo.xhrPost(ttl.utilities.makeParams({load:this._delete_call_back,error:this._error_call_back,url:"/crm/deletenote",content:{contacthistoryid:this._contacthistoryid}}));}else{this.deletebtn.cancel();}},_delete_call:function(_18){if(_18.success=="OK"){dojo.publish("/crm/delete_note",[this._contacthistoryid]);}else{if(_18.message){alert("Problem Deleting "+PRMAX.utils.settings.crm_engagement+" "+_18.message);}else{alert("Problem Deleting "+PRMAX.utils.settings.crm_engagement);}}this.deletebtn.cancel();},_on_select_contact:function(_19,_1a,_1b,_1c){this.outletid.set("value",_1a);this.employeeid.set("value",_19);var _1d=_1b;if(_1c!=""){_1d+=" ("+_1c+")";}dojo.attr(this.contact_display,"innerHTML",_1d);},_select_contact:function(){this.person_select_dlg.start_search(this._on_select_contact_call_back);},_update_person_event:function(_1e){this.outletid.set("value",_1e.outletid);this.employeeid.set("value",_1e.employeeid);},_preview:function(){this._show_document();},_show_document:function(){var _1f={};_1f["documentid"]=this.documentid.get("value");dojo.xhrPost(ttl.utilities.makeParams({load:this._DocumentCallBack,url:"/crm/documents/get",content:_1f}));},_DocumentCall:function(_20){if(_20.success=="OK"){ttl.utilities.gotoDialogPageStatic("/crm/documents/download/"+_20.data.documentid+_20.data.ext);}},});}