/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.viewer"]){dojo._hasResource["prcommon.crm.viewer"]=true;dojo.provide("prcommon.crm.viewer");dojo.require("prcommon.crm.add");dojo.require("prcommon.crm.update");dojo.require("prcommon.crm.output");dojo.require("prcommon.crm.settings");dojo.require("prcommon.date.daterange");_add_new_line=function(_1){return _1?_1.replace("====","<br />"):"";};_add_green_check=function(_2){if(_2){var _3=_2.search("====");if(_2.substr(_3+4,_2.length).trim().toLowerCase()=="completed"){return "<div style=\"text-align:center\">"+_2.substr(0,_3)+"<br /><i class=\"fa fa-check-circle-o fa-2x\" style=\"color:#27BD59; aria-hidden=\"true\"></i></div>";}else{return "<div style=\"text-align:center\">"+_2.substr(0,_3)+"<br /><i class=\"fa fa-check-circle-o fa-2x\" style=\"color:#F6F6F6; aria-hidden=\"true\"></i></div>";}}else{return "";}};dojo.declare("prcommon.crm.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-point='style:\"width:100%;height:100%\",gutters:false' >\r\n\t<span class=\"searchresults\">\r\n\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-attach-point=\"controls\" data-dojo-props='region:\"top\",style:\"height:38px;width:100%;padding:0x;margin:0px;overflow:hidden\",\"class\":\"searchresults\"'>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"New\",iconClass:\"fa fa-plus fa-3x\"' data-dojo-attach-event=\"onClick:_new_note\"></button>\r\n\t\t\t<div data-dojo-type=\"dijit.form.DropDownButton\"  data-dojo-props='iconClass:\"fa fa-filter fa-3x\",showLabel:true'>\r\n\t\t\t\t<span>Filter By</span>\r\n\t\t\t\t<div data-dojo-type=\"dijit.TooltipDialog\" data-dojo-props='title:\"Filter By\"' data-dojo-attach-event=\"execute:_execute_filter\">\r\n\t\t\t\t\t<table width=\"500px\">\r\n\t\t\t\t\t\t<tr><td><label>Date Range</label></td><td><div data-dojo-type=\"prcommon.date.daterange\" data-dojo-attach-point=\"drange\" data-dojo-props='value:\"\",name:\"drange\"'></div></td></tr>\r\n\t\t\t\t\t\t<tr><td><label>Status</label></td><td><select data-dojo-props='\"class\":\"prmaxinputselect\", autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Status\",labelType:\"html\",name:\"contacthistorystatusid\",style:\"width:120px\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"filter_contacthistorystatusid\"></select><br/></td></tr>\r\n\t\t\t\t\t\t<tr><td><label data-dojo-attach-point=\"subject_label_1\">Subject</label></td><td><input data-dojo-attach-point=\"filter_subject\" data-dojo-props='\"class\":\"prmaxinput\",placeHolder:\"No Selection\",type:\"text\",name:\"subject\",style:\"width:380px\"' data-dojo-type=\"dijit.form.TextBox\" /></td></tr>\r\n\t\t\t\t\t\t<tr><td><label data-dojo-attach-point=\"details_label\">Briefing Notes</label></td><td><input data-dojo-attach-point=\"filter_details\" data-dojo-props='\"class\":\"prmaxinput\",placeHolder:\"No Selection\",type:\"text\",name:\"details\",style:\"width:380px\"' data-dojo-type=\"dijit.form.TextBox\" /></td></tr>\r\n\t\t\t\t\t\t<tr><td><label data-dojo-attach-point=\"response_label\">Response</label></td><td><input data-dojo-attach-point=\"filter_response\" data-dojo-props='\"class\":\"prmaxinput\",placeHolder:\"No Selection\",type:\"text\",name:\"response\",style:\"width:380px\"' data-dojo-type=\"dijit.form.TextBox\" /></td></tr>\r\n\t\t\t\t\t\t<tr><td><label data-dojo-attach-point=\"issue_label_1\">Issue</label></td><td><select data-dojo-props='\"class\":\"prmaxinputselect\",placeHolder:\"No Selection\",name:\"issueid\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Select Issue\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"filter_issueid\"></select></td></tr>\r\n\t\t\t\t\t\t<tr><td><label>Follow Up By</label></td><td><select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"No Selection\",name:\"followup_by\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Follow Up By\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"filter_followup_by\"></select></td></tr>\r\n\t\t\t\t\t\t<tr><td><label>Taken By</label></td><td><select data-dojo-props='\"class\":\"prmaxinputselect\", placeHolder:\"No Selection\",name:\"taken_by\",autoComplete:true,searchAttr:\"name\",required:false,invalidMessage:\"Taken By\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"filter_taken_by\"></select></td></tr>\r\n\t\t\t\t\t\t<tr><td><label class=\"label_1\">Client</label></td><td><select data-dojo-props='\"class\":\"prmaxinputselect\", name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\",required:false' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select></td></tr>\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td align=\"left\"><button data-dojo-attach-event=\"onClick: _clear_filter\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\"'>Clear</button></td>\r\n\t\t\t\t\t\t\t<td align=\"right\"><button data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"submit\",name:\"submit\"'>Submit</button></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</table>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"Output\",iconClass:\"fa fa-line-chart fa-3x\"' data-dojo-attach-event=\"onClick:_output_function\"></button>\r\n\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"Settings\",iconClass:\"fa fa-wrench fa-3x\"' data-dojo-attach-event=\"onClick:_settings_function\"></button>\r\n\t\t</div>\r\n\t\t</span>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" class=\"spacygriddisplay\" data-dojo-props='region:\"center\",splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"viewer_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ },rowsPerPage:50,style:\"width:100%;height:100%\"' ></div>\r\n\t\t</div>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\"  data-dojo-props='style:\"width:50%;height:100%\",region:\"right\",splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"update_crm_ctrl\" data-dojo-type=\"prcommon.crm.update\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"crm_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"<p><i class=\\\"fa fa-user\\\"></i>&nbsp;New Engagement</p>\",style:\"width:600px;height:700px\"'>\r\n\t\t<div data-dojo-attach-point=\"crm_add\" data-dojo-type=\"prcommon.crm.add\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"output_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Output\",style:\"width:480px\"'>\r\n\t\t<div data-dojo-attach-point=\"output_ctrl\" data-dojo-type=\"prcommon.crm.output\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"settings_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Settings\"'>\r\n\t\t<div data-dojo-attach-point=\"settings_ctrl\" data-dojo-type=\"prcommon.crm.settings\"></div>\r\n\t</div>\r\n</div>\r\n",constructor:function(){this.filter_db=new prcommon.data.QueryWriteStore({url:"/crm/filter",nocallback:true,onError:ttl.utilities.globalerrorchecker});this._issues=new dojox.data.QueryReadStore({url:"/crm/issues/issues_list",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});dojo.subscribe("/crm/newnote",dojo.hitch(this,this._new_crm_event));dojo.subscribe("/crm/update_note",dojo.hitch(this,this._update_crm_event));dojo.subscribe("/crm/update_note_close",dojo.hitch(this,this._close_update_crm_event));dojo.subscribe("/crm/delete_note",dojo.hitch(this,this._deleted_crm_event));this._users=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._contacthistorystatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=contacthistorystatus&nofilter=1"});this._get_model_item_call=dojo.hitch(this,this._get_model_item);this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});},postCreate:function(){var _4={cells:[[{name:"Contact",width:"40%",field:"contactdetails_display",formatter:_add_new_line},{name:"Details",width:"40%",field:"details_display",formatter:_add_new_line},{name:"Status",width:"20%",field:"status_display",formatter:_add_green_check}]]};if(PRMAX.utils.settings.crm_subject.length>0){_4["cells"][0][1]["name"]=PRMAX.utils.settings.crm_subject;dojo.attr(this.subject_label_1,"innerHTML",PRMAX.utils.settings.crm_subject);}this.viewer_grid.set("structure",_4);this.viewer_grid._setStore(this.filter_db);this.viewer_grid.onRowClick=dojo.hitch(this,this.on_select_row);this.filter_taken_by.store=this._users;this.filter_followup_by.store=this._users;this.filter_issueid.store=this._issues;this.filter_contacthistorystatusid.store=this._contacthistorystatus;this.filter_contacthistorystatusid.set("value",-1);this.clientid.set("store",this._clients);this.clientid.set("value",-1);dojo.attr(this.issue_label_1,"innerHTML",PRMAX.utils.settings.issue_description);dojo.attr(this.response_label,"innerHTML",PRMAX.utils.settings.response_description);this.inherited(arguments);},on_select_row:function(e){this._selected_row=this.viewer_grid.getItem(e.rowIndex);this.update_crm_ctrl.load(this._selected_row.i.contacthistoryid,this._selected_row.i.contactemail);},_new_note:function(){this.crm_add.set("dialog",this.crm_dlg);this.crm_add.clear();this.crm_dlg.set("title","<p><i class=\"fa fa-user\"></i>&nbsp;New "+PRMAX.utils.settings.crm_engagement+"</p>");this.crm_dlg.show();this.crm_dlg.resize();},refresh:function(){this._filter();},resize:function(){this.update_crm_ctrl.set("tmpsize",arguments[0]);this.frame.resize(arguments[0]);},_clear_filter:function(){this.filter_contacthistorystatusid.set("value",-1);this.filter_taken_by.set("value",null);this.filter_followup_by.set("value",null);this.filter_issueid.set("value",null);this.filter_subject.set("value","");this.filter_response.set("value","");this.clientid.set("value",null);},_execute_filter:function(){var _5={drange:this.drange.get("value")};this.filter=_5;if(arguments[0].subject.length>0){_5["subject"]=arguments[0].subject;}if(arguments[0].response.length>0){_5["response"]=arguments[0].response;}if(arguments[0].details.length>0){_5["details"]=arguments[0].details;}if(arguments[0].contacthistorystatusid.length>0&&arguments[0].contacthistorystatusid!=""&&arguments[0].contacthistorystatusid!="-1"){_5["contacthistorystatusid"]=arguments[0].contacthistorystatusid;}if(arguments[0].taken_by.length>0&&arguments[0].taken_by!=""&&arguments[0].taken_by!="-1"){_5["taken_by"]=arguments[0].taken_by;}if(arguments[0].followup_by.length>0&&arguments[0].followup_by!=""&&arguments[0].followup_by!="-1"){_5["followup_by"]=arguments[0].followup_by;}if(arguments[0].issueid.length>0&&arguments[0].issueid!=""&&arguments[0].issueid!="-1"){_5["issueid"]=arguments[0].issueid;}if(arguments[0].clientid.length>0&&arguments[0].clientid!=""&&arguments[0].clientid!="-1"){_5["clientid"]=arguments[0].clientid;}this.update_crm_ctrl.clear();this.viewer_grid.setQuery(_5);},_output_function:function(){this.output_ctrl.clear();this.output_ctrl.set("dialog",this.output_dlg);this.output_dlg.show();},_new_crm_event:function(_6){this.filter_db.newItem(_6);},_update_crm_event:function(_7){this.tmp_row=null;var _8={identity:_7.ch.contacthistoryid,onItem:this._get_model_item_call};this.filter_db.fetchItemByIdentity(_8);if(this.tmp_row){var _9=_7.ch.crm_subject;if(_9.length==0){_9=_7.ch.subject;}var _a="";if(_7.outlet){_a=_7.outlet.outletname;}this.filter_db.setValue(this.tmp_row,"subject",_9,true);this.filter_db.setValue(this.tmp_row,"contacthistorystatusdescription",_7.status,true);this.filter_db.setValue(this.tmp_row,"display_name",_7.display_name,true);this.filter_db.setValue(this.tmp_row,"taken_display",_7.taken_date,true);this.filter_db.setValue(this.tmp_row,"outletname",_a,true);this.filter_db.setValue(this.tmp_row,"contactname",_7.contactname,true);}},_get_model_item:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_settings_function:function(){this.settings_ctrl.set("dialog",this.settings_dlg);this.settings_ctrl.load();},_close_update_crm_event:function(){this.update_crm_ctrl.clear();},_deleted_crm_event:function(_b){this.update_crm_ctrl.clear();this.filter_db.deleteItem(this._selected_row);this._selected_row=null;}});}