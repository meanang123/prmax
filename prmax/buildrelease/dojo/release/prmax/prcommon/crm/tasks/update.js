/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.tasks.update"]){dojo._hasResource["prcommon.crm.tasks.update"]=true;dojo.provide("prcommon.crm.tasks.update");dojo.require("prcommon.crm.update");dojo.declare("prcommon.crm.tasks.update",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"frame\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='gutters:false,style:\"width:100%;height:100%\"' >\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"display_view\" data-dojo-props='region:\"center\"'>\r\n\t\t\t<div title=\"blank\" data-dojo-attach-point=\"blank\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='selected:\"selected\",style:\"width:100%;height:100%\"'></div>\r\n\t\t\t<div data-dojo-attach-point=\"tabcont\" data-dojo-type=\"dijit.layout.TabContainer\" data-dojo-props='region:\"center\",splitter:true,style:\"width:100%;height:100%\"'>\r\n\t\t\t\t<div data-dojo-attach-point=\"details\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"iconClass:'fa fa-tasks',title:'Task',style:'height:100%;width:50%px;overflow :auto','class':'bordered scrollpane common_prmax_layout',selected:'selected'\">\r\n\t\t\t\t\t<form data-dojo-attach-point=\"form_taskupdate\"  data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t\t\t\t<input data-dojo-props='type:\"hidden\",name:\"taskid\"' data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"taskid\">\r\n\t\t\t\t\t\t<table width=\"550px\" class=\"prmaxtable\">\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td rowspan=\"2\"><span data-dojo-props='name:\"contact\",placeHolder:\"Select contact <br/><br/><br/>\",required:false,style:\"width:230px;height:75px;float:left\"' data-dojo-type=\"prmax.search.PersonSelect2\" data-dojo-attach-point=\"contact_task\"></span></td>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small input_field input_date\"><input data-dojo-props='style:\"width:150px\", placeHolder:\"Date\", type:\"text\",name:\"taken\",required:\"true\",disabled:\"true\"' data-dojo-attach-point=\"taken\" data-dojo-type=\"dijit.form.DateTextBox\" ></span></td>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\"><select data-dojo-props='style:\"width:150px\",placeHolder:\"Taken By\", disabled:\"true\",name:\"taken_by\",\"class\":\"prmaxrequired\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Taken By\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"taken_by\"></select></span></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='style:\"width:150px\", disabled:\"true\", placeHolder:\"Client\", name:\"clientid\",autoComplete:true,searchAttr:\"clientname\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"clientid\" ></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t\t<td><span class=\"prmax-padding-left-small\">\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='style:\"width:150px\",placeHolder:\"Issue\", disabled:\"true\", \"class\":\"prmaxrequired\",name:\"issueid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Select\",labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"issueid\"></select>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<input data-dojo-props='placeHolder:\"Subject\", type:\"text\",name:\"description\",style:\"width:450px;margin-top:10px;margin-bottom:2px\"' data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"description\" />\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t<tr><td colspan=\"3\"><span class=\"prmax-padding-left-large\">\r\n\t\t\t\t\t\t\t<textarea placeHolder=\"Outcome\" data-dojo-attach-point=\"outcome\" name=\"outcome\" style=\"width:450px;min-height:70px;margin-top:10px;\"></textarea>\r\n\t\t\t\t\t\t</span></td></tr>\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td><span>\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='placeHolder:\"Call Type\",\"class\":\"prmaxrequired\",name:\"tasktypeid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Select\",labelType:\"html\",style:\"width:100px;float:left;\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"tasktypeid\"></select>\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='placeHolder:\"Status\",\"class\":\"prmaxrequired\",name:\"taskstatusid\",autoComplete:true,searchAttr:\"name\",required:true,invalidMessage:\"Status\",labelType:\"html\",style:\"width:100px;float:left;\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"taskstatusid\"></select><br/>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t<td colspan=\"2\"><span>\r\n\t\t\t\t\t\t\t\t<input data-dojo-props='placeHolder:\"Deadline\",type:\"text\",name:\"due_date\",required:true,style:\"width:120px;float:right\"' data-dojo-attach-point=\"due_date\" data-dojo-type=\"dijit.form.DateTextBox\" >\r\n\t\t\t\t\t\t\t\t<select data-dojo-props='placeHolder:\"Task Owner\",\"class\":\"prmaxrequired\",name:\"assigntoid\",autoComplete:true,searchAttr:\"user_name\",required:true,invalidMessage:\"Follow Up Only\",labelType:\"html\",style:\"width:120px;float:right\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"assigntoid\"></select><br/>\r\n\t\t\t\t\t\t\t</span></td>\r\n\t\t\t\t\t\t</tr>\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<td colspan=\"3\" align=\"right\"><button data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-point=\"updbtn\" data-dojo-props='iconClass:\"fa fa-floppy-o fa-2x\",busyLabel:\"Updating ...\",label:\"Update\"' data-dojo-attach-event=\"onClick:_update_task\"></button></td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t</table>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"source_view\" data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-props=\"iconClass:'fa fa-user',title:'Engagement',style:'height:100%;width:90%;overflow :auto','class':'bordered scrollpanel'\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"source\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"style:'height:100%;width:500px;overflow :auto','class':'bordered scrollpanel'\"></div>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"ch_update\" data-dojo-type=\"prcommon.crm.update\" data-dojo-props=\"show_close:false,style:'height:100%;width:100%;overflow :auto','class':'bordered scrollpanel'\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n",history_view:"/crm/tasks/task_source_view?taskid=${taskid}",constructor:function(){this._load_call_back=dojo.hitch(this,this._load_call);this._upd_call_back=dojo.hitch(this,this._upd_call);this._users=new dojo.data.ItemFileReadStore({url:"/crm/tasks/customer_users"});this._allusers=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._taskstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus"});this._tasktype=new dojo.data.ItemFileWriteStore({url:"/common/lookups_restricted?searchtype=tasktypes"});this._issues=new dojox.data.QueryReadStore({url:"/crm/issues/issues_list",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,urlPreventCache:true});dojo.subscribe("tasktype/add",dojo.hitch(this,this._add_tasktype_event));dojo.subscribe("tasktype/update",dojo.hitch(this,this._update_tasktype_event));dojo.subscribe("/crm/update_person",dojo.hitch(this,this._update_person_event));},postCreate:function(){this.taskstatusid.store=this._taskstatus;this.assigntoid.store=this._users;this.tasktypeid.store=this._tasktype;this.issueid.store=this._issues;this.clientid.set("store",this._clients);this.taken_by.store=this._allusers;this.inherited(arguments);},_load_call:function(_1){if(_1.success=="OK"){this.display_view.selectChild(this.tabcont);this.taskstatusid.set("value",_1.data.taskstatusid);this.assigntoid.set("value",_1.data.assigntoid);this.tasktypeid.set("value",_1.data.tasktypeid);this.due_date.set("value",ttl.utilities.fromObjectDate(_1.data.due_date));this.taken.set("value",ttl.utilities.fromObjectDate(_1.taken_display));this.taken_by.set("value",_1.data.taken_by);this.description.set("value",_1.data.description);this.clientid.set("value",_1.data.clientid);this.issueid.set("value",_1.data.issueid);this._setup_view(_1.data.contacthistoryid);this.outcome.value=_1.data.outcome;if(_1.data.contacthistoryid!=null){this.ch_update.load(_1.data.contacthistoryid);this.source_view.selectChild(this.ch_update);this.tabcont.selectChild(this.source_view);}else{this.source.set("href",dojo.string.substitute(this.history_view,{taskid:_1.data.taskid}));this.source_view.selectChild(this.source);this.tabcont.selectChild(this.details);}var _2=_1.data.contactname;this.contact_task.outletid.set("value",_1.data.outletid);this.contact_task.employeeid.set("value",_1.data.employeeid);if(_1.data.outlet!=null&&_1.data.outlet.outletname!=""){if(_2!=null&&_2!=""){_2+="<br /><br />"+_1.data.outlet.outletname;}else{_2=" Outlet: "+_1.data.outlet.outletname;}}if(_1.data.contact){this.contact_task.set("value",_1.data.contact.contactid);}this.contact_task.set("Displayvalue",_2);this.contact_task.set("Mode","info");}else{alert("Problem Loading Task");}},_setup_view:function(_3){var _4="";if(_3==null){_4="none";}this.source_view.controlButton.domNode.style.display=_4;},_clear:function(){this.display_view.selectChild(this.blank);this.source.set("content","");this.ch_update._clear();this.updbtn.cancel();},clear:function(){this._clear();},resize:function(){this.frame.resize(arguments[0]);},load:function(_5){this.clear();this._taskid=_5;this.taskid.set("value",_5);dojo.xhrPost(ttl.utilities.makeParams({load:this._load_call_back,url:"/crm/tasks/task_get",content:{taskid:_5}}));},_update_task:function(){if(ttl.utilities.formValidator(this.form_taskupdate)==false){alert("Please Enter Details");this.updbtn.cancel();return false;}var _6=this.form_taskupdate.get("value");_6["due_date"]=ttl.utilities.toJsonDate(this.due_date.get("value"));_6["description"]=this.description.get("value");_6["outcome"]=this.outcome.value;dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._upd_call_back),url:"/crm/tasks/task_update",content:_6}));},_upd_call:function(_7){if(_7.success=="OK"){dojo.publish(PRCOMMON.Events.Task_Update,[_7.data]);}else{alert("Problem Updating Task");}this.updbtn.cancel();},_add_tasktype_event:function(_8){this._tasktype.newItem(_8);},_update_tasktype_event:function(_9){this._tasktype_item=_9;this._tasktype.fetchItemByIdentity({identity:_9.tasktypeid,onItem:dojo.hitch(this,this._update_task_item)});},_update_task_item:function(_a){this._tasktype.setValue(_a,"name",this._tasktype_item.tasktypedescription);},_update_person_event:function(_b){if(_b.outletid){this.contact_task.outletid.set("value",_b.outletid);}if(_b.employeeid){this.contact_task.employeeid.set("value",_b.employeeid);}if(_b.outlet&&_b.employee){var _c=_b.contactname;this.contact_task.outletid.set("value",_b.outlet.outletid);this.contact_task.employeeid.set("value",_b.employee.employeeid);if(_b.outlet!=null&&_b.outlet.outletname!=""){if(_c!=null&&_c!=""){_c+="<br /><br />"+_b.outlet.outletname;}else{_c=" Outlet: "+_b.outlet.outletname;}}if(_b.contact){this.contact_task.set("value",_b.contact.contactid);}this.contact_task.set("Displayvalue",_c);this.contact_task.set("Mode","info");}},});}