/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.tasks.viewer"]){dojo._hasResource["prcommon.crm.tasks.viewer"]=true;dojo.provide("prcommon.crm.tasks.viewer");dojo.require("prcommon.crm.tasks.add");dojo.require("prcommon.crm.tasks.update");dojo.require("prcommon.crm.tasks.addtype");dojo.require("prcommon.crm.tasks.updatetype");_add_new_line=function(_1){return _1?_1.replace("====","<br />"):"";};_add_green_check=function(_2){if(_2){var _3=_2.search("====");if(_2.substr(_3+4,_2.length).trim().toLowerCase()=="completed"){return "<div style=\"text-align:center\">"+_2.substr(0,_3)+"<br /><i class=\"fa fa-check-circle-o fa-2x\" style=\"color:#27BD59; aria-hidden=\"true\"></i></div>";}else{return "<div style=\"text-align:center\">"+_2.substr(0,_3)+"<br /><i class=\"fa fa-check-circle-o fa-2x\" style=\"color:#F6F6F6; aria-hidden=\"true\"></i></div>";}}else{return "";}};dojo.declare("prcommon.crm.tasks.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<div data-dojo-attach-point=\"borderControl\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='style:\"width:100%;height:100%\",gutters:false'>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-attach-point=\"controls\" data-dojo-props='region:\"top\",style:\"height:42px;width:100%;overflow:hidden\"'>\r\n\t\t\t<span class=\"std_menu_view\">\r\n\t\t\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-props='style:\"height:99%;width:100%;padding:0px;margin:0px\"'>\r\n\t\t\t\t\t<div data-dojo-attach-event=\"onClick:_new_task\" data-dojo-attach-point=\"newtaskbtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"fa fa-plus fa-3x\",showLabel:false,style:\"padding-right:5px\"'><span>New</span></div>\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.form.DropDownButton\" data-dojo-attach-point=\"filterbtn\" data-dojo-props='iconClass:\"fa fa-filter fa-3x\",label:\"Filter\",showLabel:false'>\r\n\t\t\t\t\t\t<span>Filter By</span>\r\n\t\t\t\t\t\t<div data-dojo-type=\"dijit.TooltipDialog\" data-dojo-props='title:\"Filter By\"' data-dojo-attach-event=\"execute:_filter\">\r\n\t\t\t\t\t\t\t<table>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Over due</label></td><td><input data-dojo-type=\"dijit.form.CheckBox\" data-dojo-attach-point=\"overdue\" data-dojo-props='\"class\":\"prmaxinput\",type:\"checkbox\",name:\"overdue\",checked:false,value:\"1\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Subject</label></td><td><input data-dojo-type=\"dijit.form.TextBox\" data-dojo-attach-point=\"subject\" data-dojo-props='\"class\":\"prmaxinput\",type:\"text\",name:\"subject\"' ></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Status</label></td><td><select data-dojo-props='\"class\":\"prmaxinput\",name:\"taskstatusid\",autoComplete:true,labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"taskstatusid\" ></select></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td><label>Owner</label></td><td><select data-dojo-props='\"class\":\"prmaxinput\",name:\"ownerid\",autoComplete:true,labelType:\"html\",required:false' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"ownerid\" ></select></td></tr>\r\n\t\t\t\t\t\t\t\t<tr><td>&nbsp</td></tr>\r\n\t\t\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t\t\t<td align=\"left\"><button data-dojo-attach-event=\"onClick: _clear_filter\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"button\"' >Clear</button></td>\r\n\t\t\t\t\t\t\t\t\t<td align=\"right\"><button data-dojo-type=\"dijit.form.Button\" data-dojo-props='type:\"submit\",name:\"submit\"'>Submit</button></td>\r\n\t\t\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div data-dojo-attach-event=\"onClick:_edit_tasktype\" data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point=\"tasktypebtn\"data-dojo-props='iconClass:\"fa fa-pencil-square-o fa-3x\",showLabel:false,style:\"padding-right:5px\"'><span>Edit Task Type</span></div>\r\n\t\t\t\t\t<div data-dojo-attach-event=\"onClick:_edit_tasks\" data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point='backbtn'data-dojo-props='iconClass:\"fa fa-arrow-left fa-3x\",showLabel:false,style:\"padding-right:5px\",\"class\":\"prmaxhidden\"'><span>Back</span></div>\r\n\t\t\t\t\t<div data-dojo-attach-event=\"onClick:_add_tasktype\" data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point='newstasktypebtn'data-dojo-props='iconClass:\"fa fa-plus fa-3x\",showLabel:false,style:\"padding-right:5px\",\"class\":\"prmaxhidden\"'><span>Add Task Type</span></div>\r\n\t\t\t\t</div>\r\n\t\t\t</span>\r\n\t\t</div>\r\n\r\n\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"controls2\" data-dojo-props=\"region:'center',preload:false,style:'height:100%;width:100%'\">\r\n\t\t\t<div data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-attach-point=\"tasks_view\" data-dojo-props='style:\"width:100%;height:100%\",gutters:false'>\r\n\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" class=\"spacygriddisplay\" data-dojo-props='style:\"width:45%;height:100%\",\"class\":\"scrollpanel\",region:\"center\",splitter:true'>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"viewer_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{},rowsPerPage:30,style:\"width:50%;height:100%\",region:\"center\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:55%;height:100%\",\"class\":\"scrollpanel\",region:\"right\",splitter:true'>\r\n\t\t\t\t\t<div data-dojo-attach-point=\"update_task_ctrl\" data-dojo-type=\"prcommon.crm.tasks.update\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div data-dojo-attach-point=\"tasktype_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{},rowsPerPage:30,style:\"width:30%;height:100%\"'></div>\r\n\t\t</div>\r\n\r\n\t</div>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"<p><i class=\\\"fa fa-tasks\\\"></i>&nbsp;New Task</p>\"' data-dojo-attach-point=\"newtaskdlg\">\r\n\t\t<div data-dojo-attach-point=\"newtaskctrl\" data-dojo-type=\"prcommon.crm.tasks.add\" ></div>\r\n\t</div>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"Update Type\"' data-dojo-attach-point=\"updatetasktypedlg\">\r\n\t\t<div data-dojo-attach-point=\"updatetasktypectrl\" data-dojo-type=\"prcommon.crm.tasks.updatetype\" ></div>\r\n\t</div>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"New Type\"' data-dojo-attach-point=\"newtasktypedlg\">\r\n\t\t<div data-dojo-attach-point=\"newtasktypectrl\" data-dojo-type=\"prcommon.crm.tasks.addtype\" ></div>\r\n\t</div>\r\n</div>\r\n\r\n",constructor:function(){this.filter_db=new prcommon.data.QueryWriteStore({url:"/crm/tasks/tasks",nocallback:true,onError:ttl.utilities.globalerrorchecker});this._tasktype=new prcommon.data.QueryWriteStore({url:"/crm/tasks/list_tasktypes",nocallback:true,onError:ttl.utilities.globalerrorchecker});this._tasktypestatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=tasktypestatus"});this._users=new dojo.data.ItemFileReadStore({url:"/user/user_list"});this._taskstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus&nofilter=1"});dojo.subscribe(PRCOMMON.Events.Task_Add,dojo.hitch(this,this._add_task_event));dojo.subscribe(PRCOMMON.Events.Task_Update,dojo.hitch(this,this._update_task_event));dojo.subscribe("tasktype/update",dojo.hitch(this,this._update_tasktype_event));dojo.subscribe("tasktype/add",dojo.hitch(this,this._add_tasktype_event));this._get_model_item_call=dojo.hitch(this,this._get_model_item);},_view:{noscroll:false,cells:[[{name:"Contact",width:"200px",field:"contactdetails_display",formatter:_add_new_line},{name:"Details",width:"300px",field:"details_display",formatter:_add_new_line},{name:"Status",width:"100px",field:"status_display",formatter:_add_green_check}]]},_view_tasktypes:{noscroll:false,cells:[[{name:"Description",width:"400px",field:"tasktypedescription"},{name:"Status",width:"100px",field:"tasktypestatusdescription"}]]},postCreate:function(){this.viewer_grid.set("structure",this._view);this.viewer_grid._setStore(this.filter_db);this.viewer_grid.setQuery({taskstatusid:1,ownerid:PRMAX.utils.settings.uid});this.viewer_grid.onRowClick=dojo.hitch(this,this.on_select_row);this.viewer_grid.onStyleRow=dojo.hitch(this,this.on_style_row);this.tasktype_grid.set("structure",this._view_tasktypes);this.tasktype_grid._setStore(this._tasktype);this.tasktype_grid.onRowClick=dojo.hitch(this,this.on_tasktype_select_row);this.taskstatusid.store=this._taskstatus;this.taskstatusid.set("value",1);this.ownerid.store=this._users;this.ownerid.set("value",PRMAX.utils.settings.uid);this.inherited(arguments);},on_style_row:function(_4){var _5=this.viewer_grid.getItem(_4.index);if(_5&&_5.i.isoverdue==true){_4.customClasses+=" prmaxOverDueRow";return;}if(_5&&_5.i.taskstatusid==3){_4.customClasses+=" prmaxCompletedRow";return;}ttl.GridHelpers.onStyleRow(_4);},on_select_row:function(e){var _6=this.viewer_grid.getItem(e.rowIndex);this.update_task_ctrl.load(_6.i.taskid);this.viewer_grid.selection.clickSelectEvent(e);},on_tasktype_select_row:function(e){var _7=this.tasktype_grid.getItem(e.rowIndex);this.updatetasktypectrl.load(this.updatetasktypedlg,_7.i.tasktypeid);this.updatetasktypedlg.show();this.tasktype_grid.selection.clickSelectEvent(e);},_filter:function(){var _8={};if(arguments[0].overdue=="1"){_8["overdue"]="on";}if(arguments[0].taskstatusid!="-1"){_8["taskstatusid"]=arguments[0].taskstatusid;}if(arguments[0].ownerid!="-1"){_8["ownerid"]=arguments[0].ownerid;}if(arguments[0].subject!=""){_8["subject"]=arguments[0].subject;}this.viewer_grid.setQuery(ttl.utilities.getPreventCache(_8));this.update_task_ctrl.clear();},_clear_filter:function(){this.overdue.set("checked",false);this.taskstatusid.set("value",1);this.subject.set("value","");this.ownerid.set("value",PRMAX.utils.settings.uid);},load:function(){this.refresh();},refresh:function(){this._filter();},resize:function(){this.borderControl.resize(arguments[0]);this.inherited(arguments);},_new_task:function(){this.newtaskctrl.load(this.newtaskdlg);this.newtaskdlg.show();},_add_task_event:function(_9){this.filter_db.newItem(_9);this.viewer_grid.setQuery({taskstatusid:1,ownerid:PRMAX.utils.settings.uid});},_update_task_event:function(_a){this.tmp_row=null;var _b={identity:_a.taskid,onItem:this._get_model_item_call};this.filter_db.fetchItemByIdentity(_b);if(this.tmp_row){this.filter_db.setValue(this.tmp_row,"user_name",_a.user_name,true);this.filter_db.setValue(this.tmp_row,"due_date_display",_a.due_date_display,true);this.filter_db.setValue(this.tmp_row,"taskstatusdescription",_a.taskstatusdescription,true);this.filter_db.setValue(this.tmp_row,"description",_a.description,true);}},_update_tasktype_event:function(_c){this.tmp_row=null;var _d={identity:_c.tasktypeid,onItem:this._get_model_item_call};var _e={identity:_c.tasktypestatusid};this._tasktype.fetchItemByIdentity(_d);if(this.tmp_row){this._tasktype.setValue(this.tmp_row,"tasktypedescription",_c.tasktypedescription,true);this._tasktype.setValue(this.tmp_row,"tasktypestatusid",_c.tasktypestatusid,true);this.tasktype_grid.setQuery({});}},_get_model_item:function(){if(arguments[0].i.i!=null){this.tmp_row=arguments[0].i;}else{this.tmp_row=arguments[0];}},_edit_tasks:function(){this.controls2.selectChild(this.tasks_view);dojo.addClass(this.backbtn.domNode,"prmaxhidden");dojo.addClass(this.newstasktypebtn.domNode,"prmaxhidden");dojo.removeClass(this.newtaskbtn.domNode,"prmaxhidden");dojo.removeClass(this.filterbtn.domNode,"prmaxhidden");dojo.removeClass(this.tasktypebtn.domNode,"prmaxhidden");},_edit_tasktype:function(){this.controls2.selectChild(this.tasktype_grid);dojo.addClass(this.newtaskbtn.domNode,"prmaxhidden");dojo.addClass(this.filterbtn.domNode,"prmaxhidden");dojo.addClass(this.tasktypebtn.domNode,"prmaxhidden");dojo.removeClass(this.backbtn.domNode,"prmaxhidden");dojo.removeClass(this.newstasktypebtn.domNode,"prmaxhidden");},_add_tasktype_event:function(_f){_f.id=_f.tasktypeid;_f.name=_f.tasktypedescription;this._tasktype.newItem(_f);this.tasktype_grid.setQuery({});},_add_tasktype:function(){this.newtasktypectrl.load(this.newtasktypedlg);this.newtasktypedlg.show();},refresh_view:function(){}});}