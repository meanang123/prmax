/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.tasks.add"]){dojo._hasResource["prcommon.crm.tasks.add"]=true;dojo.provide("prcommon.crm.tasks.add");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("ttl.BaseWidget");dojo.require("prcommon.crm.tasks.addtype");dojo.declare("prcommon.crm.tasks.add",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<form data-dojo-attach-point=\"form\"  data-dojo-props='onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t<table width=\"99%\" class=\"prmaxtable\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"padding-top:5px\">\r\n\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\" width=\"120px\" >Subject</td><td><input data-dojo-props='type:\"text\",required:true,name:\"description\",style:\"width:30em\"' data-dojo-type=\"dijit.form.ValidationTextBox\" data-dojo-attach-point=\"description\" ></td></tr>\r\n\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Type</td>\r\n\t\t\t\t<td><select data-dojo-props='\"class\":\"prmaxinputselect\", name:\"tasktypeid\",autoComplete:true,labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"tasktypeid\" ></select>\r\n\t\t\t\t\t<button data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point=\"addtypebtn\" data-dojo-attach-event=\"onClick:_addtype\" data-dojo-props='label:\"Add\"'>\r\n\t\t\t\t<td>\r\n\t\t\t</tr>\r\n\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Status</td><td><select data-dojo-props='\"class\":\"prmaxinputselect\",name:\"taskstatusid\",autoComplete:true,labelType:\"html\"' data-dojo-type=\"dijit.form.FilteringSelect\" data-dojo-attach-point=\"taskstatusid\" ></select></td></tr>\r\n\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Due Date</td><td><input data-dojo-props='\"class\":\"prmaxdate\",style:\"width:8em\",type:\"text\",required:false,name:\"due_date\"' data-dojo-attach-point=\"due_date\" data-dojo-type=\"dijit.form.DateTextBox\"></td></tr>\r\n\t\t\t<tr><td align=\"right\" valign=\"top\" class=\"prmaxrowtag\">Owner</td><td><select data-dojo-props='\"class\":\"prmaxrequired prmaxinputselect\",required:true,name:\"assigntoid\",autoComplete:true,style:\"width:15em\",labelType:\"html\",searchAttr:\"user_name\",labelAttr:\"user_name\"' data-dojo-attach-point=\"assigntoid\" data-dojo-type=\"dijit.form.FilteringSelect\"></select></td></tr>\r\n\t\t\t<tr><td colspan=\"2\"><br/></td></tr>\r\n\t\t\t<tr>\r\n\t\t\t\t<td><button data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point=\"clsbtn\" data-dojo-attach-event=\"onClick:_close\" data-dojo-props='label:\"Close\"'></button></td>\r\n\t\t\t\t<td align=\"right\"><button data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-point=\"addbtn\" data-dojo-props='busyLabel:\"Adding ...\",label:\"Add\"' data-dojo-attach-event=\"onClick:_add\"></button></td>\r\n\t\t\t</tr>\r\n\t\t</table>\r\n\t</form>\r\n\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"New Type\"' data-dojo-attach-point=\"newtasktypedlg\">\r\n\t\t<div data-dojo-attach-point=\"newtasktypectrl\" data-dojo-type=\"prcommon.crm.tasks.addtype\" ></div>\r\n\t</div>\r\n\r\n</div>\r\n\r\n",constructor:function(){this._users=new dojo.data.ItemFileReadStore({url:"/crm/tasks/customer_users"});this._taskstatus=new dojo.data.ItemFileReadStore({url:"/common/lookups?searchtype=taskstatus"});this._tasktype=new prcommon.data.QueryWriteStore({url:"/common/lookups_restricted?searchtype=tasktype&show_active=1"});dojo.subscribe("tasktype/add",dojo.hitch(this,this._add_tasktype_event));this._add_call_back=dojo.hitch(this,this._add_call);this._dialog=null;},postCreate:function(){this.inherited(arguments);this.taskstatusid.store=this._taskstatus;this.assigntoid.store=this._users;this.tasktypeid.store=this._tasktype;this.taskstatusid.set("value","1");this.assigntoid.set("value",PRMAX.utils.settings.uid);this.tasktypeid.set("value",5);this.due_date.set("value",null);},load:function(_1){this._dialog=_1;this._clear();},_close:function(){if(this._dialog!=null){this._dialog.hide();}},_add_call:function(_2){if(_2.success=="OK"){dojo.publish(PRCOMMON.Events.Task_Add,[_2.data]);this._close();this._clear();}else{alert("Problem Adding Task");}this.addbtn.cancel();},_clear:function(){this.addbtn.cancel();this.taskstatusid.set("value","1");this.assigntoid.set("value",PRMAX.utils.settings.uid);this.tasktypeid.set("value",5);this.due_date.set("value",null);this.description.set("value","");},_add:function(){if(ttl.utilities.formValidator(this.form)==false){alert("Please Enter Details");this.addbtn.cancel();return false;}var _3=this.form.get("value");_3["due_date"]=ttl.utilities.toJsonDate(this.due_date.get("value"));dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._add_call_back),url:"/crm/tasks/task_add",content:_3}));},_addtype:function(){this.newtasktypectrl.load(this.newtasktypedlg);this.newtasktypedlg.show();},_add_tasktype_event:function(_4){_4.id=_4.tasktypeid;_4.name=_4.tasktypedescription;this._tasktype.newItem(_4);this.tasktypeid.set("value",_4.tasktypeid);}});}