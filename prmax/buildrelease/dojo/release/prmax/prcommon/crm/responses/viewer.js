/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.responses.viewer"]){dojo._hasResource["prcommon.crm.responses.viewer"]=true;dojo.provide("prcommon.crm.responses.viewer");dojo.require("ttl.GridHelpers");dojo.require("ttl.BaseWidget");dojo.require("dijit.form.Form");dojo.require("dijit.form.TextBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dojox.form.BusyButton");dojo.require("dijit.form.Button");dojo.require("prcommon.data.QueryWriteStore");dojo.require("prcommon.documents.upload");dojo.require("prcommon.crm.responses.add");dojo.require("prcommon.crm.responses.update");dojo.declare("prcommon.crm.responses.viewer",[ttl.BaseWidget],{widgetsInTemplate:true,basic_details_page:"/clippings/display_page?clippingid=${clippingid}",templateString:"<div>\r\n\t<div data-dojo-attach-point=\"borderControl\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props='style:\"width:100%;height:100%\",gutters:false' >\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='region:\"top\", style:\"height:42px;width:100%;overflow:hidden\", \"class\":\"std_menu_view\"'>\r\n\t\t\t<div style=\"height:38px;width:100%;overflow:hidden\" class=\"std_menu_view\">\r\n\t\t\t\t<div data-dojo-type=\"dijit.Toolbar\" data-dojo-props='\"class\":\"dijitToolbarTop\", style:\"float:left:height:94%;width:400px\"' >\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.form.Button\" data-dojo-attach-event=\"onClick:_AddStatement\" data-dojo-attach-point=\"addbutton\" data-dojo-props='label:\"New Statement\", iconClass:\"fa fa-plus fa-3x\",showLabel:true'></div>\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.form.Button\" data-dojo-attach-event=\"onClick:_deleteStatement\" data-dojo-attach-point=\"deletebutton\"  data-dojo-props='label:\"Delete\", iconClass:\"fa fa-trash fa-3x\",showLabel:true'></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:50%;height:100%\", region:\"center\", splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ }, rowsPerPage:30' ></div>\r\n\t\t</div>\r\n\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props='style:\"width:50%;height:100%\", region:\"right\", splitter:true'>\r\n\t\t\t<div data-dojo-attach-point=\"tabcont\" data-dojo-type=\"dijit.layout.TabContainer\" data-dojo-props=\"region:'center',splitter:true,'class':'bordered'\">\r\n\t\t\t\t<div data-dojo-attach-point=\"details\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Edit',style:'height:100%;width:500px;overflow :auto','class':'bordered scrollpane',selected:'selected'\">\r\n\t\t\t\t\t<span class=\"common_prmax_layout\">\r\n\t\t\t\r\n\r\n\t\t\t\t\t\t<div style=\"padding:2px\" data-dojo-attach-point =\"display_pane\" class=\"prmaxhidden\">\r\n\t\t\t\r\n\t\t\t\t\t\t\t<form data-dojo-attach-point=\"update_form\" data-dojo-props='\"class\":\"prmaxdefault\", onsubmit:\"return false\"' data-dojo-type=\"dijit.form.Form\">\r\n\t\t\t\t\t\t\t\t<input data-dojo-attach-point=\"statementid\" data-dojo-props='name:\"statementid\", type:\"hidden\", value:\"-1\"' data-dojo-type=\"dijit.form.TextBox\" >\r\n\t\t\t\t\t\t\t\t<table class=\"prmaxtable\" width=\"700px\" >\r\n\t\t\t\t\t\t\t\t\t<tr><td colspan=\"2\" align=\"center\" class=\"prmaxrowdisplaylarge\" > Statement Details</td></tr>\r\n\t\t\t\t\t\t\t\t\t<tr><td class=\"prmaxrowtag\" >Description</td><td class=\"prmaxrowdisplay\" width=\"86%\"><input data-dojo-props='invalidMessage:\"Description field must be filled in\", style:\"width:98%\", \"class\":\"prmaxrequired\", name:\"statementdescription\", type:\"text\", maxlength:80, trim:true, required:true' data-dojo-type=\"dijit.form.ValidationTextBox\" data-dojo-attach-point=\"statementdescription\"/></td></tr>\r\n\t\t\t\t\t\t\t\t\t<tr><td class=\"prmaxrowtag\" >Client</td><td class=\"prmaxrowdisplay\" width=\"86%\" ><select data-dojo-attach-point=\"clientid\" data-dojo-type =\"dijit.form.FilteringSelect\" data-dojo-props='name:\"clientid\", searchAttr:\"clientname\", labelType:\"html\", style:\"width:98%\" '/></td></tr>\r\n\t\t\t\t\t\t\t\t\t<tr><td class=\"prmaxrowtag\" >Issue</td><td class=\"prmaxrowdisplay\" width=\"86%\"><select data-dojo-attach-point=\"issueid\" data-dojo-type =\"dijit.form.FilteringSelect\" data-dojo-props='name:\"issueid\", searchAttr:\"name\", labelType:\"html\", style:\"width:98%\" '/></td></tr>\r\n\t\t\t\t\t\t\t\t\t<tr><td class=\"prmaxrowtag\" >Output</td><td class=\"prmaxrowdisplay\" width=\"86%\"><div data-dojo-type=\"dijit.Editor\" data-dojo-attach-point=\"output\" data-dojo-props='name:\"output\",style:\"border:1px solid gray\"'  extraPlugins=\"[{name:'dijit._editor.plugins.FontChoice', command:'fontName', generic:false},'fontSize','createLink','viewsource','preview','mergefields']\"></div></td>\r\n\t\t\t\t\t\t\t\t\t\t<td valign=\"top\"><button data-dojo-attach-event=\"onClick:_LoadWord\" data-dojo-attach-point=\"uploaddocbtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"fa fa-upload\",type:\"button\",\"class\":\"prmaxdefault\", title:\"Upload document\", sourcename:\"response\"'></button><br/></td>\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t\t\t\t<tr><td colspan = \"2\" align=\"right\"><button data-dojo-props='\"class\":\"prmaxbutton\", type:\"button\", label:\"Update\", busyLabel:\"Please Wait Updating\" ' data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-event=\"onClick:_Update\" data-dojo-attach-point=\"update_form_btn\"></button></td></tr>\r\n\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</form>\r\n\t\t\t\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t\r\n\t\t\t\t<div data-dojo-attach-point=\"engagements\"  data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"title:'Engagements',style:'height:100%;width:500px;overflow :auto','class':'bordered scrollpane'\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"engagements_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ }, rowsPerPage:30' ></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-dojo-attach-point=\"clippings\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props=\"title:'Clips',style:'height:100%;width:500px;overflow:auto','class':'bordered scrollpane'\">\r\n\t\t\t\t\t<div data-dojo-attach-point=\"clippings_grid\" data-dojo-type=\"dojox.grid.DataGrid\" data-dojo-props='query:{ }, rowsPerPage:30, region:\"center\"' ></div>\r\n\t\t\t\t\t<div data-dojo-type=\"dijit.layout.StackContainer\" data-dojo-attach-point=\"clippings_view\" data-dojo-props='region:\"bottom\",style:\"width:100%;height:50%\",splitter:true' >\r\n\t\t\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-attach-point=\"blank_view\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t\t\t\t\t<div data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-attach-point=\"clipping_view\" data-dojo-props='style:\"width:100%;height:100%\"'></div>\r\n\t\t\t\t\t</div>\t\t\t\t\t\t\t\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div>\r\n\t\t<div data-dojo-attach-point=\"add_statement_dlg\" data-dojo-type=\"dijit.Dialog\" data-dojo-props='title:\"New Statement\", style:\"width:600px;height:500px\"'>\r\n\t\t<div data-dojo-attach-point=\"addstatementctrl\" data-dojo-type=\"prcommon.crm.responses.add\" style=\"width:600px;height:500px\"></div>\r\n\t</div>\t\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-attach-point=\"upload_doc_dlg\" data-dojo-props='title:\"Upload document\",style:\"width:450px;height:260px\"'>\r\n\t\t<div data-dojo-type=\"prcommon.documents.upload\" data-dojo-attach-point=\"upload_doc_ctrl\" data-dojo-props='sourcename:\"response\"'></div><br/>\r\n\t\t<div data-dojo-attach-event=\"onClick:_close_dlg\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"Close\",style:\"float:left;padding-right:20px\"'></div>\r\n\t</div>\t\t\r\n</div>\r\n\r\n\r\n",constructor:function(){this.model=new prcommon.data.QueryWriteStore({url:"/statement/statement_grid",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true});this.engagement_model=new prcommon.data.QueryWriteStore({url:"/statement/statement_engagements_grid",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true});this.clipping_model=new prcommon.data.QueryWriteStore({url:"/statement/statement_clippings_grid",onError:ttl.utilities.globalerrorchecker,clearOnClose:true,nocallback:true,urlPreventCache:true});this._clients=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._issues=new dojox.data.JsonRestStore({target:"/crm/issues/issues_list_rest",idAttribute:"id"});this._UpdateStatementCallBack=dojo.hitch(this,this._UpdateStatementCall);this._DeleteStatementCallBack=dojo.hitch(this,this._DeleteStatementCall);this._load_call_back=dojo.hitch(this,this._load_call);dojo.subscribe(PRCOMMON.Events.Word_Html_Data,dojo.hitch(this,this._word_html_data_event));dojo.subscribe("/statement/add",dojo.hitch(this,this._AddStatementEvent));},postCreate:function(){this.icustomerid=PRMAX.utils.settings.cid;this.upload_doc_ctrl.Load(this.upload_doc_dlg);this.grid.set("structure",this.view);this.grid._setStore(this.model);this.grid["onCellClick"]=dojo.hitch(this,this._onCellClick);this.engagements_grid.set("structure",this.engagement_view);this.engagements_grid._setStore(this.engagement_model);this.clippings_grid.set("structure",this.clip_view);this.clippings_grid._setStore(this.clipping_model);this.clippings_grid["onRowClick"]=dojo.hitch(this,this._on_row_click);this.clientid.store=this._clients;this.clientid.set("value",-1);this.issueid.store=this._issues;this.issueid.set("value",-1);this.tabcont.selectChild(this.details);this.engagements.set("title",PRMAX.utils.settings.crm_engagement_plural);},_OnStyleRow:function(_1){ttl.GridHelpers.onStyleRow(_1);this.tabcont.selectChild(this.details);},view:{cells:[[{name:"Description",width:"200px",field:"statementdescription"},{name:"Client",width:"200px",field:"clientname"},{name:"Issue",width:"auto",field:"issuename"},{name:"Created date",width:"auto",field:"created"}]]},engagement_view:{cells:[[{name:"Outlet",width:"200px",field:"outletname"},{name:"Contact",width:"200px",field:"contactname"},{name:"Date",width:"auto",field:"taken"}]]},clip_view:{cells:[[{name:"Outlet",width:"200px",field:"outletname"},{name:"Date",width:"auto",field:"sourcedate"}]]},_onCellClick:function(e){this._row=this.grid.getItem(e.rowIndex);this.grid.selection.clickSelectEvent(e);this.tabcont.selectChild(this.details);this._ShowDetails();},_on_row_click:function(_2){var _3=this.clippings_grid.getItem(_2.rowIndex);if(_3){this._row=_3;dojo.xhrPost(ttl.utilities.makeParams({load:this._load_call_back,url:"/clippings/get_for_edit",content:{clippingid:_3.i.clippingid}}));}},_load_call:function(_4){this.clipping_view.set("href",dojo.string.substitute(this.basic_details_page,{clippingid:_4.data.clippingid}));this.clippings_view.selectChild(this.clipping_view);},_ShowDetails:function(){dojo.removeClass(this.display_pane,"prmaxhidden");this.statementid.set("value",this._row.i.statementid);this.statementdescription.set("value",this._row.i.statementdescription);this.clientid.set("value",this._row.i.clientid);this.issueid.set("value",this._row.i.issueid);this.output.set("value",this._row.i.output);this.engagements_grid.setQuery({statementid:this._row.i.statementid});this.clippings_grid.setQuery({statementid:this._row.i.statementid});this.clippings_view.selectChild(this.blank_view);},_AddStatement:function(){this.addstatementctrl.Load(this.add_statement_dlg);this.add_statement_dlg.show();},_AddStatementEvent:function(_5){this.model.newItem(_5);},_Update:function(){if(ttl.utilities.formValidator(this.update_form)==false){alert("Not all required field filled in");this.update_form_btn.cancel();return;}if(confirm("Update?")){var _6=this.update_form.get("value");dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._UpdateStatementCallBack),url:"/statement/statement_update",content:_6}));}},_UpdateStatementCall:function(_7){if(_7.success=="OK"){alert("Statement Updated");this.update_form_btn.cancel();this.model.setValue(this._row,"statementdescription",_7.data.statementdescription,true);this.model.setValue(this._row,"clientid",_7.data.clientid,true);this.model.setValue(this._row,"clientname",_7.data.clientname,true);this.model.setValue(this._row,"issueid",_7.data.issueid,true);this.model.setValue(this._row,"issuename",_7.data.issuename,true);this.model.setValue(this._row,"output",_7.data.output,true);}else{if(_7.success=="DU"){alert("Statement Already Exists");this.update_form_btn.cancel();}else{alert("Problem updating Statement");this.update_form_btn.cancel();}}},_deleteStatement:function(){if(confirm("Delete Selected Statement?")){var _8={};_8["statementid"]=this._row.i.statementid;dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._DeleteStatementCallBack),url:"/statement/statement_delete",content:_8}));}},_DeleteStatementCall:function(_9){if(_9.success=="OK"){alert("Statement Deleted");this.grid.setQuery(ttl.utilities.getPreventCache({}));}else{alert("Problem Deleting Selected Statement");}},_LoadWord:function(){this.upload_doc_dlg.show();},_close_dlg:function(){this.upload_doc_ctrl.Clear();this.upload_doc_dlg.hide();},_upload_doc:function(){this.upload_doc_dlg.show();},_word_html_data_event:function(_a){if(_a.sourcename=="response"){this.output.set("value",_a.html);}},});}