/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["prcommon.crm.responses.update"]){dojo._hasResource["prcommon.crm.responses.update"]=true;dojo.provide("prcommon.crm.responses.update");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Button");dojo.require("prcommon.documents.upload");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("prmax.projects.projectselect");dojo.declare("prcommon.crm.responses.update",[ttl.BaseWidget],{widgetsInTemplate:true,templateString:"<div>\r\n\t<form data-dojo-attach-point=\"update_statement_form\" data-dojo-type=\"dijit.form.Form\" data-dojo-props='\"onSubmit\":\"return false\", name:\"update_statement_form\", style:\"margin:5px\"'>\r\n\t\t<input data-dojo-attach-point=\"statementid\" data-dojo-props='name:\"statementid\", type:\"hidden\", value:\"-1\"' data-dojo-type=\"dijit.form.TextBox\" >\r\n\t\t<table class=\"prmaxtable\" width=\"700px\" >\r\n\t\t\t<tr><td colspan=\"2\" align=\"center\" class=\"prmaxrowdisplaylarge\" > Statement Details</td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" >Description</td><td class=\"prmaxrowdisplay\" width=\"86%\"><input data-dojo-props='invalidMessage:\"Description field must be filled in\", style:\"width:98%\", \"class\":\"prmaxrequired\", name:\"statementdescription\", type:\"text\", maxlength:80, trim:true, required:true' data-dojo-type=\"dijit.form.ValidationTextBox\" data-dojo-attach-point=\"statementdescription\"/></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" >Client</td><td class=\"prmaxrowdisplay\" width=\"86%\" ><select data-dojo-attach-point=\"clientid\" data-dojo-type =\"dijit.form.FilteringSelect\" data-dojo-props='name:\"clientid\", searchAttr:\"clientname\", labelType:\"html\", style:\"width:98%\" '/></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" >Issue</td><td class=\"prmaxrowdisplay\" width=\"86%\"><select data-dojo-attach-point=\"issueid\" data-dojo-type =\"dijit.form.FilteringSelect\" data-dojo-props='name:\"issueid\", searchAttr:\"name\", labelType:\"html\", style:\"width:98%\" '/></td></tr>\r\n\t\t\t<tr><td class=\"prmaxrowtag\" >Output</td><td class=\"prmaxrowdisplay\" width=\"86%\"><div data-dojo-type=\"dijit.Editor\" data-dojo-attach-point=\"output\" data-dojo-props='name:\"output\",style:\"border:1px solid gray\"'  extraPlugins=\"[{name:'dijit._editor.plugins.FontChoice', command:'fontName', generic:false},'fontSize','createLink','viewsource','preview','mergefields']\"></div></td>\r\n\t\t\t\t<td valign=\"top\"><button data-dojo-attach-event=\"onClick:_LoadWord\" data-dojo-attach-point=\"uploaddocbtn\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='iconClass:\"fa fa-upload\",type:\"button\",\"class\":\"prmaxdefault\", title:\"Upload document\",sourcename:\"response_update\"'></button><br/></td>\t\t\t\t\t\t\r\n\t\t\t</tr>\r\n\t\t\t<tr><td colspan = \"2\" align=\"right\"><button data-dojo-props='\"class\":\"prmaxbutton\", type:\"button\", label:\"Update\", busyLabel:\"Please Wait Updating\" ' data-dojo-type=\"dojox.form.BusyButton\" data-dojo-attach-event=\"onClick:_Update\" data-dojo-attach-point=\"update_form_btn\"></button></td></tr>\r\n\t\t</table>\r\n\t</form>\r\n\t<div data-dojo-type=\"dijit.Dialog\" data-dojo-attach-point=\"upload_doc_dlg\" data-dojo-props='title:\"Upload document\",style:\"width:450px;height:260px\"'>\r\n\t\t<div data-dojo-type=\"prcommon.documents.upload\" data-dojo-attach-point=\"upload_doc_ctrl\" data-dojo-props='sourcename:\"response_update\"'></div><br/>\r\n\t\t<div data-dojo-attach-event=\"onClick:_close_dlg\" data-dojo-type=\"dijit.form.Button\" data-dojo-props='label:\"Close\",style:\"float:left;padding-right:20px\"'></div>\r\n\t</div>\t\r\n</div>\r\n",constructor:function(){this._AddedCallback=dojo.hitch(this,this._Added);this._LoadCallback=dojo.hitch(this,this._LoadCall);this._UpdateStatementCallBack=dojo.hitch(this,this._UpdateStatementCall);this._client_data=new dojox.data.JsonRestStore({target:"/clients/rest_combo",idAttribute:"id"});this._issues_data=new dojox.data.JsonRestStore({target:"/crm/issues/issues_list_rest",idAttribute:"id"});dojo.subscribe(PRCOMMON.Events.Word_Html_Data,dojo.hitch(this,this._word_html_data_event));this.inherited(arguments);},postCreate:function(){this.icustomerid=PRMAX.utils.settings.cid;this.upload_doc_ctrl.Load(this.upload_doc_dlg);this.clientid.store=this._client_data;this.clientid.set("value",-1);this.issueid.store=this._issues_data;this.issueid.set("value",-1);this.inherited(arguments);},Load:function(_1,_2){this._dialog=_1;this._statementid=_2;this.statementid.set("value",_2);var _3={};_3["statementid"]=_2;dojo.xhrPost(ttl.utilities.makeParams({load:this._LoadCallback,url:"/statement/statement_get",content:_3}));},_LoadCall:function(_4){if(_4.success=="OK"){this.statementid.set("value",_4.data.statementid);this.statementdescription.set("value",_4.data.statementdescription);this.clientid.set("value",_4.data.clientid);this.issueid.set("value",_4.data.issueid);this.output.set("value",_4.data.output);}else{alert("Problem Loading Statement");}},_Update:function(){if(ttl.utilities.formValidator(this.update_statement_form)==false){alert("Not all required field filled in");this.update_form_btn.cancel();return;}if(confirm("Update?")){var _5=this.update_statement_form.get("value");dojo.xhrPost(ttl.utilities.makeParams({load:dojo.hitch(this,this._UpdateStatementCallBack),url:"/statement/statement_update",content:_5}));}},_UpdateStatementCall:function(_6){if(_6.success=="OK"){alert("Statement Updated");this.update_form_btn.cancel();}else{if(_6.success=="DU"){alert("Statement Already Exists");this.update_form_btn.cancel();}else{alert("Problem updating Statement");this.update_form_btn.cancel();}}},_LoadWord:function(){this.upload_doc_dlg.show();},_close_dlg:function(){this.upload_doc_ctrl.Clear();this.upload_doc_dlg.hide();},_upload_doc:function(){this.upload_doc_dlg.show();},_word_html_data_event:function(_7){if(_7.sourcename=="response_update"){this.output.set("value",_7.html);}},_Close:function(){this.upload_doc_ctrl.Clear();this.upload_doc_dlg.hide();this._dialog.hide();},});}